<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tistory용 공포 쯔꾸르 (확장 관리자판, Firebase 통합)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
  :root{
    --bg:#000;
    --panel:rgba(0,0,0,0.85);
    --accent:#c0392b;
    --border-dark:#222;
    --border-light:#444;
    --text-color:#eee;
    --input-bg:#1a1a1a;
  }
  body{
    margin:0;background:var(--bg);color:var(--text-color);font-family:'Noto Sans KR',sans-serif;
    /* 맵 중앙 배치 및 전체 화면 스크롤 허용 (Admin Panel 때문에) */
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
    height:100vh;
    overflow-y: auto; /* 관리자 패널 때문에 스크롤 허용 */
  }
  
  /* --- 메인 콘텐츠 레이아웃 (맵, 로그, 인벤토리 배치) --- */
  #mainContent {
      display: flex;
      gap: 15px;
      margin-top: 60px; /* topBar 높이만큼 여백 */
      margin-bottom: 20px;
      align-items: flex-start;
      flex-shrink: 0;
      /* 맵 중앙 배치를 위한 조정 */
      position: relative; 
      left: 50%;
      transform: translateX(-50%);
  }
  
  #topBar{
    display:flex;justify-content:space-between;width:100%;padding:8px 16px;position:fixed;top:0;right:0;left:0;
    z-index:50;background:var(--panel);box-shadow: 0 2px 5px rgba(0,0,0,0.5);height: 40px;align-items: center;box-sizing: border-box;
  }
  #authControls { display: flex; gap: 10px; align-items: center; }
  #authControls input { width: 100px; padding: 5px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  #bgmControls { display:flex;gap:10px;align-items:center;flex-shrink:0; }
  #bgmControls button, #adminBtn, #playerLoginBtn, #logoutBtn { padding:5px 10px;font-size:14px;line-height:1;height:30px; }
  #bgmVolume { width:80px;height:4px;background:var(--border-light);-webkit-appearance:none;appearance:none;border-radius:5px;cursor:pointer; }
  #bgmVolume::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px var(--accent);}

  /* 맵 컨테이너 (640x480 유지) */
  #container{
    position:relative;width:640px;height:480px;overflow:hidden;border:3px solid var(--border-light);
    box-shadow:0 0 40px var(--accent);background:#000;z-index:5;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:1}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2}
  #dragGhost { position:absolute;width:32px;height:32px;background:rgba(0,255,255,0.4);border:2px solid cyan;pointer-events:none;display:none;z-index:4; }
  
  /* 좌측 로그/채팅 패널 */
  #logChatPanel {
      width: 280px;
      height: 480px; 
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; 
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      flex-shrink: 0;
  }
  #logChatHistory {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding-right: 5px; 
      font-size: 13px;
      line-height: 1.4;
  }
  .log-system { color: #888; font-style: italic; }
  .log-chat b { color: #5dade2; } 
  .log-chat .admin-name { color: var(--accent); } 
  .log-chat { display: flex; align-items: flex-start; }
  #chatInputArea > div { display: flex; gap: 5px; }
  #chatInput { flex-grow: 1; padding: 6px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  
  /* 우측 상태/인벤토리 패널 */
  #statusInventoryPanel {
      width: 250px;
      height: 480px;
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; 
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      flex-shrink: 0;
  }
  #playerStatus div { display: flex; justify-content: space-between; margin-bottom: 5px; }
  #hpBar { width: 100%; height: 18px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-light); }
  #hpValue { height: 100%; background: #27ae60; transition: width 0.3s; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; color: #fff; }
  #inventoryGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 8px 0;
      flex-grow: 1;
  }
  .item-slot { width: 50px; height: 50px; background: var(--input-bg); border: 1px solid var(--border-dark); border-radius: 4px; cursor: pointer; }

  /* 관리자 패널 (스크롤 적용) */
  #adminPanel{
    position: relative; 
    margin-top: 15px; 
    margin-bottom: 40px; 
    z-index:15;background:var(--panel);padding:15px;border-radius:10px;
    font-size:14px;display:none;min-width:1180px;max-width:1180px;border:1px solid var(--accent);
    box-shadow:0 0 10px rgba(192,57,43,0.5);
    max-height: 80vh; 
    overflow-y: auto;
  }
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;width:100%;}
  .row label{white-space:nowrap;min-width: 60px;}
  #adminPlayerManagement, #adminTileManagement {
      flex: 1; background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 5px; border: 1px solid var(--border-dark);
      max-height: 400px; overflow-y: auto;
  }
  .player-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 5px; background: #222; }
  
  /* 로그인/모달 스타일 */
  .modal-bg{ position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7); display:none;align-items:center;justify-content:center;z-index:100; }
  .modal{ background:var(--panel);padding:20px;border-radius:10px;border:1px solid var(--border-light); box-shadow:0 0 15px rgba(0,0,0,0.8);max-width:500px;width:90%; }
  #loginBox{ position:fixed;top:50%;left:50%;transform:translate(-50%,-50%); background:var(--panel);padding:20px;border-radius:10px;z-index:110; border:1px solid var(--accent);box-shadow:0 0 10px var(--accent); display:none;flex-direction:column;gap:10px;align-items:center; }

  /* 기존 버튼 스타일 */
  button{background:var(--accent);color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;transition:background 0.2s;}
  button:hover{background:#a63125;}
  button:disabled{background:#555;cursor:not-allowed;}
  input, textarea, select{background:var(--input-bg);color:var(--text-color);border:1px solid var(--border-dark);padding:8px;border-radius:5px;}

</style>
</head>
<body>
<audio id="bgmAudio" loop preload="auto"></audio>

<div id="topBar">
    <div id="bgmControls"> 
        <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" title="볼륨">
        <button id="bgmToggleBtn">PLAY</button> 
    </div>
    <div id="authControls">
        <input type="text" id="playerIdInput" placeholder="플레이어 ID">
        <button id="playerLoginBtn">플레이어 로그인</button>
        <button id="adminBtn">관리자</button>
    </div>
</div>

<div id="mainContent">
    <div id="logChatPanel">
        <div id="logChatHistory">
            <div class="log-system">[SYSTEM] 환영합니다. 로그인 후 게임을 시작하세요.</div>
        </div>
        <div id="chatInputArea">
            <input type="text" id="nicknameInput" placeholder="관리자 닉네임 (입력 시 채팅명 변경)" style="display: none;">
            <div>
                <input type="text" id="chatInput" placeholder="메시지 입력..." disabled>
                <button id="chatSendBtn" disabled>전송</button>
            </div>
        </div>
    </div>

    <div id="container">
        <canvas id="game" width="640" height="480"></canvas>
        <div id="grid"></div>
        <div id="dragGhost"></div> 
        <canvas id="passableOverlay" width="640" height="480" style="position:absolute;left:0;top:0;z-index:3;pointer-events:none;"></canvas>
    </div>
    
    <div id="statusInventoryPanel">
        <div id="playerStatus">
            <h4 style="text-align: center;">상태</h4>
            <div><span id="playerNameDisplay"></span><span id="playerHPDisplay"></span></div>
            <div id="hpBar"><div id="hpValue"></div></div>
        </div>
        
        <div id="inventoryPanel">
            <h4 style="text-align: center;">인벤토리</h4>
            <div id="inventoryGrid"></div>
        </div>
    </div>
    
</div>

<div id="adminPanel">
  <h4>관리자 설정 패널</h4>
  <div style="display: flex; gap: 15px; width: 100%;">
      <div style="flex: 1;">
          <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">맵 기본 설정</h5>
          <div class="row"><label>맵 이름</label><input id="mapName" type="text"><button id="saveMap">맵 저장</button></div>
          <div class="row"><label>맵 이미지</label><input id="mapUrl" type="text" placeholder="이미지 URL"></div>
          <div class="row"><label>캐릭터</label><input id="spriteUrl" type="text" placeholder="스프라이트 URL"></div>
          <div class="row"><label>BGM URL</label><input id="bgmUrl" type="text" placeholder="배경음악 URL"></div> 
          <div class="row">
              <label>시작 좌표</label>
              <input id="startX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
              <input id="startY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
              <button id="setPlayerPos" style="flex-shrink: 0;">설정</button>
          </div>
          <div class="control-group" style="margin-top: 15px;"> 
            <button id="reload">로드</button>
            <button id="toggleGrid">그리드</button>
            <button id="toggleEncounter">조우</button> 
          </div>
          <hr>
          <div class="row" style="margin-bottom: 10px;"><button id="deleteAllEncounters" style="background: #880000; flex-grow: 1;">모든 조우 삭제</button></div>
          <div class="enc-list" id="encList" style="max-height: 200px; overflow-y: auto;"></div>
          <div id="mapButtons" style="margin-top:10px;"></div>
      </div>

      <div id="adminExtPanel" style="flex: 2; display: flex; gap: 15px;">
          <div id="adminPlayerManagement" style="flex: 1;">
              <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">플레이어/아이템/HP 관리</h5>
              <p style="font-size: 12px; margin: 0 0 5px 0; color: #ccc;">**계정 생성**</p>
              <div class="row" style="align-items: stretch; margin-bottom: 5px;">
                  <input type="text" id="newPlayerId" placeholder="새 플레이어 ID" style="flex: 1;">
                  <input type="text" id="newPlayerCharUrl" placeholder="캐릭터 이미지 URL" style="flex: 1;">
                  <button id="createPlayerBtn" style="flex-shrink: 0; padding: 5px 10px;">생성</button>
              </div>
              <p style="font-size: 12px; margin: 10px 0 5px 0; color: #ccc;">**글로벌 아이템 정의**</p>
              <div class="row" style="align-items: stretch; margin-bottom: 10px;">
                  <input type="text" id="newItemId" placeholder="ID" style="width: 50px;">
                  <input type="text" id="newItemName" placeholder="이름">
                  <input type="text" id="newItemUrl" placeholder="이미지 URL" style="flex: 1;">
                  <button id="createItemBtn" style="flex-shrink: 0; padding: 5px 10px;">정의</button>
              </div>
              <h5 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px;">플레이어 목록 및 상태 수정</h5>
              <div id="playerListContainer"></div>
          </div>
          <div id="adminTileManagement" style="flex: 1;">
              <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">맵 이동 제한 설정</h5>
              <div class="row" style="margin-bottom: 5px;">
                  <button id="togglePassableOverlay">제한 영역 보기</button>
                  <button id="setPassableTile">이동 제한/가능 모드</button>
              </div>
              <p style="font-size: 12px; margin: 0 0 10px 0; color: #888;">* 싱글 클릭: 이동 불가 (빨강) / 해제 토글. 더블클릭: 이동 가능 (초록) / 해제 토글.</p>
              <h5 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px;">현재 맵 제한 타일 목록</h5>
              <div id="passableMapList" style="max-height: 250px; overflow-y: auto;"></div>
          </div>
      </div>
  </div>
</div>

<div id="loginBox">
  <div>관리자 로그인</div>
  <input type="password" id="adminPw" placeholder="비밀번호 입력">
  <button id="loginBtn">로그인</button>
</div>

<div class="modal-bg" id="editModal">
    <div class="modal">
        <h4>조우 수정</h4>
        <label>이름</label><input id="encName" type="text">
        <label>지문</label><textarea id="encText" rows="3"></textarea>
        <label>캐릭터 이미지 URL</label><input id="encCharUrl" type="text">
        <label id="choicesLabel">선택지</label> <div id="choices"></div>
        <div id="addChoiceContainer" style="text-align: right;"><button id="addChoice">선택지 추가</button></div>
        <label>기본 트리거</label><select id="encTrigger"><option value="none">없음</option><option value="item">아이템 획득</option></select>
        <label>기본 트리거 데이터</label><input id="encData" type="text">
        <div style="margin-top:20px;text-align:right">
            <button id="saveEncEdit">저장</button>
            <button id="closeEncEdit">닫기</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="encounterModalBg">
    <div class="modal" id="encounterModal">
        <div class="char-img-container" id="encCharImgContainer"><img id="encCharImg" alt="Encounter Character" style="display:none;"/></div>
        <h4 id="encModalName"></h4>
        <div class="info-text" id="encModalText"></div>
        <div id="encounterChoices"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeEncounterModal">계속 진행</button></div>
    </div>
</div>

<div class="modal-bg" id="itemModalBg">
    <div class="modal">
        <h4 id="itemModalName">아이템 정보</h4>
        <div class="char-img-container" style="height: 150px;"><img id="itemModalImg" alt="Item Image" style="display:none; object-fit: contain;"/></div>
        <div class="info-text" id="itemModalDescription"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeItemModal">닫기</button></div>
    </div>
</div>

<script type="module">
// Firebase SDK import 및 설정 (기존과 동일)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, onSnapshot, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtPPF9Y93XVKHjo5_mmmxycf0CUJjWIRo",
  authDomain: "horror-game-14aa8.firebaseapp.com",
  projectId: "horror-game-14aa8",
  storageBucket: "horror-game-14aa8.firebasestorage.app",
  messagingSenderId: "125297141331",
  appId: "1:125297141331:web:a15f971c34dde0c7d708a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "test@gmail.com";
const ADMIN_PASSWORD = "adminpassword"; // **주의: 실제 사용 시 Firebase Auth에 등록된 비밀번호여야 합니다.**
const DEFAULT_MAX_HP = 100;
const MAX_INVENTORY_SLOTS = 12;
const GRID = 32;

/* --- 전역 상태 및 UI 바인딩 --- */
let currentPlayerId = null;
let currentPlayerData = null;
let isAdmin = false;
let isLoggedIn = false;
let currentMapName = null;
let encounterPoints = [];
let itemsDefinitions = {};
let mapPassable = {}; 
let player = JSON.parse(localStorage.getItem('playerPos') || '{"x":2,"y":2}');

// UI 요소 바인딩 (이전과 동일)
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
// ... (나머지 UI 요소 바인딩 생략 - HTML 참조) ...
const playerIdInput = document.getElementById('playerIdInput');
const playerLoginBtn = document.getElementById('playerLoginBtn');
const adminBtn = document.getElementById('adminBtn'); 
const adminPwInput = document.getElementById('adminPw');
const loginBtn = document.getElementById('loginBtn');
const bgmToggleBtn = document.getElementById('bgmToggleBtn');
const bgmVolume = document.getElementById('bgmVolume');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const mapNameInput = document.getElementById('mapName');
const reloadBtn = document.getElementById('reload');
const saveMapBtn = document.getElementById('saveMap');
const toggleGridBtn = document.getElementById('toggleGrid');
const toggleEncounterBtn = document.getElementById('toggleEncounter');
const setPlayerPosBtn = document.getElementById('setPlayerPos');
const startXInput = document.getElementById('startX');
const startYInput = document.getElementById('startY');
const encName = document.getElementById('encName');
const saveEncEditBtn = document.getElementById('saveEncEdit');
const closeEncEditBtn = document.getElementById('closeEncEdit');
const closeEncounterModalBtn = document.getElementById('closeEncounterModal');
const closeItemModalBtn = document.getElementById('closeItemModal');
const deleteEncountersBtn = document.getElementById('deleteAllEncounters');
const createPlayerBtn = document.getElementById('createPlayerBtn');
const createItemBtn = document.getElementById('createItemBtn');
const newPlayerIdInput = document.getElementById('newPlayerId');
const newPlayerCharUrlInput = document.getElementById('newPlayerCharUrl');
const newItemIdInput = document.getElementById('newItemId');
const newItemNameInput = document.getElementById('newItemName');
const newItemUrlInput = document.getElementById('newItemUrl');
const mapButtonsDiv = document.getElementById('mapButtons');

let mapImg = new Image(), sprite = new Image();
let showGrid = true;
let adding = false;
let currentEdit = -1;
let mapList = JSON.parse(localStorage.getItem('mapList') || '[]');
let isEncounterActive = false;
let currentEncounter = null;
let mapDocUnsub = null;
let chatUnsub = null;
let userUnsub = null;
let allUsersUnsub = null;
let itemsUnsub = null;

/* ========================================================================= */
/* 1. AUTH & LOGIC (버튼 기능 구현) */
/* ========================================================================= */

/** 플레이어 로그인 */
async function playerLogin() {
    const id = playerIdInput.value.trim();
    if (!id) {
        printLog('플레이어 ID를 입력하세요.', 'system');
        return;
    }
    
    try {
        const userRef = doc(db, 'users', id);
        const docSnap = await getDoc(userRef);

        if (!docSnap.exists()) {
            printLog(`플레이어 ID: ${id}를 찾을 수 없습니다.`, 'system');
            return;
        }

        // 로그인 성공 처리
        currentPlayerId = id;
        isLoggedIn = true;
        isAdmin = false;
        subscribeToPlayerData(id);
        
        // UI/로그 업데이트
        printLog(`플레이어 **${id}**로 로그인했습니다.`, 'system');
        updateUIVisibility();
        // 맵 리스너 재구독 (플레이어 모드로)
        loadMapDataFromFirestore(currentMapName || 'default_map'); 

    } catch (e) {
        printLog('로그인 중 오류 발생: ' + e.message, 'system');
    }
}

/** 관리자 로그인 (Firebase Auth 사용) */
async function adminLogin() {
    const password = adminPwInput.value;
    if (!password) {
        printLog('비밀번호를 입력하세요.', 'system');
        return;
    }
    
    try {
        await signInWithEmailAndPassword(auth, ADMIN_EMAIL, password);
        // Firebase Auth 상태 리스너가 isLoggedIn/isAdmin을 설정합니다.
        document.getElementById('loginBox').style.display = 'none';
        adminPwInput.value = ''; // 비밀번호 초기화
    } catch (error) {
        printLog('관리자 로그인 실패: ' + error.message, 'system');
    }
}

/** 로그아웃 */
async function logoutUser() {
    try {
        if (isAdmin) {
            await signOut(auth);
            printLog('관리자 로그아웃 완료.', 'system');
        }
        
        // 상태 초기화
        if (userUnsub) userUnsub();
        if (allUsersUnsub) allUsersUnsub();
        currentPlayerId = null;
        currentPlayerData = null;
        isLoggedIn = false;
        isAdmin = false;
        
        // UI 초기화
        updateUIVisibility();
        playerNameDisplay.textContent = '로그아웃됨';
        playerHPDisplay.textContent = 'HP: 0/0';
        document.getElementById('hpValue').style.width = '0%';
        document.getElementById('inventoryGrid').innerHTML = '';
        playerIdInput.value = '';
        
    } catch (e) {
        printLog('로그아웃 중 오류 발생: ' + e.message, 'system');
    }
}

/** 채팅 메시지 전송 */
async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text || !isLoggedIn) return;

    const senderId = isAdmin ? 'admin' : currentPlayerId;
    const senderName = isAdmin ? document.getElementById('nicknameInput').value || '관리자' : currentPlayerData.id;
    
    try {
        await setDoc(doc(db, 'chats', Date.now().toString()), {
            map: currentMapName,
            senderId: senderId,
            senderName: senderName,
            message: text,
            timestamp: new Date()
        });
        chatInput.value = '';
    } catch (e) {
        printLog('채팅 전송 실패: ' + e.message, 'system');
    }
}

/** 채팅 리스너 구독 */
function subscribeToChat() {
    if (chatUnsub) chatUnsub();
    const chatRef = collection(db, 'chats');
    const q = query(chatRef); 
    
    chatUnsub = onSnapshot(q, (snapshot) => {
        logChatHistory.innerHTML = ''; // 채팅 기록 초기화 (간단하게)
        snapshot.docs.sort((a, b) => a.data().timestamp - b.data().timestamp)
            .forEach(doc => {
            const data = doc.data();
            const message = data.message;
            const senderId = data.senderId;
            printLog(message, 'chat', senderId, doc.id);
        });
    }, err => console.error('채팅 구독 실패:', err));
}

/** 플레이어 이동 */
async function movePlayer(dx, dy) {
    if (isEncounterActive || !isLoggedIn) return;
    
    const newX = player.x + dx;
    const newY = player.y + dy;
    
    // 맵 경계 체크
    if (newX < 0 || newX >= canvas.width / GRID || newY < 0 || newY >= canvas.height / GRID) {
        printLog('맵 경계를 벗어날 수 없습니다.', 'system');
        return;
    }

    // 이동 가능 타일 체크
    if (!checkPassable(newX, newY)) {
        printLog('이동 제한 구역입니다.', 'system');
        return;
    }
    
    // 이동
    player.x = newX;
    player.y = newY;
    localStorage.setItem('playerPos', JSON.stringify(player));
    draw(); 
    
    // 조우 체크
    checkEncounter();
}

/** 이동 가능 여부 체크 */
function checkPassable(x, y) {
    const key = `${x},${y}`;
    // mapPassable에 정의가 없으면 기본적으로 이동 가능(true)
    // mapPassable[key]가 false면 이동 불가
    // mapPassable[key]가 true면 이동 가능 (오버라이드)
    
    if (mapPassable.hasOwnProperty(key)) {
        return mapPassable[key] === true;
    }
    return true; // 기본값
}

/** 조우 체크 */
function checkEncounter() {
    if (!isLoggedIn || isAdmin || isEncounterActive) return;
    
    const encIndex = encounterPoints.findIndex(e => e.x === player.x && e.y === player.y);
    if (encIndex !== -1) {
        isEncounterActive = true;
        currentEncounter = encounterPoints[encIndex];
        openEncounterModal(currentEncounter);
    }
}

/** 조우 모달 열기 */
function openEncounterModal(encounter) {
    document.getElementById('encModalName').textContent = encounter.name || '미지의 조우';
    document.getElementById('encModalText').textContent = encounter.text || '지문이 없습니다.';
    
    const imgContainer = document.getElementById('encCharImgContainer');
    const img = document.getElementById('encCharImg');
    if (encounter.charUrl) {
        img.src = encounter.charUrl;
        img.style.display = 'block';
    } else {
        img.style.display = 'none';
    }

    const choicesDiv = document.getElementById('encounterChoices');
    const closeBtn = document.getElementById('closeEncounterModal');
    choicesDiv.innerHTML = '';
    closeBtn.style.display = 'block'; 

    if (encounter.choices && encounter.choices.length > 0) {
        closeBtn.style.display = 'none'; // 선택지가 있으면 기본 닫기 버튼 숨김
        encounter.choices.forEach((choice, index) => {
            const btn = document.createElement('button');
            btn.textContent = choice.text;
            btn.style.marginRight = '10px';
            btn.onclick = () => processChoice(choice, index);
            choicesDiv.appendChild(btn);
        });
    } else {
        // 기본 트리거 처리 (선택지가 없을 경우)
        processEncounterTrigger({
            trigger: encounter.trigger,
            data: encounter.data,
            resultText: `**${encounter.name}**: ${encounter.text || '조우가 발생했습니다.'}`
        });
    }

    document.getElementById('encounterModalBg').style.display = 'flex';
}

/** 선택지 처리 */
function processChoice(choice, index) {
    // 선택지 버튼 숨기기
    document.getElementById('encounterChoices').innerHTML = '';
    
    // 결과 텍스트 표시
    const resultDiv = document.createElement('div');
    resultDiv.className = 'log-system';
    resultDiv.textContent = `[선택]: ${choice.text}`;
    document.getElementById('encounterChoices').appendChild(resultDiv);
    
    // 트리거 처리
    processEncounterTrigger(choice);
    
    // 닫기 버튼 표시
    document.getElementById('closeEncounterModal').style.display = 'block';
}

/** 조우/선택지 트리거 실행 */
async function processEncounterTrigger(trigger) {
    printLog(trigger.resultText || '이벤트가 발생했습니다.', 'system');
    
    // DB에서 조우 삭제 (1회성 조우 처리)
    const currentPos = `${player.x},${player.y}`;
    const encIndex = encounterPoints.findIndex(e => `${e.x},${e.y}` === currentPos);
    if (encIndex !== -1) {
        encounterPoints.splice(encIndex, 1);
        // DB에 저장하여 모든 플레이어에게 반영
        if (currentMapName) await saveMapDataToFirestore(currentMapName); 
    }

    switch (trigger.trigger) {
        case 'map':
            loadMapDataFromFirestore(trigger.data);
            break;
        case 'item':
            if (currentPlayerId && trigger.data) {
                await updateDoc(doc(db, 'users', currentPlayerId), {
                    inventory: arrayUnion(trigger.data)
                });
                printLog(`아이템 **${trigger.data}**를 획득했습니다.`, 'system');
            }
            break;
        case 'hp':
            if (currentPlayerId && trigger.data) {
                const hpChange = parseInt(trigger.data);
                if (!isNaN(hpChange)) {
                    await updateDoc(doc(db, 'users', currentPlayerId), {
                        hp: increment(hpChange)
                    });
                    printLog(`HP가 ${hpChange}만큼 변경되었습니다.`, 'system');
                }
            }
            break;
        case 'sound':
             // 사운드 재생 로직 추가
             printLog(`[SOUND] ${trigger.data} 재생`, 'system');
             break;
        case 'image':
             // 이미지 팝업 로직 추가
             printLog(`[IMAGE POPUP] ${trigger.data} 표시`, 'system');
             break;
        case 'none':
        default:
            break;
    }
}

document.getElementById('closeEncounterModal').onclick = () => {
    document.getElementById('encounterModalBg').style.display = 'none';
    isEncounterActive = false;
    currentEncounter = null;
    draw(); // 조우 포인트가 사라질 수 있으므로 다시 그리기
};

/** 관리자: 맵 클릭 시 타일 설정 또는 조우 추가 */
function handleMapClickOrTileSet(e) {
    if (!isAdmin) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / GRID);
    const y = Math.floor((e.clientY - rect.top) / GRID);
    const key = `${x},${y}`;

    if (adding) {
        // 조우 설정 모드
        const existingIndex = encounterPoints.findIndex(p => p.x === x && p.y === y);
        if (existingIndex !== -1) {
            openEditModal(existingIndex); // 기존 조우 수정
        } else {
            // 새 조우 추가
            encounterPoints.push({ x, y, name: '새 조우', text: '...', charUrl: '', trigger: 'none', data: '', choices: [] });
            currentEdit = encounterPoints.length - 1;
            openEditModal(currentEdit);
        }
        adding = false; // 추가 후 모드 해제
        toggleEncounterBtn.textContent = '조우';
        document.getElementById('container').style.cursor = 'default';
        draw();
    } else if (togglePassableOverlayBtn.classList.contains('active')) {
        // 이동 제한 설정 모드
        if (e.detail === 1) { // 싱글 클릭: 이동 불가/해제 토글
            if (mapPassable.hasOwnProperty(key)) {
                if (mapPassable[key] === false) delete mapPassable[key]; // 해제
                else mapPassable[key] = false; // 이동 불가 설정
            } else {
                mapPassable[key] = false; // 이동 불가 설정
            }
        } else if (e.detail === 2) { // 더블 클릭: 이동 가능/해제 토글
            if (mapPassable.hasOwnProperty(key)) {
                if (mapPassable[key] === true) delete mapPassable[key]; // 해제
                else mapPassable[key] = true; // 이동 가능 설정
            } else {
                mapPassable[key] = true; // 이동 가능 설정
            }
        }
        drawPassableOverlay();
        saveMapDataToFirestore(mapNameInput.value); // 즉시 저장
    }
}

/** 관리자: 이동 제한 오버레이 토글 */
document.getElementById('togglePassableOverlay').onclick = function() {
    if (!isAdmin) return;
    this.classList.toggle('active');
    this.textContent = this.classList.contains('active') ? '제한 영역 숨기기' : '제한 영역 보기';
    drawPassableOverlay();
};

/** 관리자: 타일 설정 모드 토글 (현재 사용 안함, 오버레이 토글에 통합) */
// document.getElementById('setPassableTile').onclick = function() {
//     // ... (로직 생략 - 맵 클릭 핸들러에 통합)
// };

/** 관리자: 플레이어 생성 */
document.getElementById('createPlayerBtn').onclick = async () => {
    if (!isAdmin) return;
    const id = newPlayerIdInput.value.trim();
    const charUrl = newPlayerCharUrlInput.value.trim();
    if (!id) { printLog('ID를 입력하세요.', 'system'); return; }

    try {
        await setDoc(doc(db, 'users', id), {
            id,
            map: currentMapName,
            x: parseInt(startXInput.value) || 0,
            y: parseInt(startYInput.value) || 0,
            hp: DEFAULT_MAX_HP,
            maxHp: DEFAULT_MAX_HP,
            charUrl: charUrl || spriteUrlInput.value,
            inventory: [],
            isAdmin: false 
        });
        printLog(`플레이어 **${id}** 생성 완료.`, 'system');
        newPlayerIdInput.value = '';
        newPlayerCharUrlInput.value = '';
    } catch (e) {
        printLog('플레이어 생성 실패: ' + e.message, 'system');
    }
};

/** 관리자: 아이템 정의 */
document.getElementById('createItemBtn').onclick = async () => {
    if (!isAdmin) return;
    const id = newItemIdInput.value.trim();
    const name = newItemNameInput.value.trim();
    const url = newItemUrlInput.value.trim();
    if (!id || !name) { printLog('ID와 이름을 입력하세요.', 'system'); return; }

    try {
        await setDoc(doc(db, 'items', id), {
            name: name,
            url: url,
            description: prompt('아이템 설명 입력:') || '설명 없음.'
        });
        printLog(`아이템 **${name}** 정의 완료.`, 'system');
        newItemIdInput.value = newItemNameInput.value = newItemUrlInput.value = '';
    } catch (e) {
        printLog('아이템 정의 실패: ' + e.message, 'system');
    }
};

// ========================================================================= 
// 2. EVENT BINDING (버튼 이벤트 연결)
// ========================================================================= 

playerLoginBtn.onclick = playerLogin;
adminBtn.onclick = () => {
    if (isLoggedIn) logoutUser();
    else document.getElementById('loginBox').style.display = 'flex';
};
loginBtn.onclick = adminLogin;
chatSendBtn.onclick = sendMessage;
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
});

// 관리자 패널 버튼 (HTML에 onclick이 없으므로 여기서 다시 연결)
document.getElementById('reload').onclick = () => loadMapDataFromFirestore(mapNameInput.value || 'default_map');
document.getElementById('toggleGrid').onclick = () => {
    if (!isAdmin) return;
    showGrid = !showGrid;
    document.getElementById('toggleGrid').textContent = showGrid ? '그리드 숨김' : '그리드 표시';
    draw();
};
document.getElementById('toggleEncounter').onclick = () => {
    if (!isAdmin) return;
    adding = !adding;
    document.getElementById('toggleEncounter').textContent = adding ? '조우 설정 중 (취소)' : '조우';
    document.getElementById('container').style.cursor = adding ? 'crosshair' : 'default';
    printLog(adding ? '조우 포인트 설정 모드 활성화됨. 맵을 클릭하세요.' : '조우 포인트 설정 모드 비활성화됨.', 'system');
};
document.getElementById('setPlayerPos').onclick = async () => {
    if (!isAdmin) return;
    const x = parseInt(startXInput.value);
    const y = parseInt(startYInput.value);
    if (isNaN(x) || isNaN(y)) return alert('유효한 좌표를 입력하세요.');
    
    // DB에 시작 위치 저장
    if (currentMapName) {
         await setDoc(doc(db, 'maps', currentMapName), { startX: x, startY: y }, { merge: true });
         printLog(`맵의 시작 위치를 (${x}, ${y})로 설정하고 저장했습니다.`, 'system');
    }
};

// ... (나머지 관리자 버튼 이벤트는 상단 1. AUTH & LOGIC 섹션에 정의됨)

// Firebase Auth 상태 변화 감지 (관리자 로그인 자동 처리)
auth.onAuthStateChanged(user => {
    if (user && user.email === ADMIN_EMAIL) {
        currentPlayerId = 'admin';
        isLoggedIn = true;
        isAdmin = true;
        updateUIVisibility();
        printLog('관리자 로그인 성공.', 'system');
        // 관리자 로그인 시 맵 데이터 로드 및 리스너 재설정
        loadMapDataFromFirestore(currentMapName || 'default_map'); 
    } else if (isAdmin) {
        // 관리자였는데 로그아웃된 경우
        logoutUser();
    }
});

// ... (모든 필요한 함수들을 복원했으므로, 이제 버튼이 정상 작동할 것입니다.)

// 초기화 호출 (맨 아래에 위치하여 모든 함수가 정의된 후 실행)
redrawMapButtons();
updateControlButtons(); 
startXInput.value = player.x;
startYInput.value = player.y;
updateUIVisibility();
// 초기에 맵 데이터 로드 (default_map 또는 저장된 맵)
loadMapDataFromFirestore(mapList[0] || 'default_map'); 

</script>
</body>
</html>
