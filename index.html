<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tistoryìš© ê³µí¬ ì¯”ê¾¸ë¥´ (í™•ì¥ ê´€ë¦¬ìíŒ, Firebase í†µí•©)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
  :root{
    --bg:#000;
    --panel:rgba(0,0,0,0.85);
    --accent:#c0392b;
    --border-dark:#222;
    --border-light:#444;
    --text-color:#eee;
    --input-bg:#1a1a1a;
    --panel-width: 250px; 
    --main-width: 640px; 
    --main-height: 480px; 
  }
  body{
    margin:0;background:var(--bg);color:var(--text-color);font-family:'Noto Sans KR',sans-serif;
    display:flex;flex-direction:row;align-items:center;justify-content:center;height:100vh;overflow:hidden;
    gap: 10px; 
  }
  #topBar{
    display:flex;justify-content:space-between;width:100%;padding:8px 16px;position:fixed;top:0;right:0;left:0;
    z-index:20;background:var(--panel);box-shadow: 0 2px 5px rgba(0,0,0,0.5);height: 40px;align-items: center;box-sizing: border-box;
  }
  #topBarControls { display: flex; gap: 10px; align-items: center; } 
  #bgmControls { display:flex;gap:10px;align-items:center;flex-shrink:0; }
  #bgmControls button, #adminBtn, #playerLoginBtnTop { padding:5px 10px;font-size:14px;line-height:1;height:30px; }
  #bgmVolume { width:80px;height:4px;background:var(--border-light);-webkit-appearance:none;appearance:none;border-radius:5px;cursor:pointer; }
  #bgmVolume::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px var(--accent);}
  
  /* --- Side Panels: Log/Chat (Left) & Status/Inventory (Right) --- */
  .side-panel {
    width: var(--panel-width);
    height: var(--main-height); 
    background: var(--panel);
    border: 1px solid var(--border-light);
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    z-index: 5;
  }
  
  /* Log/Chat Panel: **[ìˆ˜ì •]** ë¡œê·¸ì¸ ì „ ê¸°ë³¸ ìˆ¨ê¹€ */
  #logChatPanel { order: 1; display: none; }
  #logDisplay {
    flex-grow: 1;
    overflow-y: auto;
    background: var(--input-bg);
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid var(--border-dark);
  }
  .log-item, .chat-item { font-size: 13px; line-height: 1.4; padding: 2px 0; border-bottom: 1px dotted rgba(255,255,255,0.05); }
  .log-item.system { color: #f1c40f; }
  .log-item.item { color: #2ecc71; }
  .chat-item.admin { color: #f1c40f; font-weight: bold; } 
  .chat-input-group { display: flex; gap: 5px; }
  .chat-input-group input { flex-grow: 1; }
  .chat-input-group button { flex-shrink: 0; padding: 5px 10px; }
  
  /* Log/Chat Panel UI & Layout Fixes */
  .chat-controls { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 5px;
      gap: 5px; 
  }
  
  #logChatPanel .chat-controls button {
      width: 30px; 
      height: 30px; 
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px; 
      line-height: 1;
      flex-shrink: 0;
  }
  /* **[ì‚­ì œ]** ì „ì²´ ì±„íŒ… ê¸°ë¡ ë³´ê¸° ë²„íŠ¼ (#logToggleBtn) ê´€ë ¨ CSS ì‚­ì œ */

  .chat-controls > div {
      display: flex; 
      align-items: center; 
      flex-grow: 1; 
      min-width: 50px; 
  }

  .chat-controls #chatNickname {
      width: 100%; 
      padding: 5px; 
      margin: 0; 
      box-sizing: border-box; 
  }

  .chat-item span.admin-actions { margin-left: auto; display: none; } 
  .chat-item span.admin-actions button { margin-left: 5px; padding: 2px 5px; font-size: 10px; }

  /* Status/Inventory Panel (Right Panel) */
  #statusInventoryPanel { order: 3; display: none; } /* **[ìˆ˜ì •]** ê¸°ë³¸ ìˆ¨ê¹€ */
  
  /* Player Content **[ìˆ˜ì •]** ì „ì²´ ìˆ˜ì§ ìŠ¤í¬ë¡¤ ì ìš©ì„ ìœ„í•´ flex-grow: 1; ìœ ì§€ */
  #playerContent { display: flex; flex-direction: column; flex-grow: 1; }
  #playerStatus {
      padding: 5px;
      border-bottom: 1px solid var(--border-dark);
      margin-bottom: 10px;
  }
  #playerHP { font-size: 16px; font-weight: bold; color: var(--accent); }
  /* **[ìˆ˜ì •]** ì¸ë²¤í† ë¦¬ ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ */
  #inventoryList {
      flex-grow: 1;
      overflow-y: auto;
      padding: 5px;
  }
  /* **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œ í˜„ì¬ ë§µ í”Œë ˆì´ì–´ ë¦¬ìŠ¤íŠ¸ ìŠ¤í¬ë¡¤ */
  #playerOnMapListPlayerMode {
      flex-grow: 1;
      overflow-y: auto;
      max-height: 150px; /* ê³ ì • ë†’ì´/ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì„¤ì • */
      margin-top: 5px;
      padding: 5px;
      background: var(--input-bg);
      border-radius: 4px;
      border: 1px solid var(--border-dark);
  }
  
  .inventory-item { 
      display: flex;
      gap: 10px;
      padding: 8px;
      margin-bottom: 5px;
      background: var(--input-bg);
      border-radius: 4px;
      border: 1px solid var(--border-dark);
      align-items: center;
      cursor: pointer;
  }
  .inventory-item:hover { background: #2a2a2a; }
  .item-name { font-weight: bold; font-size: 14px; }
  .item-image { width: 40px; height: 40px; object-fit: cover; border-radius: 3px; border: 1px solid var(--accent); }
  .item-desc { font-size: 12px; color: #aaa; }

  /* Admin Info Content **[ìˆ˜ì •]** ì „ì²´ ì»¨í…Œì´ë„ˆ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ height: 100% ë° overflow ì ìš© */
  #adminRightInfo { 
      padding: 5px; 
      flex-grow: 1; 
      font-size: 14px; 
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      overflow-y: auto; /* **[ì¶”ê°€]** ê´€ë¦¬ì ì •ë³´ ì°½ ì „ì²´ ìŠ¤í¬ë¡¤ */
  }
  #adminRightInfo h4 { 
      width: 100%; 
      margin-top: 0; 
      border-bottom: 1px solid var(--border-dark); 
      padding-bottom: 8px; 
      color: var(--accent); 
      flex-shrink: 0; /* ì œëª©ì€ ê³ ì • */
  }
  #adminRightInfo p { 
      margin-bottom: 8px; 
      line-height: 1.5;
      flex-shrink: 0; 
  }
  #adminRightInfo hr {
      width: 100%;
      margin: 15px 0;
      flex-shrink: 0;
  }
  /* **[ìˆ˜ì •]** Admin Map Player List ìŠ¤í¬ë¡¤ ì˜ì—­ */
  #playerOnMapList {
      flex-grow: 1;
      overflow-y: auto;
      margin-top: 5px;
      padding: 5px;
      background: var(--input-bg);
      border-radius: 4px;
      border: 1px solid var(--border-dark);
      min-height: 50px; /* ìŠ¤í¬ë¡¤ì„ ìœ„í•´ ìµœì†Œ ë†’ì´ í™•ë³´ */
  }
  .player-on-map-item {
      padding: 5px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      line-height: 1.4;
  }
  .player-on-map-item:last-child { border-bottom: none; }
  .player-on-map-item strong { color: #5dade2; } 
  .player-on-map-item small { display: block; color: #aaa; font-size: 11px; margin-left: 5px; }
  
  #container{
    order: 2; 
    position:relative;width:var(--main-width);height:var(--main-height);overflow:hidden;border:3px solid var(--border-light);
    box-shadow:0 0 40px var(--accent);background:#000;z-index:5;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:1}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2}
  #dragGhost { position:absolute;width:32px;height:32px;background:rgba(0,255,255,0.4);border:2px solid cyan;pointer-events:none;display:none;z-index:4; }
  
  /* Admin Panel tabs */
  #adminPanel{
    position:fixed; 
    right: 20px; 
    top: 60px;
    z-index:15;background:var(--panel);padding:15px;border-radius:10px;
    font-size:14px;display:none;min-width:400px;max-width:400px;border:1px solid var(--accent);
    box-shadow:0 0 10px rgba(192,57,43,0.5);max-height: calc(100vh - 80px);overflow-y: auto;
    transition: width 0.3s, height 0.3s, padding 0.3s, overflow 0.3s; 
  }

  /* --- ìŠ¤í¬ë¡¤ë°” ë””ìì¸ í†µì¼ --- */
  /* **[ìˆ˜ì •]** #adminRightInfo ì¶”ê°€ */
  #adminPanel, #editModal .modal, #choices, #logDisplay, #inventoryList, #adminRightInfo, #playerOnMapListPlayerMode { 
      scrollbar-width: thin; 
      scrollbar-color: var(--accent) rgba(0,0,0,0.2); 
  }
  /* **[ìˆ˜ì •]** #adminRightInfo, #playerOnMapListPlayerMode ì¶”ê°€ */
  #adminPanel::-webkit-scrollbar, 
  #editModal .modal::-webkit-scrollbar, 
  #choices::-webkit-scrollbar, 
  #logDisplay::-webkit-scrollbar,
  #inventoryList::-webkit-scrollbar,
  #adminRightInfo::-webkit-scrollbar,
  #playerOnMapListPlayerMode::-webkit-scrollbar { 
      width: 8px; 
  }
  /* **[ìˆ˜ì •]** #adminRightInfo, #playerOnMapListPlayerMode ì¶”ê°€ */
  #adminPanel::-webkit-scrollbar-thumb, 
  #editModal .modal::-webkit-scrollbar-thumb, 
  #choices::-webkit-scrollbar-thumb, 
  #logDisplay::-webkit-scrollbar-thumb,
  #inventoryList::-webkit-scrollbar-thumb,
  #adminRightInfo::-webkit-scrollbar-thumb,
  #playerOnMapListPlayerMode::-webkit-scrollbar-thumb { 
      background-color: var(--accent); 
      border-radius: 4px; 
      visibility: hidden; 
  }
  /* **[ìˆ˜ì •]** #adminRightInfo, #playerOnMapListPlayerMode ì¶”ê°€ */
  #adminPanel:hover::-webkit-scrollbar-thumb, 
  #editModal .modal:hover::-webkit-scrollbar-thumb, 
  #choices:hover::-webkit-scrollbar-thumb, 
  #logDisplay:hover::-webkit-scrollbar-thumb,
  #inventoryList:hover::-webkit-scrollbar-thumb,
  #adminRightInfo:hover::-webkit-scrollbar-thumb,
  #playerOnMapListPlayerMode:hover::-webkit-scrollbar-thumb { 
      visibility: visible; 
  }
  /* **[ìˆ˜ì •]** #adminRightInfo, #playerOnMapListPlayerMode ì¶”ê°€ */
  #adminPanel::-webkit-scrollbar-track,
  #editModal .modal::-webkit-scrollbar-track,
  #choices::-webkit-scrollbar-track,
  #logDisplay::-webkit-scrollbar-track,
  #inventoryList::-webkit-scrollbar-track,
  #adminRightInfo::-webkit-scrollbar-track,
  #playerOnMapListPlayerMode::-webkit-scrollbar-track { 
      background: rgba(0,0,0,0.2); 
  }
  /* --- ìŠ¤í¬ë¡¤ë°” ë --- */
  
  /* Drag handle style */
  #adminPanel h4{
      margin:0 0 12px 0;text-align:center;color:var(--accent);border-bottom: 1px solid var(--border-dark);padding-bottom: 8px;
      cursor: grab; 
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  /* Minimize button style */
  #minimizeBtn {
      background: none;
      border: none;
      color: var(--accent);
      padding: 0 5px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      transition: color 0.2s;
      margin-left: 10px;
  }
  #minimizeBtn:hover { color: #fff; }

  /* Minimized State */
  #adminPanel.minimized {
    width: 150px;
    min-width: 150px;
    height: auto; 
    max-height: 50px;
    padding: 10px 15px;
    overflow: hidden;
    right: 20px !important; 
    left: auto !important;
    top: 60px !important;
  }
  #adminPanel.minimized h4 {
    margin: 0;
    padding: 0;
    border-bottom: none;
  }
  #adminPanel.minimized #minimizeBtn {
      margin-left: 0;
  }
  #adminPanel.minimized .admin-tabs,
  #adminPanel.minimized .admin-tab-content {
    display: none !important;
  }

  
  .admin-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-dark); }
  .admin-tabs button { flex: 1; padding: 10px 5px; background: var(--border-dark); border: none; border-radius: 4px 4px 0 0; color: var(--text-color); cursor: pointer; transition: background 0.2s; }
  .admin-tabs button:not(.active):hover { background: #444; }
  .admin-tabs button.active { background: var(--accent); color: #fff; border-bottom: 1px solid var(--accent); }
  
  .admin-tab-content { display: none; }
  .admin-tab-content.active { display: block; }
  
  /* Existing Admin Panel styles */
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;width:100%;}
  .row label{white-space:nowrap;min-width: 60px;}
  hr {border: none;border-top: 1px dashed var(--border-dark);margin: 15px 0;}
  input[type=text], input[type=password], input[type=number], select, textarea{
    background:var(--input-bg);border:1px solid var(--border-dark);padding:8px;border-radius:4px;
    color:var(--text-color);width:100%;box-sizing:border-box;transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent);outline: none;}
  button{
    background:var(--border-dark);border:1px solid var(--border-light);color:var(--text-color);
    padding:8px 12px;border-radius:4px;cursor:pointer;white-space:nowrap;
    transition: background 0.2s, color: 0.2s;text-align: center;
  }
  button:hover{background:var(--accent);border-color:var(--accent);color:#fff;}
  #toggleGrid.active, #toggleEncounter.active, #toggleImpassable.active {background: var(--accent);border-color: var(--accent);color: #fff;}
  
  /* [1. ë¡œë“œ/ê·¸ë¦¬ë“œ/ì¡°ìš°/ì œí•œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ê°€ë¡œ ë„“ì´ ê· ë“± ë¶„ë°°] */
  .control-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
  }
  .control-group button {
      flex: 1; /* ëª¨ë“  ë²„íŠ¼ì´ ë™ì¼í•œ ë¹„ìœ¨ë¡œ í™•ì¥ */
      min-width: 0;
  }
  
  #adminPanel > .row:first-of-type #mapName {flex-grow: 1;}
  #adminPanel > .row:first-of-type #saveMap {flex-grow: 1;width: auto;flex-shrink: 1;}
  #mapButtons {display: block !important;}
  
  /* [2. ì¡°ìš°/ì œí•œ ì „ì²´ ì‚­ì œ ë²„íŠ¼ í¬ê¸° í†µì¼ ë° ì •ë ¬] **[ì‚­ì œ ì ìš©]** */
  #mapButtons > div {display: flex;gap: 10px;margin-bottom: 5px;width: 100%;}
  #mapButtons > div button {
      flex-grow: 1; 
      min-width: 0;
  }

  /* Map List Item Style */
  .map-list-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 8px; 
      border-bottom: 1px dashed var(--border-dark); 
      cursor: pointer;
      transition: background 0.2s;
  }
  .map-list-item:hover { 
      background: rgba(192, 57, 43, 0.1); 
  }
  .map-list-item span { 
      font-weight: bold; 
      color: var(--text-color);
  }
  .map-list-item:last-child { border-bottom: none; }
  .map-list-item button { 
      padding: 4px 8px; 
      font-size: 11px;
      background: #550000;
      border-color: #770000;
  }
  
  /* Login Boxes - FIXED CSS */
  #loginBox, #playerLoginBox {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.8); 
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center; 
    z-index:25; 
  }
  #loginBox .modal, #playerLoginBox .modal {
    background:var(--panel);padding:20px;
    border-radius:8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);border:1px solid var(--border-light);
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  #loginBox div, #playerLoginBox div {font-size: 1.1em;margin-bottom: 10px;}
  #loginBox input, #playerLoginBox input{ margin-top:8px;padding:10px;border-radius:4px;border:none;background:#2a2a2a;color:#fff;width:220px;text-align:center; }
  #loginBox button, #playerLoginBox button{ margin-top:15px;padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:4px; }
  #loginBox button:hover, #playerLoginBox button:hover{background: #e74c3c;}
  
  /* User/Item List Styles */
  .list-container { max-height:250px;overflow-y:auto;padding:8px;background:rgba(255,255,255,0.05); border-radius:4px;margin-top:10px;border: 1px solid var(--border-dark); }
  .list-item{ display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.05);font-size:13px;align-items:center; }
  .list-item:last-child {border-bottom: none;}
  .list-item > span {flex-grow: 1;}
  .list-item div {display: flex;gap: 5px;}
  .list-item button {padding: 4px 8px;font-size: 12px;}
  .list-item button.del {background: #550000;border-color: #770000;}
  .list-item button.del:hover {background: #e74c3c;}
  .list-item input[type=text], .list-item input[type=number] { margin: 0; padding: 4px; height: auto; font-size: 12px; }

  /* Modal Styles */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:30;}
  /* **[ì¶”ê°€]** ë‚´ë¶€ íŒì—… ìŠ¤íƒ€ì¼ (position: absoluteë¡œ #container ë‚´ë¶€ì— í‘œì‹œ) */
  .internal-modal-bg {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10; /* #container ë‚´ë¶€ì˜ ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— */
  }
  .internal-modal-bg .modal {
    background:#111;padding:15px;border-radius:10px;min-width:300px;max-width: 500px; width: auto;color:var(--text-color);box-sizing:border-box;border:2px solid var(--accent);box-shadow: 0 0 15px rgba(192, 57, 43, 0.7);
  }
  
  .modal{background:#111;padding:15px;border-radius:10px;min-width:450px;max-width: 600px; width: auto;color:var(--text-color);box-sizing:border-box;border:2px solid var(--accent);box-shadow: 0 0 15px rgba(192, 57, 43, 0.7);}
  
  /* ì¡°ìš° íŒì—… ë‚´ ìŠ¤í¬ë¡¤ íŠ€ì–´ë‚˜ì˜´ ë¬¸ì œ ìˆ˜ì • */
  #editModal .modal { 
      min-width: 600px; 
      max-width: 800px; 
      width: 70vw; 
      overflow-y: auto; 
      max-height: 90vh; 
  }
  
  #editModal .modal h4 { margin-top: 5px; margin-bottom: 8px; }
  .modal label { display: block; margin-top: 8px; margin-bottom: 3px; font-weight: bold; color: var(--accent); }
  
  #choices { 
      padding: 5px; 
      border-radius: 4px; 
      max-height: 200px; 
      min-height: 40px; 
      overflow-y: auto; 
      background: rgba(255, 255, 255, 0.03); 
      box-sizing: border-box; 
      margin-top: 5px;
  }
  .choice{ margin-bottom:10px; padding: 8px; width:100%; border: 1px solid var(--border-dark); border-radius: 4px; background: var(--input-bg); box-sizing: border-box; }
  .choice:last-child { margin-bottom: 0; }
  .choice-text-group, .choice-result-group, .choice-trigger-group, .choice-item-group, .choice-hp-group { padding: 2px 0; } 
  .choice label { font-weight: 400; font-size: 13px; color: var(--text-color); margin-top: 5px; margin-bottom: 3px; }
  
  .choice-text-group {display: flex;gap: 5px;width: 100%;align-items: center;}
  .choice-text-group input.choiceText {flex: 1;padding: 6px;line-height: normal; min-width: 0;}
  .choice-text-group button {padding: 6px 10px;font-size: 13px;flex-shrink: 0;width: 30px;height: auto;}
  
  .choice-result-group { display: flex;flex-direction: column;gap: 5px;padding-left: 0;width: 100%;box-sizing: border-box; }
  .choice-result-group textarea.choiceResultText {flex: 1;resize: vertical;min-height: 50px;max-height: 150px;padding: 6px; margin-bottom: 0;}
  
  .choice-trigger-group, .choice-item-group { display: flex; gap: 8px; margin-bottom: 0; align-items: center; padding-left: 0; width: 100%; box-sizing: border-box; }
  .choice-hp-group { display: flex; gap: 8px; margin-bottom: 0; align-items: center; padding-left: 0; width: 100%; box-sizing: border-box; } 
  
  .choice-trigger-group label, .choice-item-group label, .choice-hp-group label { flex-shrink: 0; width: 70px; } 
  .choice-trigger-group select.choiceTrigger { flex: 0 0 120px; width: 120px; padding: 6px; }
  .choice-trigger-group input.choiceData { flex: 1; padding: 6px; min-width: 50px; }
  
  .choice-item-group select, .choice-item-group input {padding: 6px; flex-shrink: 0; }
  .choice-item-group select { width: 150px; }
  .choice-item-group input[type="number"] { width: 80px; text-align: center;} 
  .choice-hp-group input.choiceHpChange { flex: 0 0 80px; width: 80px; text-align: center; padding: 6px; } 

  #addChoiceContainer { text-align: right; margin-top: 10px; margin-bottom: 5px; }
  .modal > div:last-child { margin-top: 10px !important; }

  /* **[ìˆ˜ì •]** ë‚´ë¶€ íŒì—…ì„ ìœ„í•´ #encounterModal ìŠ¤íƒ€ì¼ ë³€ê²½ */
  #encounterModalBg .modal {min-width: 500px;padding: 20px;}
  #encounterModalBg h4 {color: #fff;border-color: var(--accent);}
  #encounterModalBg .info-text { white-space: pre-wrap;background: rgba(255,255,255,0.05);padding: 10px;border-radius: 5px;margin-bottom: 15px;border: 1px solid var(--border-dark);font-style: italic; }
  #encounterModalBg #encounterChoices button {display: block;width: 100%;margin-top: 10px;background: #444;}
  #encounterModalBg #encounterChoices button:hover {background: var(--accent);}
  #encounterModalBg .char-img-container { display: flex;justify-content: center;margin-bottom: 15px;height: 250px;width: 100%;overflow: hidden; }
  #encounterModalBg .char-img-container img { max-width: 100%; height: 100%; width: 100%; object-fit: cover; border-radius: 5px; box-shadow: 0 0 10px rgba(192, 57, 43, 0.5); }

  /* Item Use Modal **[ìˆ˜ì •]** ë²„íŠ¼ í•˜ë‹¨ ì •ë ¬ ë° ìˆ˜ì§ ë ˆì´ì•„ì›ƒ */
  #itemUseModalBg .modal { /* internal-modal-bgì˜ .modalì„ ìƒì†ë°›ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œë§Œ ìˆ˜ì • */
      min-width: 350px; 
      display: flex; 
      flex-direction: column; /* **[ìˆ˜ì •]** ìˆ˜ì§ ë ˆì´ì•„ì›ƒ */
  }
  #itemUseModalBg .modal h4 { border-bottom: none; }
  #itemUseModalBg .item-image { width: 80px; height: 80px; margin: 10px auto; display: block; }
  #itemUseModalBg .item-desc { 
      text-align: center; 
      margin-bottom: 10px; 
      flex-grow: 1; 
  }
  /* ë²„íŠ¼ì„ í•˜ë‹¨ ì¢Œ/ìš° ë°°ì¹˜ */
  #itemUseModalBg .modal > div:last-child {
      padding-top: 10px; 
      border-top: 1px solid var(--border-dark); 
      margin-top: 0;
      display: flex; 
      justify-content: space-between; /* **[ìˆ˜ì •]** ì¢Œìš° ë°°ì¹˜ */
      gap: 10px;
  }
  #itemUseModalBg .modal > div:last-child button {
       width: 50%; /* ë²„íŠ¼ í¬ê¸° ê· ë“± ë¶„ë°° */
  }
  
  /* Inventory Modal (ê´€ë¦¬ì ì¸ë²¤í† ë¦¬ íŒì—… - ê¸°ì¡´ ì™¸ë¶€ íŒì—… ìœ ì§€) */
  #inventoryModal .modal { min-width: 300px; max-height: 80vh; overflow-y: auto; }
  .inventory-admin-item { 
      display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed var(--border-dark);
  }
  .inventory-admin-item:last-child { border-bottom: none; }
  .inventory-admin-item button { 
      background: #550000; border-color: #770000; padding: 4px 8px; font-size: 11px;
      transition: opacity 0.2s;
  }
</style>
</head>
<body>
<audio id="bgmAudio" loop preload="auto"></audio>
<div id="topBar">
    <div id="bgmControls"> 
        <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" title="ë³¼ë¥¨">
        <button id="bgmToggleBtn">PLAY</button> 
    </div>
    <div id="topBarControls">
        <button id="playerLoginBtnTop">í”Œë ˆì´ì–´ ë¡œê·¸ì¸</button>
        <button id="adminBtn">ê´€ë¦¬ì</button>
    </div>
</div>

<div id="logChatPanel" class="side-panel">
    <div class="chat-controls">
        <button id="deleteAllChatBtn" title="ì±„íŒ… ì „ì²´ì‚­ì œ" style="background: #880000; border-color: #aa0000; display: none;">
            ğŸ—‘ï¸
        </button> 
        <div style="display: flex; align-items: center; flex-grow: 1;">
            <input type="text" id="chatNickname" placeholder="ë‹‰ë„¤ì„" value="íƒí—˜ê°€">
        </div>
    </div>
    <div id="logDisplay">
        <div class="log-item system">ì‹œìŠ¤í…œ: ë¡œê·¸/ì±„íŒ… ì‹œì‘.</div>
    </div>
    <div class="chat-input-group">
        <input type="text" id="chatInput" placeholder="ì±„íŒ… ì…ë ¥" disabled>
        <button id="sendChatBtn" disabled>ì „ì†¡</button>
    </div>
</div>

<div id="container">
  <canvas id="game" width="640" height="480"></canvas>
  <div id="grid"></div>
  <div id="dragGhost"></div> 
  
  <div class="internal-modal-bg" id="choiceResultPopupBg">
      <div class="modal">
          <h4 id="choiceResultTitle" style="margin-top:0; border-bottom: none;">ì„ íƒì§€ ê²°ê³¼</h4>
          <div class="info-text" id="choiceResultText" style="white-space: pre-wrap; margin-bottom: 15px; border: 1px solid var(--accent);"></div>
          <div style="margin-top:10px;text-align:right">
              <button id="closeChoiceResultPopup">ê³„ì† ì§„í–‰</button>
          </div>
      </div>
  </div>

  <div class="internal-modal-bg" id="encounterModalBg">
      <div class="modal" id="encounterModal">
          <div class="char-img-container" id="encCharImgContainer">
              <img id="encCharImg" alt="Encounter Character" style="display:none;"/>
          </div>
          <h4 id="encModalName"></h4>
          <div class="info-text" id="encModalText"></div>
          <div id="encounterChoices"></div>
          <div style="margin-top:20px;text-align:right"><button id="closeEncounterModal">ê³„ì† ì§„í–‰</button></div>
      </div>
  </div>
  
  <div class="internal-modal-bg" id="itemUseModalBg">
      <div class="modal" id="itemUseModal">
          <h4 id="itemUseName"></h4>
          <img id="itemUseImage" class="item-image" alt="Item Image"/>
          <div class="item-desc" id="itemUseDescription"></div>
          <div>
              <button id="useItemBtn" style="background: #2ecc71;">ì‚¬ìš©</button>
              <button id="closeItemUseModal">ë‹«ê¸°</button>
          </div>
      </div>
  </div>
</div>

<div id="statusInventoryPanel" class="side-panel">
    <div id="playerContent" style="display:none;"> 
        <h4>í”Œë ˆì´ì–´ ìƒíƒœ</h4>
        <div id="playerStatus">
            HP: <span id="playerHP">100</span>
        </div>
        <h4>ì¸ë²¤í† ë¦¬</h4>
        <div id="inventoryList">
        </div>
        <hr style="margin: 10px 0;">
        <p style="margin-bottom: 5px;"><strong>í˜„ì¬ ë§µ í”Œë ˆì´ì–´:</strong> (ì•„ì´í…œ ëª©ë¡ ì•„ë‹˜)</p>
        <div id="playerOnMapListPlayerMode">
             <div style="text-align: center; color: #aaa; font-size: 13px;">ë¡œë”© ì¤‘...</div>
        </div>
    </div>
    <div id="adminRightInfo" style="display:none; padding: 5px;">
        <h4>ê´€ë¦¬ì ì •ë³´</h4>
        <p><strong>í˜„ì¬ ë§µ:</strong> <span id="adminInfoMap">-</span></p>
        <p><strong>ë‚¨ì€ ì¡°ìš° ìˆ˜:</strong> <span id="adminInfoRemainingEnc">0</span></p>
        <hr>
        <p style="margin-bottom: 5px;"><strong>í˜„ì¬ ë§µ í”Œë ˆì´ì–´:</strong></p>
        <div id="playerOnMapList">
             <div style="text-align: center; color: #aaa; font-size: 13px;">í”Œë ˆì´ì–´ ì—†ìŒ</div>
        </div>
    </div>
</div>

<div id="adminPanel">
  <h4>
    <span>ê´€ë¦¬ì íŒ¨ë„</span>
    <button id="minimizeBtn" title="ìµœì†Œí™”/ë³µì›">[â€”]</button>
  </h4>
  
  <div class="admin-tabs">
    <button id="mapTabBtn" class="active">ë§µ ì„¤ì •</button>
    <button id="userTabBtn">ì‚¬ìš©ì ê´€ë¦¬</button>
    <button id="itemTabBtn">ì•„ì´í…œ ê´€ë¦¬</button>
  </div>
  
  <div id="mapTabContent" class="admin-tab-content active">
    <div class="row"><label>ë§µ ì´ë¦„</label><input id="mapName" type="text"><button id="saveMap">ë§µ ì €ì¥</button></div>
    <div class="row"><label>ë§µ ì´ë¯¸ì§€</label><input id="mapUrl" type="text" placeholder="ì´ë¯¸ì§€ URL"></div>
    <div class="row"><label>BGM URL</label><input id="bgmUrl" type="text" placeholder="ë°°ê²½ìŒì•… URL"></div> 
    <div class="row">
        <label>ì‹œì‘ ì¢Œí‘œ</label>
        <input id="startX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
        <input id="startY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
        <button id="setPlayerPos" style="flex-shrink: 0;">ì„¤ì •</button>
    </div>
    
    <div class="row">
        <label>ë§µ ì´ë™ ì¢Œí‘œ</label>
        <input id="transitionX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
        <input id="transitionY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
        <button id="setTransitionPos" style="flex-shrink: 0;">ì„¤ì •</button>
    </div>
    <div class="row"><label>ì´ë™í•  ë§µ</label><input id="nextMapName" type="text" placeholder="í´ë¦¬ì–´ ì‹œ ì´ë™í•  ë§µ ì´ë¦„"></div>

    <div class="control-group"> 
      <button id="reload">ë¡œë“œ</button>
      <button id="toggleGrid">ê·¸ë¦¬ë“œ</button>
      <button id="toggleEncounter">ì¡°ìš° ì¶”ê°€</button> 
      <button id="toggleImpassable">ì œí•œ ì¶”ê°€</button> 
    </div>
    
    <hr>
    
    <p style="text-align: center; color: #999; font-size: 13px;">ë§µ ìƒì˜ ì¡°ìš° ë° ì´ë™ ì œí•œ êµ¬ì—­ì„ **í´ë¦­**í•˜ì—¬ ìˆ˜ì •/ì‚­ì œí•©ë‹ˆë‹¤.</p>
    
    <div id="mapButtons" style="margin-top:10px;">
        <div class="row"> 
            </div>
        <hr style="margin: 10px 0;">
        <div class="row"> 
            <button id="deleteAndInitMapBtn" style="background: #e74c3c; border-color: #c0392b;">ë§µ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <hr>
    <h5>ì €ì¥ëœ ë§µ ëª©ë¡ (í´ë¦­ ë¡œë“œ)</h5>
    <div class="list-container" id="mapListContainer">
        </div>
  </div>
  
  <div id="userTabContent" class="admin-tab-content">
    <h5>í”Œë ˆì´ì–´ ê³„ì • ê´€ë¦¬</h5>
    <div class="row">
      <input type="text" id="newUserId" placeholder="ìƒˆ í”Œë ˆì´ì–´ ID">
      <input type="text" id="newUserCharUrl" placeholder="ìºë¦­í„° ì´ë¯¸ì§€ URL">
      <button id="addPlayerBtn">ìƒì„±</button>
    </div>
    <div class="list-container" id="userList"></div>
    
    <h5 style="margin-top: 15px;">í”Œë ˆì´ì–´ ìƒíƒœ ê´€ë¦¬</h5>
    <div class="row">
        <select id="selectPlayerId" style="flex-grow: 1;"></select>
        <input type="number" id="playerHpInput" placeholder="HP" style="width: 50px;">
        <button id="updatePlayerStatusBtn">ìƒíƒœ ì €ì¥</button>
    </div>

    <h5 style="margin-top: 15px;">í”Œë ˆì´ì–´ ë§µ/ìœ„ì¹˜ ê´€ë¦¬</h5>
    <div class="row">
        <select id="selectPlayerIdMap" style="flex-grow: 1;"></select>
        <input type="text" id="playerMapInput" placeholder="ë§µ ì´ë¦„">
        <input type="number" id="playerXInput" placeholder="X" min="0" style="width: 50px;">
        <input type="number" id="playerYInput" placeholder="Y" min="0" style="width: 50px;">
        <button id="updatePlayerMapBtn">ìœ„ì¹˜ ì €ì¥</button>
    </div>

    <h5 style="margin-top: 15px;">ì•„ì´í…œ ì§ì ‘ ì§€ê¸‰</h5>
    <div class="row">
        <select id="giveItemPlayerSelect" style="flex-grow: 1;"></select>
        <select id="giveItemSelect" style="width: 120px;"></select>
        <button id="giveItemBtn">ì§€ê¸‰</button>
    </div>
  </div>

  <div id="itemTabContent" class="admin-tab-content">
    <h5>ì•„ì´í…œ ì •ì˜ ê´€ë¦¬</h5>
    <div class="row">
      <input type="text" id="newItemId" placeholder="ì•„ì´í…œ ID (ê³ ìœ )">
      <input type="text" id="newItemName" placeholder="ì•„ì´í…œ ì´ë¦„">
    </div>
    <div class="row">
        <input type="text" id="newItemImageUrl" placeholder="ì´ë¯¸ì§€ URL">
        <input type="number" id="newItemHpRecover" placeholder="HP íšŒë³µëŸ‰ (0ì´ë©´ ì‚¬ìš© ë¶ˆê°€)" min="0" value="0" style="width: 80px;"> <button id="addItemBtn" style="flex-shrink: 0;">ë“±ë¡</button>
    </div>
    <textarea id="newItemDescription" placeholder="ì•„ì´í…œ ì„¤ëª…" rows="2"></textarea>
    <div class="list-container" id="itemList"></div>
  </div>
</div>

<div class="modal-bg" id="loginBox">
  <div class="modal">
    <div>ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button id="loginBtn">ë¡œê·¸ì¸</button>
  </div>
</div>

<div class="modal-bg" id="playerLoginBox">
    <div class="modal">
      <div>í”Œë ˆì´ì–´ ë¡œê·¸ì¸</div>
      <input type="text" id="playerIdInput" placeholder="ì•„ì´ë”” ì…ë ¥">
      <button id="playerLoginBtnSubmit">ë¡œê·¸ì¸</button>
    </div>
</div>

<div class="modal-bg" id="editModal">
  <div class="modal">
    <h4>ì¡°ìš° ìˆ˜ì •</h4>
    <label>ì´ë¦„</label><input id="encName" type="text">
    <label>ì§€ë¬¸</label><textarea id="encText" placeholder="ì¡°ìš° ì‹œ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì¼ ì§€ë¬¸" rows="3"></textarea>
    
    <label>íšë“ ì•„ì´í…œ ID (ì„ íƒ)</label>
    <select id="encItemIdSelect" style="margin-bottom: 5px;"></select>
    <input id="encItemIdManual" type="text" placeholder="ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìƒˆë¡œìš´ ì•„ì´í…œ ID" style="display:none;">
    <input type="checkbox" id="encItemIdManualCheck"><label for="encItemIdManualCheck" style="display: inline-block; font-weight: normal; margin-left: 5px; color: #aaa;">ì§ì ‘ ì…ë ¥/ì—†ëŠ” ì•„ì´í…œ</label>

    <label>ìºë¦­í„° ì´ë¯¸ì§€ URL</label><input id="encCharUrl" type="text" placeholder="ì¡°ìš° ì‹œ ë„ìš¸ ì´ë¯¸ì§€ URL">
    
    <label id="choicesLabel">ì„ íƒì§€</label> <div id="choices"></div>
    <div id="addChoiceContainer" style="text-align: right;"><button id="addChoice">ì„ íƒì§€ ì¶”ê°€</button></div>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ ì‚¬ìš©)</label>
    <select id="encTrigger">
        <option value="none">ì—†ìŒ</option>
        <option value="sound">ì‚¬ìš´ë“œ</option>
        <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
        <option value="map">ë§µ ì „í™˜</option>
    </select>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° ë°ì´í„°(URL/ë§µëª…)</label><input id="encData" type="text">
    
    <div style="margin-top:20px; text-align:right; display: flex; justify-content: space-between; align-items: center;"> 
        <button id="deleteEncEdit" style="background: #e74c3c; border-color: #c0392b; font-size: 18px; line-height: 1; padding: 6px 10px;">
            ğŸ—‘ï¸
        </button>
        <div>
            <button id="saveEncEdit">ì €ì¥</button>
            <button id="closeEncEdit">ë‹«ê¸°</button>
        </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="inventoryModal">
  <div class="modal">
    <h4 id="inventoryModalTitle">í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬</h4>
    <div class="list-container" id="inventoryModalList"> 
    </div>
    <div style="margin-top:10px;text-align:right"> 
        <button id="closeInventoryModal">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script type="module"> 
/* Firebase + ì•± ë¡œì§ í†µí•© */
// NOTE: Please replace with your actual Firebase configuration
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, getDocs, onSnapshot, updateDoc, arrayUnion, arrayRemove, where, orderBy, limit, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtPPF9Y93XVKHjo5_mmmxycf0CUJjWIRo", // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ í‚¤ë¡œ ë³€ê²½í•˜ì„¸ìš”
    authDomain: "horror-game-14aa8.firebaseapp.com",
    projectId: "horror-game-14aa8",
    storageBucket: "horror-game-14aa8.firebasestorage.app",
    messagingSenderId: "125297141331",
    appId: "1:125299141331:web:a15f971c34dde0c7d708a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_EMAIL = "test@gmail.com"; // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
const ADMIN_DUMMY_PW = "testpassword"; // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”

const GRID = 32;
const MAX_HP = 100;

/* --- State Variables --- */
// **[ìˆ˜ì •]** encountered í•„ë“œ ì¶”ê°€ (Key: x_y string)
let player = { 
    id: null, // í”Œë ˆì´ì–´ ID ì¶”ê°€ 
    x: 0, 
    y: 0, 
    hp: MAX_HP, 
    charUrl: '', 
    inventory: {}, 
    encountered: {} 
}; 
let currentMapName = 'default';
let encounterPoints = []; // [{x, y, data: {...}}]
let impassablePoints = []; // [{x, y}]
let mapData = { 
    url: '', 
    spriteUrl: '', 
    bgmUrl: '', 
    startX: 0, 
    startY: 0, 
    transitionX: null, 
    transitionY: null, 
    nextMapName: '' 
};
let isGridMode = false;
let isEncounterMode = false;
let isImpassableMode = false;
let dragStartPoint = null;
let currentEdit = null; // Currently selected encounter point for editing
let itemDefinitions = {}; // {itemId: {name, imageUrl, hpRecover, description}}
let loggedInUserId = null;
let playerMode = false;
let currentSelectedItem = null; // Item ID for itemUseModal
let adminMode = false;
let chatUnsub = null;
// {userId: {hp, currentMap, x, y, charUrl, inventory, encountered, lastChatTime}} **[ìˆ˜ì •]** encountered, lastChatTime ì¶”ê°€
let usersData = {}; 
let characterImage = new Image();
let mapImage = new Image();
let mapLoaded = false;
let isMoving = false;
let isEncountering = false;
let animationFrameId = null;


/* --- UI Bindings (Explicitly defined to fix ReferenceError) --- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const logDisplay = document.getElementById('logDisplay');
const bgmAudio = document.getElementById('bgmAudio');
const bgmToggleBtn = document.getElementById('bgmToggleBtn');
const bgmVolume = document.getElementById('bgmVolume');
const playerHPDisplay = document.getElementById('playerHP');

// Main Game/Admin
const container = document.getElementById('container');
const adminPanel = document.getElementById('adminPanel');
const mapNameInput = document.getElementById('mapName');
const mapUrlInput = document.getElementById('mapUrl');
const bgmUrlInput = document.getElementById('bgmUrl');
const startXInput = document.getElementById('startX');
const startYInput = document.getElementById('startY');
const transitionXInput = document.getElementById('transitionX');
const transitionYInput = document.getElementById('transitionY');
const nextMapNameInput = document.getElementById('nextMapName');
const adminBtn = document.getElementById('adminBtn');

// Admin Modals (Encounter Edit)
const editModal = document.getElementById('editModal');
const encNameInput = document.getElementById('encName');
const encTextInput = document.getElementById('encText');
const encCharUrlInput = document.getElementById('encCharUrl');
const encTriggerSelect = document.getElementById('encTrigger');
const encDataInput = document.getElementById('encData');
const encItemIdSelect = document.getElementById('encItemIdSelect');
const encItemIdManual = document.getElementById('encItemIdManual');
const encItemIdManualCheck = document.getElementById('encItemIdManualCheck');
const choicesDiv = document.getElementById('choices');

// Player Modals (Encounter/Item)
const encounterModalBg = document.getElementById('encounterModalBg'); // **[ìˆ˜ì •]** ë‚´ë¶€ íŒì—…
const encModalName = document.getElementById('encModalName');
const encModalText = document.getElementById('encModalText');
const encCharImg = document.getElementById('encCharImg');
const encCharImgContainer = document.getElementById('encCharImgContainer');
const encounterChoicesDiv = document.getElementById('encounterChoices');
const closeEncounterModalBtn = document.getElementById('closeEncounterModal');

const itemUseModalBg = document.getElementById('itemUseModalBg'); // **[ìˆ˜ì •]** ë‚´ë¶€ íŒì—…
const itemUseName = document.getElementById('itemUseName');
const itemUseImage = document.getElementById('itemUseImage');
const itemUseDescription = document.getElementById('itemUseDescription');
const useItemBtn = document.getElementById('useItemBtn');
const closeItemUseModalBtn = document.getElementById('closeItemUseModal');

// **[ì¶”ê°€]** ì„ íƒì§€ ê²°ê³¼ ë‚´ë¶€ íŒì—…
const choiceResultPopupBg = document.getElementById('choiceResultPopupBg'); 
const choiceResultTitle = document.getElementById('choiceResultTitle');
const choiceResultText = document.getElementById('choiceResultText');
const closeChoiceResultPopupBtn = document.getElementById('closeChoiceResultPopup');

// Panels
const statusInventoryPanel = document.getElementById('statusInventoryPanel');
const playerContentDiv = document.getElementById('playerContent');
const inventoryListDiv = document.getElementById('inventoryList');
const adminRightInfoDiv = document.getElementById('adminRightInfo');
const playerOnMapListDiv = document.getElementById('playerOnMapList');
// **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œ ë§µ í”Œë ˆì´ì–´ ëª©ë¡
const playerOnMapListPlayerModeDiv = document.getElementById('playerOnMapListPlayerMode'); 


/* --- Utility Functions --- */

/**
 * ë¡œê·¸/ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
 * @param {string} text í‘œì‹œí•  í…ìŠ¤íŠ¸
 * @param {string} type ë©”ì‹œì§€ íƒ€ì… ('system', 'item', 'admin', 'chat')
 */
const addLogItem = (text, type = 'chat') => {
    const item = document.createElement('div');
    item.className = `log-item ${type}`;
    item.innerHTML = text; // HTMLì„ í—ˆìš©í•˜ì—¬ ë³¼ë“œì²´ ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•¨
    logDisplay.appendChild(item);
    logDisplay.scrollTop = logDisplay.scrollHeight;
};

/**
 * **[ìˆ˜ì •]** ì±„íŒ… ë©”ì‹œì§€ì˜ ì‹œê°„ í˜•ì‹ì„ ìš”ì²­ì— ë§ê²Œ í¬ë§·í•©ë‹ˆë‹¤.
 * @param {firebase.firestore.Timestamp} timestamp ë©”ì‹œì§€ì˜ ì„œë²„ íƒ€ì„ìŠ¤íƒ¬í”„
 * @returns {string} í¬ë§·ëœ ì‹œê°„ ë¬¸ìì—´
 */
const formatChatTimestamp = (timestamp) => {
    if (!timestamp || typeof timestamp.toDate !== 'function') return '';

    const now = new Date();
    const msgDate = timestamp.toDate();
    const diffInSeconds = Math.floor((now - msgDate) / 1000);
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    const diffInHours = Math.floor(diffInMinutes / 60);
    
    // YYYY-MM-DD HH:MM í˜•ì‹
    const yyyy = msgDate.getFullYear();
    const mm = String(msgDate.getMonth() + 1).padStart(2, '0');
    const dd = String(msgDate.getDate()).padStart(2, '0');
    const hh = String(msgDate.getHours()).padStart(2, '0');
    const min = String(msgDate.getMinutes()).padStart(2, '0');

    if (diffInMinutes < 60) {
        // 1ì‹œê°„ ë¯¸ë§Œ: ë¶„ ë‹¨ìœ„ (1m)
        return `(${Math.max(1, diffInMinutes)}m)`; // ìµœì†Œ 1ë¶„ í‘œì‹œ
    } else if (diffInHours < 24) {
        // 24ì‹œê°„ ë¯¸ë§Œ: ì‹œê°„ ë‹¨ìœ„ (2h)
        return `(${diffInHours}h)`;
    } else {
        // 24ì‹œê°„ ì´ìƒ: ì „ì²´ ë‚ ì§œ/ì‹œê°„ (2025-10-23 02:38)
        return `(${yyyy}-${mm}-${dd} ${hh}:${min})`;
    }
};


/**
 * ì±„íŒ… ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ë Œë”ë§í•©ë‹ˆë‹¤.
 * @param {Object} message ë©”ì‹œì§€ ê°ì²´ (id, nickname, text, timestamp, isAdmin)
 */
const renderChat = (message) => {
    const item = document.createElement('div');
    item.className = `chat-item ${message.isAdmin ? 'admin' : ''}`;
    
    // **[ì‚­ì œ ì ìš©]** ë‚ ì§œê°€ ë°”ë€Œë©´ ë‚ ì§œë¥¼ ë„ìš°ëŠ” ë¡œì§ì„ ì œê±°
    
    const timestampStr = formatChatTimestamp(message.timestamp); // **[ìˆ˜ì • ì ìš©]** ìƒˆë¡œìš´ ì‹œê°„ í¬ë§· ì ìš©

    item.innerHTML = `
        <span class="chat-id">${message.nickname}</span>: 
        <span class="chat-text">${message.text}</span>
        <span class="chat-time" style="color:#777; font-size:11px; margin-left:5px;">${timestampStr}</span>
        ${adminMode ? `<span class="admin-actions"><button onclick="window.deleteChatMessage('${message.id}')" class="del">ì‚­ì œ</button></span>` : ''}
    `;
    logDisplay.appendChild(item);
    logDisplay.scrollTop = logDisplay.scrollHeight;
};

/* --- Firebase Interactions --- */

/**
 * í”Œë ˆì´ì–´ì˜ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œì„ ì œê±°í•˜ê±°ë‚˜ ìˆ˜ëŸ‰ì„ ì¤„ì…ë‹ˆë‹¤.
 * @param {string} playerId ëŒ€ìƒ í”Œë ˆì´ì–´ ID
 * @param {string} itemId ì•„ì´í…œ ID
 * @param {number} quantity ì œê±°í•  ìˆ˜ëŸ‰
 */
const removeItemFromPlayer = async (playerId, itemId, quantity) => {
    if (!usersData[playerId] || usersData[playerId].inventory[itemId] === undefined) {
        console.warn(`[DB Error] Player ${playerId} does not have item ${itemId}`);
        return;
    }

    const playerRef = doc(db, 'users', playerId);

    try {
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerRef);
            if (!playerDoc.exists()) {
                throw "Player Document does not exist!";
            }
            
            const currentInventory = playerDoc.data().inventory || {};
            const currentQuantity = currentInventory[itemId] || 0;
            const newQuantity = Math.max(0, currentQuantity - quantity);

            if (newQuantity <= 0) {
                // ìˆ˜ëŸ‰ì´ 0 ì´í•˜ë©´ ì¸ë²¤í† ë¦¬ì—ì„œ ì•„ì´í…œ í•„ë“œë¥¼ ì™„ì „íˆ ì œê±°
                delete currentInventory[itemId];
            } else {
                // ìˆ˜ëŸ‰ë§Œ ì—…ë°ì´íŠ¸
                currentInventory[itemId] = newQuantity;
            }

            transaction.update(playerRef, { inventory: currentInventory });
            
            // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë©´ í•„ìš” ì—†ì„ ìˆ˜ ìˆì§€ë§Œ ì•ˆì „ ì¥ì¹˜)
            if(usersData[playerId]) usersData[playerId].inventory = currentInventory;
            if(playerId === player.id) player.inventory = currentInventory;

            addLogItem(`ì‹œìŠ¤í…œ: **${playerId}**ì˜ ì¸ë²¤í† ë¦¬ì—ì„œ **[${itemDefinitions[itemId]?.name || itemId}]** ${quantity}ê°œê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. (ë‚¨ì€ ìˆ˜ëŸ‰: ${newQuantity})`, 'system');

        });
    } catch (e) {
        console.error("ì•„ì´í…œ ì œê±° íŠ¸ëœì­ì…˜ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ì œê±° ì‹¤íŒ¨ - ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'system');
    }
};

/**
 * í”Œë ˆì´ì–´ì—ê²Œ ì•„ì´í…œì„ ì§€ê¸‰í•©ë‹ˆë‹¤.
 * @param {string} playerId ëŒ€ìƒ í”Œë ˆì´ì–´ ID
 * @param {string} itemId ì•„ì´í…œ ID
 * @param {number} quantity ì§€ê¸‰í•  ìˆ˜ëŸ‰
 */
const giveItemToPlayer = async (playerId, itemId, quantity = 1) => {
    if (!itemDefinitions[itemId]) {
        addLogItem(`ì‹œìŠ¤í…œ: ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ ID [${itemId}]`, 'system');
        return;
    }
    
    const playerRef = doc(db, 'users', playerId);

    try {
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerRef);
            if (!playerDoc.exists()) {
                throw "Player Document does not exist!";
            }
            
            const currentInventory = playerDoc.data().inventory || {};
            const currentQuantity = currentInventory[itemId] || 0;
            const newQuantity = currentQuantity + quantity;

            currentInventory[itemId] = newQuantity;

            transaction.update(playerRef, { inventory: currentInventory });
            
            // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            if(usersData[playerId]) usersData[playerId].inventory = currentInventory;
            if(playerId === player.id) player.inventory = currentInventory;

            addLogItem(`ì‹œìŠ¤í…œ: **${playerId}**ì—ê²Œ ì•„ì´í…œ **[${itemDefinitions[itemId].name}]** ${quantity}ê°œê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. (ì´ ìˆ˜ëŸ‰: ${newQuantity})`, 'item');

        });
    } catch (e) {
        console.error("ì•„ì´í…œ ì§€ê¸‰ íŠ¸ëœì­ì…˜ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ì§€ê¸‰ ì‹¤íŒ¨ - ${e.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`, 'system');
    }
};

const updatePlayerStatus = async (status) => {
    if (!player.id) return;
    try {
        const playerRef = doc(db, 'users', player.id);
        await updateDoc(playerRef, status);
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™” (onSnapshot)ì—ì„œ ì²˜ë¦¬ë  ìˆ˜ ìˆìœ¼ë‚˜,
        // ì¦‰ê°ì ì¸ í”¼ë“œë°±ì„ ìœ„í•´ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        Object.assign(player, status);
        updatePlayerUI(true);
    } catch (e) {
        console.error("í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ - ${e.message}`, 'system');
    }
};

const sendChatMessage = async (text, isAdmin = false) => {
    if (text.trim() === "") return;
    try {
        const docRef = await addDoc(collection(db, 'chat'), {
            nickname: isAdmin ? 'ADMIN' : (player.id || 'íƒí—˜ê°€'),
            text: text,
            timestamp: serverTimestamp(),
            isAdmin: isAdmin
        });
        document.getElementById('chatInput').value = '';
    } catch (e) {
        console.error("ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨ - ${e.message}`, 'system');
    }
};

const deleteChatMessage = async (chatId) => {
    if (!adminMode) return;
    if (confirm("ì •ë§ë¡œ ì´ ì±„íŒ… ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        try {
            await deleteDoc(doc(db, 'chat', chatId));
            addLogItem(`ì‹œìŠ¤í…œ: ì±„íŒ… ë©”ì‹œì§€ (${chatId}) ì‚­ì œë¨.`, 'system');
            // ì±„íŒ… ë¦¬ìŠ¤ë„ˆê°€ í™”ë©´ì„ ê°±ì‹ í•  ê²ƒì„
        } catch (e) {
            console.error("ì±„íŒ… ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ì±„íŒ… ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨ - ${e.message}`, 'system');
        }
    }
};
window.deleteChatMessage = deleteChatMessage; // HTMLì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì „ì—­ ì„¤ì •

const deleteAllChatMessages = async () => {
    if (!adminMode) return;
    if (confirm("ì •ë§ë¡œ ëª¨ë“  ì±„íŒ… ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
        try {
            const q = query(collection(db, 'chat'));
            const snapshot = await getDocs(q);
            const batch = db.batch();
            
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            addLogItem(`ì‹œìŠ¤í…œ: ëª¨ë“  ì±„íŒ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        } catch (e) {
            console.error("ëª¨ë“  ì±„íŒ… ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ëª¨ë“  ì±„íŒ… ë©”ì‹œì§€ ì‚­ì œ ì‹¤íŒ¨ - ${e.message}`, 'system');
        }
    }
};

const startChatListener = () => {
    if (chatUnsub) chatUnsub(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ í•´ì œ

    const chatCollectionRef = collection(db, 'chat');
    // **[ìˆ˜ì •]** ì±„íŒ… ë¦¬ìŠ¤ë„ˆì—ì„œ ë‚ ì§œ ë³€ê²½ ë¡œì§ì€ ì œê±°í•˜ê³ , ì‹œê°„ ìˆœì„œë¡œ ê°€ì ¸ì˜´
    const q = query(chatCollectionRef, orderBy('timestamp')); 

    chatUnsub = onSnapshot(q, (snapshot) => {
        logDisplay.innerHTML = '<div class="log-item system">ì‹œìŠ¤í…œ: ë¡œê·¸/ì±„íŒ… ì‹œì‘.</div>';
        snapshot.docs.forEach(doc => {
            const message = { id: doc.id, ...doc.data() };
            renderChat(message);
        });
    });
};

const stopChatListener = () => {
    if (chatUnsub) {
        chatUnsub();
        chatUnsub = null;
        addLogItem("ì‹œìŠ¤í…œ: ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ì¤‘ì§€.", 'system');
    }
};

// ë§µ ë°ì´í„° ì €ì¥ (ê´€ë¦¬ì)
const saveMapDataToFirestore = async () => {
    if (!adminMode || !currentMapName) return;

    const data = {
        url: mapData.url,
        bgmUrl: mapData.bgmUrl,
        startX: parseInt(startXInput.value) || 0,
        startY: parseInt(startYInput.value) || 0,
        transitionX: parseInt(transitionXInput.value) || null,
        transitionY: parseInt(transitionYInput.value) || null,
        nextMapName: nextMapNameInput.value.trim(),
        encounters: encounterPoints.map(p => ({ x: p.x, y: p.y, data: p.data })),
        impassable: impassablePoints.map(p => ({ x: p.x, y: p.y }))
    };

    try {
        await setDoc(doc(db, 'maps', currentMapName), data);
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ **[${currentMapName}]**ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        reloadMapList();
    } catch (e) {
        console.error("ë§µ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨ - ${e.message}`, 'system');
    }
};

// ë§µ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
const loadMapDataFromFirestore = async (mapName) => {
    try {
        const mapDoc = await getDoc(doc(db, 'maps', mapName));
        if (mapDoc.exists()) {
            const data = mapDoc.data();
            currentMapName = mapName;
            
            mapData.url = data.url || '';
            mapData.bgmUrl = data.bgmUrl || '';
            mapData.startX = data.startX || 0;
            mapData.startY = data.startY || 0;
            mapData.transitionX = data.transitionX === undefined ? null : data.transitionX;
            mapData.transitionY = data.transitionY === undefined ? null : data.transitionY;
            mapData.nextMapName = data.nextMapName || '';
            
            encounterPoints = (data.encounters || []).map(e => ({ x: e.x, y: e.y, data: e.data }));
            impassablePoints = (data.impassable || []).map(i => ({ x: i.x, y: i.y }));

            mapImage.src = mapData.url;
            mapImage.onload = () => {
                mapLoaded = true;
                draw();
            };
            mapImage.onerror = () => {
                 mapLoaded = false;
                 draw();
                 addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${mapData.url}`, 'system');
            };

            if (adminMode) updateAdminMapUI();
            
            if (playerMode) {
                // í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œëŠ” í˜„ì¬ ìœ„ì¹˜ë¥¼ ì—…ë°ì´íŠ¸ (ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™)
                await updatePlayerStatus({ 
                    currentMap: currentMapName, 
                    x: mapData.startX, 
                    y: mapData.startY 
                });
                player.x = mapData.startX;
                player.y = mapData.startY;
            }

            // BGM ë³€ê²½
            if (bgmAudio.src !== mapData.bgmUrl && mapData.bgmUrl) {
                 bgmAudio.src = mapData.bgmUrl;
                 bgmAudio.load();
                 bgmAudio.play().catch(e => console.log("BGM ìë™ ì¬ìƒ ì‹¤íŒ¨: ", e));
                 bgmToggleBtn.textContent = 'PAUSE';
            } else if (!mapData.bgmUrl) {
                 bgmAudio.pause();
                 bgmAudio.src = '';
                 bgmToggleBtn.textContent = 'PLAY';
            }

            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **[${mapName}]**ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
            return true;
        } else {
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **[${mapName}]** ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'system');
            return false;
        }
    } catch (e) {
        console.error("ë§µ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ - ${e.message}`, 'system');
        return false;
    }
};

const deleteMapDataFromFirestore = async (mapName) => {
    if (!adminMode) return;
    if (confirm(`ì •ë§ë¡œ ë§µ **[${mapName}]**ì˜ ë°ì´í„°ì™€ ëª¨ë“  ì¡°ìš°/ì œí•œ êµ¬ì—­ì„ ì‚­ì œí•˜ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        try {
            await deleteDoc(doc(db, 'maps', mapName));
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **[${mapName}]** ë°ì´í„°ê°€ ì‚­ì œë˜ê³  ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
            
            // í˜„ì¬ ë§µì´ ì‚­ì œëœ ë§µì´ë©´ 'default'ë¡œ ë¦¬ë¡œë“œ
            if (currentMapName === mapName) {
                mapNameInput.value = 'default';
                await loadMapDataFromFirestore('default');
            }
            reloadMapList();
        } catch (e) {
            console.error("ë§µ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ë°ì´í„° ì‚­ì œ ì‹¤íŒ¨ - ${e.message}`, 'system');
        }
    }
};

// ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ê´€ë¦¬ì ì „ìš©)
const fetchAllUsers = async (updateUI = false) => {
    try {
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const newUsersData = {};
        
        usersSnapshot.forEach(doc => {
            newUsersData[doc.id] = { id: doc.id, ...doc.data() };
        });

        usersData = newUsersData;
        
        if (updateUI && adminMode) {
            updateAdminUserList();
            updateAdminPlayerOnMapList(); // **[ìˆ˜ì •]** ë§µ í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹ 
            // **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œ ë§µ í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹ 
            if (playerMode) updatePlayerOnMapListPlayerMode(); 
        }

    } catch (e) {
        console.error("ëª¨ë“  ì‚¬ìš©ì ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ", e);
    }
    return usersData;
};


// ëª¨ë“  ì•„ì´í…œ ì •ì˜ ë¶ˆëŸ¬ì˜¤ê¸°
const fetchAllItems = async (updateUI = false) => {
    try {
        const itemsSnapshot = await getDocs(collection(db, 'item_definitions'));
        const newItems = {};
        
        itemsSnapshot.forEach(doc => {
            newItems[doc.id] = { id: doc.id, ...doc.data() };
        });

        itemDefinitions = newItems;

        if (updateUI && adminMode) {
            updateAdminItemList();
            updateEncItemIdSelect(); // ì¡°ìš° ìˆ˜ì • ëª¨ë‹¬ ì•„ì´í…œ ëª©ë¡ ê°±ì‹ 
            updateGiveItemSelect(); // ì•„ì´í…œ ì§€ê¸‰ ëª©ë¡ ê°±ì‹ 
        }
    } catch (e) {
        console.error("ëª¨ë“  ì•„ì´í…œ ì •ì˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ", e);
    }
    return itemDefinitions;
};

// ë§µ ë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ê´€ë¦¬ì)
const reloadMapList = async () => {
    if (!adminMode) return;
    const mapListContainer = document.getElementById('mapListContainer');
    mapListContainer.innerHTML = '';
    
    try {
        const mapsSnapshot = await getDocs(collection(db, 'maps'));
        mapsSnapshot.forEach(doc => {
            const mapName = doc.id;
            const item = document.createElement('div');
            item.className = 'map-list-item';
            item.innerHTML = `
                <span>${mapName}</span>
                <button onclick="window.loadMapData('${mapName}')">ë¡œë“œ</button>
            `;
            mapListContainer.appendChild(item);
        });
        if (mapsSnapshot.empty) {
            mapListContainer.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ì €ì¥ëœ ë§µì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    } catch (e) {
        console.error("ë§µ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ", e);
    }
};
window.loadMapData = loadMapDataFromFirestore; // HTMLì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì „ì—­ ì„¤ì •


/* --- UI Update Functions (Admin) --- */

const updateAdminUI = (isAdminLoggedIn) => {
    adminMode = isAdminLoggedIn;
    adminBtn.textContent = isAdminLoggedIn ? 'ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ' : 'ê´€ë¦¬ì';
    adminPanel.style.display = isAdminLoggedIn ? 'block' : 'none';
    
    // ì˜¤ë¥¸ìª½ íŒ¨ë„ ê´€ë¦¬ì ì •ë³´ í‘œì‹œ/ìˆ¨ê¹€
    adminRightInfoDiv.style.display = isAdminLoggedIn ? 'flex' : 'none';
    
    // ì±„íŒ… UI ì—…ë°ì´íŠ¸ (ì‚­ì œ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€)
    document.getElementById('deleteAllChatBtn').style.display = isAdminLoggedIn ? 'flex' : 'none';
    
    // í”Œë ˆì´ì–´ ëª¨ë“œê°€ ì•„ë‹ˆë©´ì„œ ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œë§Œ adminRightInfoë¥¼ í‘œì‹œ
    if (!playerMode && isAdminLoggedIn) {
        statusInventoryPanel.style.display = 'flex';
        playerContentDiv.style.display = 'none';
        adminRightInfoDiv.style.display = 'flex';
        updateAdminMapUI();
        updateAdminPlayerOnMapList();
    } else if (playerMode && isAdminLoggedIn) {
        // í”Œë ˆì´ì–´ ëª¨ë“œ + ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œ: í”Œë ˆì´ì–´ UI ìš°ì„ 
        statusInventoryPanel.style.display = 'flex';
        playerContentDiv.style.display = 'flex';
        adminRightInfoDiv.style.display = 'none';
    } else if (!playerMode && !isAdminLoggedIn) {
        // ë‘˜ ë‹¤ ë¡œê·¸ì•„ì›ƒ ì‹œ: ì˜¤ë¥¸ìª½ íŒ¨ë„ ìˆ¨ê¹€
        statusInventoryPanel.style.display = 'none';
    }
    
    reloadMapList();
    if (isAdminLoggedIn) {
        fetchAllItems(true);
        fetchAllUsers(true);
    }
};

const updateAdminMapUI = () => {
    if (!adminMode) return;
    mapNameInput.value = currentMapName;
    mapUrlInput.value = mapData.url;
    bgmUrlInput.value = mapData.bgmUrl;
    startXInput.value = mapData.startX;
    startYInput.value = mapData.startY;
    transitionXInput.value = mapData.transitionX === null ? '' : mapData.transitionX;
    transitionYInput.value = mapData.transitionY === null ? '' : mapData.transitionY;
    nextMapNameInput.value = mapData.nextMapName;
    
    document.getElementById('adminInfoMap').textContent = currentMapName;
    document.getElementById('adminInfoRemainingEnc').textContent = encounterPoints.length;

    draw(); // ë§µ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë  ë•Œë§ˆë‹¤ ë‹¤ì‹œ ê·¸ë¦¼
};

const updateAdminUserList = () => {
    if (!adminMode) return;
    const userListDiv = document.getElementById('userList');
    userListDiv.innerHTML = '';
    
    const selectPlayerId = document.getElementById('selectPlayerId');
    const selectPlayerIdMap = document.getElementById('selectPlayerIdMap');
    const giveItemPlayerSelect = document.getElementById('giveItemPlayerSelect');
    
    selectPlayerId.innerHTML = '<option value="">-- ì„ íƒ --</option>';
    selectPlayerIdMap.innerHTML = '<option value="">-- ì„ íƒ --</option>';
    giveItemPlayerSelect.innerHTML = '<option value="">-- ì„ íƒ --</option>';

    Object.values(usersData).forEach(user => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML = `
            <span>${user.id} (${user.hp} HP / ${user.currentMap || '-'})</span>
            <div>
                <button onclick="window.showUserInventory('${user.id}')">ì¸ë²¤</button>
                <button onclick="window.deleteUser('${user.id}')" class="del">ì‚­ì œ</button>
            </div>
        `;
        userListDiv.appendChild(item);
        
        const option1 = new Option(`${user.id} (${user.hp} HP)`, user.id);
        const option2 = new Option(`${user.id} (${user.currentMap || '-'})`, user.id);
        const option3 = new Option(user.id, user.id);
        selectPlayerId.appendChild(option1);
        selectPlayerIdMap.appendChild(option2);
        giveItemPlayerSelect.appendChild(option3);
    });

    if (Object.keys(usersData).length === 0) {
        userListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ë“±ë¡ëœ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
};

const updateAdminPlayerOnMapList = () => {
    if (!adminMode) return;
    playerOnMapListDiv.innerHTML = '';
    
    const playersOnMap = Object.values(usersData).filter(user => user.currentMap === currentMapName);

    if (playersOnMap.length === 0) {
        playerOnMapListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">í”Œë ˆì´ì–´ ì—†ìŒ</div>';
        return;
    }

    playersOnMap.forEach(user => {
        const item = document.createElement('div');
        item.className = 'player-on-map-item';
        item.innerHTML = `
            <strong>${user.id}</strong> (HP: ${user.hp})
            <small>(${user.x}, ${user.y})</small>
        `;
        playerOnMapListDiv.appendChild(item);
    });
};

const updateAdminItemList = () => {
    if (!adminMode) return;
    const itemListDiv = document.getElementById('itemList');
    itemListDiv.innerHTML = '';
    
    Object.values(itemDefinitions).forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'list-item';
        itemElement.innerHTML = `
            <span title="${item.description}">
                <strong>${item.name}</strong> (${item.id}) 
                <small>HP íšŒë³µ: ${item.hpRecover}</small>
            </span>
            <div>
                <button onclick="window.deleteItemDefinition('${item.id}')" class="del">ì‚­ì œ</button>
            </div>
        `;
        itemListDiv.appendChild(itemElement);
    });
    
    if (Object.keys(itemDefinitions).length === 0) {
        itemListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }
};

const updateEncItemIdSelect = () => {
    encItemIdSelect.innerHTML = '<option value="">(ì„ íƒ ì•ˆí•¨/íšë“ ì—†ìŒ)</option>';
    Object.values(itemDefinitions).forEach(item => {
        const option = new Option(`${item.name} (${item.id})`, item.id);
        encItemIdSelect.appendChild(option);
    });
};

const updateGiveItemSelect = () => {
    const giveItemSelect = document.getElementById('giveItemSelect');
    giveItemSelect.innerHTML = '<option value="">-- ì•„ì´í…œ ì„ íƒ --</option>';
    Object.values(itemDefinitions).forEach(item => {
        const option = new Option(`${item.name} (${item.id})`, item.id);
        giveItemSelect.appendChild(option);
    });
};


/* --- UI Update Functions (Player) --- */

const updatePlayerUI = (isPlayerLoggedIn) => {
    playerMode = isPlayerLoggedIn;
    document.getElementById('playerLoginBtnTop').textContent = isPlayerLoggedIn ? `ë¡œê·¸ì•„ì›ƒ (${player.id})` : 'í”Œë ˆì´ì–´ ë¡œê·¸ì¸';
    
    // ì˜¤ë¥¸ìª½ íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€
    if (isPlayerLoggedIn) {
        statusInventoryPanel.style.display = 'flex';
        playerContentDiv.style.display = 'flex';
        adminRightInfoDiv.style.display = 'none'; // í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œëŠ” ê´€ë¦¬ì ì •ë³´ ìˆ¨ê¹€
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendChatBtn').disabled = false;
        document.getElementById('chatNickname').value = player.id;
        document.getElementById('chatNickname').disabled = true;
        
        startChatListener();
        updatePlayerStatusUI();
        updatePlayerInventoryUI();
        updatePlayerOnMapListPlayerMode(); // **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œ ë§µ í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹ 
    } else {
        // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ˆë©´ ì˜¤ë¥¸ìª½ íŒ¨ë„ ì „ì²´ ìˆ¨ê¹€
        if (!adminMode) {
            statusInventoryPanel.style.display = 'none';
        }
        playerContentDiv.style.display = 'none';
        document.getElementById('chatInput').disabled = true;
        document.getElementById('sendChatBtn').disabled = true;
        document.getElementById('chatNickname').value = localStorage.getItem('chatNickname') || 'íƒí—˜ê°€';
        document.getElementById('chatNickname').disabled = false;
        stopChatListener();
    }
};

const updatePlayerStatusUI = () => {
    playerHPDisplay.textContent = player.hp;
};

const updatePlayerInventoryUI = () => {
    inventoryListDiv.innerHTML = '';
    let hasItems = false;

    Object.entries(player.inventory).forEach(([itemId, count]) => {
        if (count > 0 && itemDefinitions[itemId]) {
            hasItems = true;
            const itemDef = itemDefinitions[itemId];
            const item = document.createElement('div');
            item.className = 'inventory-item';
            item.onclick = () => showItemUseModal(itemId);
            item.innerHTML = `
                <img src="${itemDef.imageUrl || 'placeholder.png'}" alt="${itemDef.name}" class="item-image"/>
                <div>
                    <span class="item-name">${itemDef.name} x${count}</span>
                    <span class="item-desc">${itemDef.description}</span>
                </div>
            `;
            inventoryListDiv.appendChild(item);
        }
    });

    if (!hasItems) {
        inventoryListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px; padding: 10px;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
    }
};

/**
 * **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œ í˜„ì¬ ë§µ í”Œë ˆì´ì–´ ëª©ë¡ì„ ê°±ì‹ í•©ë‹ˆë‹¤. (ì´ë¦„ë§Œ í‘œì‹œ)
 */
const updatePlayerOnMapListPlayerMode = () => {
    if (!playerMode) return;
    playerOnMapListPlayerModeDiv.innerHTML = '';

    const playersOnMap = Object.values(usersData)
        .filter(user => user.currentMap === currentMapName && user.id !== player.id); // ë³¸ì¸ ì œì™¸

    if (playersOnMap.length === 0) {
        playerOnMapListPlayerModeDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì—†ìŒ</div>';
        return;
    }

    playersOnMap.forEach(user => {
        const item = document.createElement('div');
        item.className = 'player-on-map-item';
        // **[ìˆ˜ì •]** ì•„ì´í…œ/ìƒíƒœ ì •ë³´ ì—†ì´ ì´ë¦„ë§Œ
        item.innerHTML = `
            <strong>${user.id}</strong>
        `;
        playerOnMapListPlayerModeDiv.appendChild(item);
    });
};

/* --- Modal/Popup Logic --- */

/**
 * **[ìˆ˜ì •]** ì•„ì´í…œ ì‚¬ìš© íŒì—…ì„ í‘œì‹œí•©ë‹ˆë‹¤.
 * @param {string} itemId ì‚¬ìš©í•  ì•„ì´í…œ ID
 */
const showItemUseModal = (itemId) => {
    if (!playerMode || isEncountering) return;
    const item = itemDefinitions[itemId];
    if (!item) return;

    currentSelectedItem = itemId;

    itemUseName.textContent = item.name;
    itemUseImage.src = item.imageUrl || 'placeholder.png';
    itemUseDescription.textContent = item.description;

    // HP íšŒë³µëŸ‰ì´ 0ë³´ë‹¤ í´ ë•Œë§Œ ì‚¬ìš© ë²„íŠ¼ í™œì„±í™”
    useItemBtn.disabled = !(item.hpRecover > 0);
    useItemBtn.textContent = item.hpRecover > 0 ? `ì‚¬ìš© (HP +${item.hpRecover})` : 'ì‚¬ìš© ë¶ˆê°€';

    itemUseModalBg.style.display = 'flex';
};

const closeItemUseModal = () => {
    itemUseModalBg.style.display = 'none';
    currentSelectedItem = null;
};

/**
 * **[ìˆ˜ì •]** ì¸ë²¤í† ë¦¬ ì•„ì´í…œì„ ì‚¬ìš©í•˜ê³  ìˆ˜ëŸ‰ì„ ê°ì†Œì‹œí‚µë‹ˆë‹¤.
 */
const useSelectedItem = async () => {
    if (!currentSelectedItem || !playerMode || isEncountering) return;
    const itemId = currentSelectedItem;
    const item = itemDefinitions[itemId];

    if (player.inventory[itemId] <= 0) {
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ [${item.name}]ì˜ ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.`, 'system');
        closeItemUseModal();
        return;
    }

    if (item.hpRecover > 0) {
        // HP íšŒë³µ ë¡œì§
        const newHp = Math.min(player.hp + item.hpRecover, MAX_HP);
        await updatePlayerStatus({ hp: newHp });
        addLogItem(`${player.id} (í”Œë ˆì´ì–´): ì•„ì´í…œ **[${item.name}]** ì„(ë¥¼) ì‚¬ìš©í•˜ì—¬ HPë¥¼ ${item.hpRecover} íšŒë³µí–ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${newHp})`, 'item');
        
        // **[ìˆ˜ì • ì ìš©]** ì•„ì´í…œ ì‚¬ìš© í›„ ì¬ê³  1 ê°ì†Œ
        await removeItemFromPlayer(player.id, itemId, 1);
        
        updatePlayerInventoryUI();
    } else {
        addLogItem(`${player.id} (í”Œë ˆì´ì–´): ì•„ì´í…œ **[${item.name}]** ì€(ëŠ”) í˜„ì¬ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 'system');
    }

    closeItemUseModal();
};

/**
 * **[ìˆ˜ì •]** ì¡°ìš° íŒì—… (ì„ íƒì§€ í™”ë©´)ì„ í‘œì‹œí•©ë‹ˆë‹¤. (ë‚´ë¶€ íŒì—…)
 * @param {Object} encounter ì¡°ìš° ë°ì´í„°
 */
const showEncounterModal = (encounter) => {
    isEncountering = true;
    
    encModalName.textContent = encounter.name;
    encModalText.textContent = encounter.text;
    
    // ì´ë¯¸ì§€ ì²˜ë¦¬
    if (encounter.charUrl) {
        encCharImg.src = encounter.charUrl;
        encCharImg.style.display = 'block';
        encCharImgContainer.style.display = 'flex';
    } else {
        encCharImg.style.display = 'none';
        encCharImgContainer.style.display = 'none';
    }

    encounterChoicesDiv.innerHTML = '';
    closeEncounterModalBtn.style.display = 'none';

    if (encounter.choices && encounter.choices.length > 0) {
        // ì„ íƒì§€ ì²˜ë¦¬
        encounter.choices.forEach((choice, index) => {
            const btn = document.createElement('button');
            btn.textContent = choice.text;
            btn.onclick = () => handleChoiceSelection(encounter.x, encounter.y, index);
            encounterChoicesDiv.appendChild(btn);
        });
    } else {
        // ì„ íƒì§€ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ íŠ¸ë¦¬ê±° ë°œë™ ì¤€ë¹„
        closeEncounterModalBtn.style.display = 'block';
        closeEncounterModalBtn.onclick = () => {
            closeEncounterModal();
            handleDefaultTrigger(encounter.data);
        };
    }

    encounterModalBg.style.display = 'flex';
};

const closeEncounterModal = () => {
    isEncountering = false;
    encounterModalBg.style.display = 'none';
};

/**
 * **[ìˆ˜ì •]** ì„ íƒì§€ ì„ íƒ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ê³  ë‚´ë¶€ íŒì—…ì„ ë„ì›ë‹ˆë‹¤.
 * @param {number} encX ì¡°ìš° X ì¢Œí‘œ
 * @param {number} encY ì¡°ìš° Y ì¢Œí‘œ
 * @param {number} choiceIndex ì„ íƒëœ ì„ íƒì§€ ì¸ë±ìŠ¤
 */
const handleChoiceSelection = async (encX, encY, choiceIndex) => {
    const encPoint = encounterPoints.find(p => p.x === encX && p.y === encY);
    if (!encPoint || !encPoint.data.choices || !encPoint.data.choices[choiceIndex]) {
        console.error("ì„ íƒì§€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    const choice = encPoint.data.choices[choiceIndex];

    closeEncounterModal();
    
    // **[ìˆ˜ì • ì ìš©]** ì„ íƒì§€ ê²°ê³¼ í™”ë©´ì„ ë‚´ë¶€ íŒì—…ìœ¼ë¡œ í‘œì‹œ
    choiceResultTitle.textContent = `ì„ íƒ: ${choice.text}`;
    choiceResultText.innerHTML = choice.resultText.replace(/\n/g, '<br>');
    choiceResultPopupBg.style.display = 'flex';

    // ì•„ì´í…œ íšë“/ì†Œë¹„ ì²˜ë¦¬
    if (choice.itemChange) {
        const { itemId, type } = choice.itemChange;
        if (itemId) {
            if (type === 'add') {
                await giveItemToPlayer(player.id, itemId, 1);
            } else if (type === 'remove') {
                await removeItemFromPlayer(player.id, itemId, 1);
            }
        }
    }
    
    // HP ë³€í™” ì²˜ë¦¬
    if (choice.hpChange) {
        const hpChange = parseInt(choice.hpChange);
        if (!isNaN(hpChange) && hpChange !== 0) {
            const newHp = Math.min(Math.max(0, player.hp + hpChange), MAX_HP);
            await updatePlayerStatus({ hp: newHp });
            
            // HP ë³€í™” ë¡œê·¸ ì¶”ê°€
            addLogItem(`${player.id} (í”Œë ˆì´ì–´): ì„ íƒ ê²°ê³¼ë¡œ HPê°€ ${hpChange > 0 ? '+' : ''}${hpChange} ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${newHp})`, 'system');
        }
    }

    // ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì„ íƒì§€ ì„ íƒ í›„ ë°œë™)
    if (choice.trigger && choice.data) {
        // ê²°ê³¼ íŒì—…ì´ ë‹«íŒ í›„ íŠ¸ë¦¬ê±°ê°€ ë°œë™ë˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì— ë“±ë¡
        const triggerHandler = () => {
            closeChoiceResultPopupBtn.removeEventListener('click', triggerHandler);
            closeChoiceResultPopup();
            handleDefaultTrigger(choice);
        };
        closeChoiceResultPopupBtn.addEventListener('click', triggerHandler);
    } else {
        closeChoiceResultPopupBtn.onclick = closeChoiceResultPopup;
    }
    
    // ì¡°ìš° ì™„ë£Œë¡œ í‘œì‹œ
    await markEncounterAsSeen(encX, encY);
};

const closeChoiceResultPopup = () => {
    choiceResultPopupBg.style.display = 'none';
    isEncountering = false;
    draw();
};

/**
 * **[ìˆ˜ì •]** ê¸°ë³¸ íŠ¸ë¦¬ê±°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. (ë‚´ë¶€ íŒì—…ì„ ì‚¬ìš©í•˜ë„ë¡ ë³€ê²½)
 * @param {Object} data íŠ¸ë¦¬ê±° ë°ì´í„°
 */
const handleDefaultTrigger = (data) => {
    if (data.trigger === 'sound') {
        const sound = new Audio(data.data);
        sound.play().catch(e => console.log("Sound play failed: ", e));
        addLogItem(`ì‹œìŠ¤í…œ: ì‚¬ìš´ë“œ íŠ¸ë¦¬ê±° ë°œìƒ - ${data.data}`, 'system');
    } else if (data.trigger === 'image') {
        // **[ìˆ˜ì • ì ìš©]** ì´ë¯¸ì§€ íŒì—…ì„ ë‚´ë¶€ íŒì—…ìœ¼ë¡œ ì²˜ë¦¬
        const imgPopupBg = document.createElement('div');
        imgPopupBg.className = 'internal-modal-bg'; // ë‚´ë¶€ íŒì—… í´ë˜ìŠ¤ ì‚¬ìš©
        imgPopupBg.id = 'imageTriggerPopup';
        
        imgPopupBg.innerHTML = `
            <div class="modal" style="padding: 10px; max-width: 90%; max-height: 90%; overflow: hidden;">
                <img src="${data.data}" style="max-width: 100%; max-height: 100%; display: block; object-fit: contain; border-radius: 5px;"/>
                <div style="margin-top:10px;text-align:right">
                    <button onclick="document.getElementById('imageTriggerPopup').remove(); isEncountering = false; draw();">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        container.appendChild(imgPopupBg);
        imgPopupBg.style.display = 'flex';
        isEncountering = true; // íŒì—…ì´ ëœ° ë•ŒëŠ” ì´ë™ ë°©ì§€
    } else if (data.trigger === 'map' && data.data) {
        // ë§µ ì „í™˜
        loadMapDataFromFirestore(data.data);
    }
};

const markEncounterAsSeen = async (x, y) => {
    const key = `${x}_${y}`;
    if (player.encountered[key]) return; // ì´ë¯¸ ë³¸ ì¡°ìš°

    try {
        const playerRef = doc(db, 'users', player.id);
        
        // Firestoreì˜ 'encountered' ë§µ í•„ë“œì— { "x_y": true } ì¶”ê°€
        await updateDoc(playerRef, {
            [`encountered.${key}`]: true
        });

        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        player.encountered[key] = true;
        
    } catch (e) {
        console.error("ì¡°ìš° ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", e);
    }
};

/* --- Game Loop & Drawing --- */

const draw = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (mapLoaded) {
        ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);
    } else {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#fff';
        ctx.font = '20px Noto Sans KR';
        ctx.textAlign = 'center';
        ctx.fillText(`ë§µ ë¡œë“œ ì‹¤íŒ¨ ë˜ëŠ” ë°ì´í„° ì—†ìŒ: ${currentMapName}`, canvas.width / 2, canvas.height / 2);
    }

    // ê·¸ë¦¬ë“œ í‘œì‹œ (ê´€ë¦¬ì ëª¨ë“œ)
    if (adminMode && isGridMode) {
        ctx.strokeStyle = '#333';
        for (let x = 0; x < canvas.width; x += GRID) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }
        for (let y = 0; y < canvas.height; y += GRID) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
    }

    // ì´ë™ ì œí•œ êµ¬ì—­ í‘œì‹œ (ê´€ë¦¬ì ëª¨ë“œ)
    if (adminMode && isImpassableMode) {
        impassablePoints.forEach(p => {
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID);
        });
    }

    // ì¡°ìš° êµ¬ì—­ í‘œì‹œ
    encounterPoints.forEach(p => {
        const key = `${p.x}_${p.y}`;
        const isSeen = playerMode && player.encountered[key];

        if (adminMode) {
            // ê´€ë¦¬ì ëª¨ë“œ: í¸ì§‘ ì¤‘ì¸ ì¡°ìš°ëŠ” ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬
            if (currentEdit && currentEdit.x === p.x && currentEdit.y === p.y) {
                ctx.strokeStyle = 'cyan';
                ctx.lineWidth = 3;
                ctx.strokeRect(p.x * GRID + 1.5, p.y * GRID + 1.5, GRID - 3, GRID - 3);
            }
            // ë¹¨ê°„ìƒ‰ ì‚¬ê°í˜•ìœ¼ë¡œ í‘œì‹œ
            ctx.fillStyle = 'rgba(192, 57, 43, 0.7)';
            ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID);
            // ì´ë¦„ í…ìŠ¤íŠ¸
            ctx.fillStyle = '#fff';
            ctx.font = '10px Noto Sans KR';
            ctx.textAlign = 'center';
            ctx.fillText(p.data.name || 'ì¡°ìš°', p.x * GRID + GRID / 2, p.y * GRID + GRID / 2 + 3);
        } else if (playerMode) {
            // í”Œë ˆì´ì–´ ëª¨ë“œ: ì´ë¯¸ ë³¸ ì¡°ìš°ëŠ” íˆ¬ëª…ë„ ë‚®ì¶¤
            if (!isSeen) {
                ctx.fillStyle = 'rgba(192, 57, 43, 0.4)';
                ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID);
            }
        }
    });

    // ë§µ ì´ë™ êµ¬ì—­ í‘œì‹œ (ê´€ë¦¬ì ëª¨ë“œ)
    if (adminMode && mapData.transitionX !== null && mapData.transitionY !== null) {
        ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
        ctx.fillRect(mapData.transitionX * GRID, mapData.transitionY * GRID, GRID, GRID);
        ctx.fillStyle = '#000';
        ctx.font = '10px Noto Sans KR';
        ctx.textAlign = 'center';
        ctx.fillText('ë§µ ì´ë™', mapData.transitionX * GRID + GRID / 2, mapData.transitionY * GRID + GRID / 2 + 3);
    }
    
    // í”Œë ˆì´ì–´ ìºë¦­í„° í‘œì‹œ (í”Œë ˆì´ì–´ ëª¨ë“œ)
    if (playerMode && player.id) {
        if (player.charUrl && characterImage.complete) {
            ctx.drawImage(characterImage, player.x * GRID, player.y * GRID, GRID, GRID);
        } else {
            ctx.fillStyle = '#5dade2';
            ctx.fillRect(player.x * GRID, player.y * GRID, GRID, GRID);
            ctx.fillStyle = '#000';
            ctx.font = '10px Noto Sans KR';
            ctx.textAlign = 'center';
            ctx.fillText(player.id, player.x * GRID + GRID / 2, player.y * GRID + GRID / 2 + 3);
        }
    }

    // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ìš”ì²­ (ì´ë™ ì¤‘ì¼ ë•Œë§Œ)
    if (isMoving) {
        animationFrameId = requestAnimationFrame(draw);
    }
};

const handleMovement = async (dx, dy) => {
    if (!playerMode || isMoving || isEncountering) return;

    isMoving = true;
    const newX = player.x + dx;
    const newY = player.y + dy;

    // ë§µ ê²½ê³„ í™•ì¸
    if (newX < 0 || newX >= canvas.width / GRID || newY < 0 || newY >= canvas.height / GRID) {
        isMoving = false;
        return;
    }

    // ì´ë™ ë¶ˆê°€ êµ¬ì—­ í™•ì¸
    const isImpassable = impassablePoints.some(p => p.x === newX && p.y === newY);
    if (isImpassable) {
        isMoving = false;
        addLogItem(`ì‹œìŠ¤í…œ: ì´ë™ ë¶ˆê°€ êµ¬ì—­ì…ë‹ˆë‹¤.`, 'system');
        return;
    }

    // ì´ë™ ì²˜ë¦¬
    player.x = newX;
    player.y = newY;
    
    // DB ì—…ë°ì´íŠ¸
    await updatePlayerStatus({ x: newX, y: newY, currentMap: currentMapName });
    
    draw(); // ì´ë™ í›„ ë°”ë¡œ ê·¸ë¦¬ê¸°

    // ì´ë™ ì™„ë£Œ í›„ ì¡°ìš° ë° ë§µ ì´ë™ í™•ì¸
    setTimeout(() => {
        isMoving = false;

        // ì¡°ìš° í™•ì¸
        const encounter = encounterPoints.find(p => p.x === newX && p.y === newY);
        if (encounter && !player.encountered[`${newX}_${newY}`]) {
            showEncounterModal(encounter.data);
            return;
        }

        // ë§µ ì´ë™ í™•ì¸
        if (mapData.transitionX === newX && mapData.transitionY === newY && mapData.nextMapName) {
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **[${mapData.nextMapName}]** (ìœ¼)ë¡œ ì´ë™í•©ë‹ˆë‹¤.`, 'system');
            loadMapDataFromFirestore(mapData.nextMapName);
            return;
        }
        
        // **[ì¶”ê°€]** í”Œë ˆì´ì–´ ëª¨ë“œ ë§µ í”Œë ˆì´ì–´ ëª©ë¡ ê°±ì‹  (ìœ„ì¹˜ê°€ ë°”ë€” ë•Œ)
        updatePlayerOnMapListPlayerMode(); 
        
    }, 100); // ì§§ì€ ë”œë ˆì´ í›„ ì´ë™ ì™„ë£Œ ì²˜ë¦¬
};


/* --- Event Listeners --- */

const initEventListeners = () => {
    // Top Bar Controls
    document.getElementById('playerLoginBtnTop').addEventListener('click', () => {
        if (playerMode) {
            // ë¡œê·¸ì•„ì›ƒ
            localStorage.removeItem('loggedInUserId');
            player.id = null;
            playerMode = false;
            updatePlayerUI(false);
            addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ë¡œê·¸ì•„ì›ƒ.`, 'system');
        } else {
            // ë¡œê·¸ì¸ ì‹œë„
            document.getElementById('playerLoginBox').style.display = 'flex';
        }
    });

    adminBtn.addEventListener('click', () => {
        if (adminMode) {
            // ë¡œê·¸ì•„ì›ƒ
            signOut(auth);
        } else {
            // ë¡œê·¸ì¸ ì‹œë„
            document.getElementById('loginBox').style.display = 'flex';
        }
    });
    
    // **[ì¶”ê°€ ì ìš©]** ë¡œê·¸ì¸ ì°½ ë°”ê¹¥ ëˆ„ë¥´ë©´ ë‹«íˆê²Œ í•˜ëŠ” ë¡œì§
    document.getElementById('loginBox').addEventListener('click', (e) => {
        if (e.target.id === 'loginBox') { 
            document.getElementById('loginBox').style.display = 'none';
        }
    });
    document.getElementById('playerLoginBox').addEventListener('click', (e) => {
        if (e.target.id === 'playerLoginBox') {
            document.getElementById('playerLoginBox').style.display = 'none';
        }
    });
    
    // Admin/Player Login Submit
    document.getElementById('loginBtn').addEventListener('click', () => {
        const pw = document.getElementById('adminPw').value;
        signInWithEmailAndPassword(auth, ADMIN_EMAIL, pw)
            .then(() => {
                document.getElementById('adminPw').value = '';
                document.getElementById('loginBox').style.display = 'none';
                // onAuthStateChangedì—ì„œ UI ì—…ë°ì´íŠ¸ ì²˜ë¦¬
            })
            .catch(error => {
                alert("ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
            });
    });

    document.getElementById('playerLoginBtnSubmit').addEventListener('click', async () => {
        const playerId = document.getElementById('playerIdInput').value.trim();
        if (!playerId) {
            alert("í”Œë ˆì´ì–´ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        // í”Œë ˆì´ì–´ ì •ë³´ DBì—ì„œ ë¡œë“œ ë˜ëŠ” ìƒì„±
        const playerRef = doc(db, 'users', playerId);
        const playerDoc = await getDoc(playerRef);

        let initialPlayer = {};
        if (playerDoc.exists()) {
            initialPlayer = playerDoc.data();
        } else {
            // ìƒˆ í”Œë ˆì´ì–´ ìƒì„±
            const newPlayer = {
                id: playerId,
                hp: MAX_HP,
                x: mapData.startX,
                y: mapData.startY,
                currentMap: currentMapName,
                charUrl: 'https://via.placeholder.com/32/5dade2/000000?text=P', // ê¸°ë³¸ ì´ë¯¸ì§€
                inventory: {},
                encountered: {}
            };
            await setDoc(playerRef, newPlayer);
            initialPlayer = newPlayer;
            addLogItem(`ì‹œìŠ¤í…œ: ìƒˆ í”Œë ˆì´ì–´ **[${playerId}]** ìƒì„± ë° ë¡œê·¸ì¸.`, 'system');
        }
        
        // ë¡œê·¸ì¸ ì²˜ë¦¬
        player.id = playerId;
        Object.assign(player, initialPlayer);
        localStorage.setItem('loggedInUserId', playerId);
        
        // ìºë¦­í„° ì´ë¯¸ì§€ ë¡œë“œ
        characterImage.src = player.charUrl;
        characterImage.onload = draw;
        
        // í˜„ì¬ ë§µ ë¡œë“œ (í”Œë ˆì´ì–´ ìœ„ì¹˜ ê¸°ì¤€)
        if (player.currentMap && player.currentMap !== currentMapName) {
            loadMapDataFromFirestore(player.currentMap);
        } else {
             // ë¡œë“œëœ ë§µê³¼ ë™ì¼í•˜ê±°ë‚˜ ë§µ ì •ë³´ê°€ ì—†ì„ ê²½ìš° (ì—†ìœ¼ë©´ defaultë¡œ ë¡œë“œë¨)
            await updatePlayerStatus({ x: player.x, y: player.y, currentMap: currentMapName }); // ìµœì¢… ìœ„ì¹˜/ë§µ í™•ì •
        }
        
        document.getElementById('playerIdInput').value = '';
        document.getElementById('playerLoginBox').style.display = 'none';
        updatePlayerUI(true);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **[${playerId}]** ë¡œê·¸ì¸ ì„±ê³µ.`, 'system');
        draw();
    });

    // Chat Controls
    document.getElementById('sendChatBtn').addEventListener('click', () => {
        const chatInput = document.getElementById('chatInput');
        sendChatMessage(chatInput.value, adminMode);
    });

    document.getElementById('chatInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('sendChatBtn').click();
        }
    });
    
    document.getElementById('chatNickname').addEventListener('change', (e) => {
        localStorage.setItem('chatNickname', e.target.value);
    });
    
    // **[ì‚­ì œ ì ìš©]** ì „ì²´ ì±„íŒ… ê¸°ë¡ ë³´ê¸° ê¸°ëŠ¥ (#logToggleBtn) ì‚­ì œ
    
    document.getElementById('deleteAllChatBtn').addEventListener('click', deleteAllChatMessages);

    // BGM Controls
    bgmVolume.addEventListener('input', (e) => {
        bgmAudio.volume = e.target.value;
    });

    bgmToggleBtn.addEventListener('click', () => {
        if (bgmAudio.paused || bgmAudio.ended) {
            bgmAudio.play().catch(e => console.log("BGM ì¬ìƒ ì‹¤íŒ¨: ", e));
            bgmToggleBtn.textContent = 'PAUSE';
        } else {
            bgmAudio.pause();
            bgmToggleBtn.textContent = 'PLAY';
        }
    });

    // Admin Panel Map Controls
    document.getElementById('saveMap').addEventListener('click', saveMapDataToFirestore);
    document.getElementById('reload').addEventListener('click', () => loadMapDataFromFirestore(mapNameInput.value.trim() || 'default'));
    document.getElementById('toggleGrid').addEventListener('click', (e) => {
        isGridMode = !isGridMode;
        e.target.classList.toggle('active', isGridMode);
        draw();
    });
    document.getElementById('toggleEncounter').addEventListener('click', (e) => {
        isEncounterMode = !isEncounterMode;
        e.target.classList.toggle('active', isEncounterMode);
        isImpassableMode = false;
        document.getElementById('toggleImpassable').classList.remove('active');
    });
    document.getElementById('toggleImpassable').addEventListener('click', (e) => {
        isImpassableMode = !isImpassableMode;
        e.target.classList.toggle('active', isImpassableMode);
        isEncounterMode = false;
        document.getElementById('toggleEncounter').classList.remove('active');
    });
    
    document.getElementById('setPlayerPos').addEventListener('click', async () => {
        mapData.startX = parseInt(startXInput.value) || 0;
        mapData.startY = parseInt(startYInput.value) || 0;
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì‹œì‘ ì¢Œí‘œë¥¼ (${mapData.startX}, ${mapData.startY})ë¡œ ì„¤ì •.`, 'system');
        draw();
    });
    
    document.getElementById('setTransitionPos').addEventListener('click', async () => {
        mapData.transitionX = parseInt(transitionXInput.value) || null;
        mapData.transitionY = parseInt(transitionYInput.value) || null;
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ë™ ì¢Œí‘œë¥¼ (${mapData.transitionX}, ${mapData.transitionY})ë¡œ ì„¤ì •.`, 'system');
        draw();
    });

    // **[ì‚­ì œ ì ìš©]** ì¡°ìš°/ì œí•œ ì „ì²´ ì‚­ì œ ë²„íŠ¼ ì‚­ì œ
    // document.getElementById('deleteAllEncBtn').addEventListener('click', deleteAllEncounters);
    // document.getElementById('deleteAllImpBtn').addEventListener('click', deleteAllImpassables);
    
    document.getElementById('deleteAndInitMapBtn').addEventListener('click', () => deleteMapDataFromFirestore(currentMapName));

    // Admin Panel User/Item Controls (placeholder for full implementation)
    document.getElementById('addPlayerBtn').addEventListener('click', async () => {
        const id = document.getElementById('newUserId').value.trim();
        const url = document.getElementById('newUserCharUrl').value.trim();
        if (!id) return alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        const playerRef = doc(db, 'users', id);
        if ((await getDoc(playerRef)).exists()) {
            return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í”Œë ˆì´ì–´ IDì…ë‹ˆë‹¤.");
        }

        const newPlayer = {
            hp: MAX_HP,
            x: 0,
            y: 0,
            currentMap: 'default',
            charUrl: url || 'https://via.placeholder.com/32/5dade2/000000?text=P',
            inventory: {},
            encountered: {}
        };
        await setDoc(playerRef, newPlayer);
        document.getElementById('newUserId').value = '';
        document.getElementById('newUserCharUrl').value = '';
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **[${id}]**ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        fetchAllUsers(true);
    });

    document.getElementById('updatePlayerStatusBtn').addEventListener('click', async () => {
        const id = document.getElementById('selectPlayerId').value;
        const hp = parseInt(document.getElementById('playerHpInput').value);
        if (!id || isNaN(hp)) return alert("í”Œë ˆì´ì–´ IDì™€ HPë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        await updateDoc(doc(db, 'users', id), { hp: Math.min(Math.max(0, hp), MAX_HP) });
        addLogItem(`ì‹œìŠ¤í…œ: **${id}**ì˜ HPë¥¼ ${hp}ë¡œ ì„¤ì •.`, 'system');
        fetchAllUsers(true);
    });

    document.getElementById('updatePlayerMapBtn').addEventListener('click', async () => {
        const id = document.getElementById('selectPlayerIdMap').value;
        const map = document.getElementById('playerMapInput').value.trim();
        const x = parseInt(document.getElementById('playerXInput').value);
        const y = parseInt(document.getElementById('playerYInput').value);
        if (!id || !map || isNaN(x) || isNaN(y)) return alert("í”Œë ˆì´ì–´ ID, ë§µ ì´ë¦„, X/Y ì¢Œí‘œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        await updateDoc(doc(db, 'users', id), { 
            currentMap: map, 
            x: x, 
            y: y 
        });
        addLogItem(`ì‹œìŠ¤í…œ: **${id}**ë¥¼ ë§µ **[${map}]**ì˜ (${x}, ${y})ë¡œ ì´ë™.`, 'system');
        fetchAllUsers(true);
    });

    document.getElementById('giveItemBtn').addEventListener('click', async () => {
        const playerId = document.getElementById('giveItemPlayerSelect').value;
        const itemId = document.getElementById('giveItemSelect').value;
        if (!playerId || !itemId) return alert("í”Œë ˆì´ì–´ì™€ ì•„ì´í…œì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        await giveItemToPlayer(playerId, itemId, 1);
        fetchAllUsers(true);
    });

    document.getElementById('addItemBtn').addEventListener('click', async () => {
        const id = document.getElementById('newItemId').value.trim();
        const name = document.getElementById('newItemName').value.trim();
        const url = document.getElementById('newItemImageUrl').value.trim();
        const hpRecover = parseInt(document.getElementById('newItemHpRecover').value) || 0;
        const desc = document.getElementById('newItemDescription').value.trim();
        
        if (!id || !name) return alert("IDì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        if (itemDefinitions[id]) {
            return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´í…œ IDì…ë‹ˆë‹¤.");
        }

        const newItem = {
            name: name,
            imageUrl: url,
            hpRecover: hpRecover,
            description: desc
        };
        await setDoc(doc(db, 'item_definitions', id), newItem);
        
        document.getElementById('newItemId').value = '';
        document.getElementById('newItemName').value = '';
        document.getElementById('newItemImageUrl').value = '';
        document.getElementById('newItemHpRecover').value = 0;
        document.getElementById('newItemDescription').value = '';

        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **[${name}]**ì´(ê°€) ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        fetchAllItems(true);
    });

    // Item Use Modal
    useItemBtn.addEventListener('click', useSelectedItem); // **[ìˆ˜ì •]** ì•„ì´í…œ ì‚¬ìš© ë¡œì§ ì—°ê²°
    closeItemUseModalBtn.addEventListener('click', closeItemUseModal);
    
    // **[ì¶”ê°€]** ì„ íƒì§€ ê²°ê³¼ íŒì—… ë‹«ê¸°
    closeChoiceResultPopupBtn.addEventListener('click', closeChoiceResultPopup); 

    // Admin Panel Tab Switching
    document.querySelectorAll('.admin-tabs button').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('.admin-tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-tab-content').forEach(content => content.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(e.target.id.replace('Btn', 'Content')).classList.add('active');
        });
    });

    // Minimizing Admin Panel
    document.getElementById('minimizeBtn').addEventListener('click', () => {
        adminPanel.classList.toggle('minimized');
        document.getElementById('minimizeBtn').textContent = adminPanel.classList.contains('minimized') ? '[+]' : '[â€”]';
    });

    // Admin Panel Dragging (Simplified: just for show, complex implementation omitted)
    const adminPanelTitle = document.querySelector('#adminPanel h4');
    let isDragging = false;
    let offsetX, offsetY;
    
    adminPanelTitle.addEventListener('mousedown', (e) => {
        if (adminPanel.classList.contains('minimized')) return;
        isDragging = true;
        offsetX = e.clientX - adminPanel.getBoundingClientRect().left;
        offsetY = e.clientY - adminPanel.getBoundingClientRect().top;
        adminPanel.style.cursor = 'grabbing';
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        adminPanel.style.right = 'auto'; // rightë¥¼ í•´ì œí•´ì•¼ left/top ì´ë™ì´ ìì—°ìŠ¤ëŸ¬ì›€
        adminPanel.style.left = `${e.clientX - offsetX}px`;
        adminPanel.style.top = `${e.clientY - offsetY}px`;
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        adminPanel.style.cursor = 'grab';
    });
    
    // Encounter Edit Modal Controls
    document.getElementById('addChoice').addEventListener('click', addChoiceToEditModal);
    document.getElementById('closeEncEdit').addEventListener('click', () => {
        editModal.style.display = 'none';
        currentEdit = null;
        draw();
    });
    document.getElementById('saveEncEdit').addEventListener('click', saveEncounterEdit);
    document.getElementById('deleteEncEdit').addEventListener('click', deleteEncounterEdit);
    
    encItemIdManualCheck.addEventListener('change', (e) => {
        encItemIdManual.style.display = e.target.checked ? 'block' : 'none';
        encItemIdSelect.style.display = e.target.checked ? 'none' : 'block';
    });

    // Canvas click for Admin Mode
    canvas.addEventListener('click', (e) => {
        if (!adminMode) return;
        
        const rect = canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        const gridX = Math.floor(clickX / GRID);
        const gridY = Math.floor(clickY / GRID);

        // ë§µ ì´ë™ êµ¬ì—­ ìˆ˜ì •/ì‚­ì œ
        if (mapData.transitionX === gridX && mapData.transitionY === gridY) {
            if (confirm(`ë§µ ì´ë™ êµ¬ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${gridX}, ${gridY})`)) {
                mapData.transitionX = null;
                mapData.transitionY = null;
                updateAdminMapUI();
                draw();
            }
            return;
        }

        // ì¡°ìš° ìˆ˜ì •/ì‚­ì œ
        const existingEncIndex = encounterPoints.findIndex(p => p.x === gridX && p.y === gridY);
        if (existingEncIndex !== -1) {
             currentEdit = encounterPoints[existingEncIndex];
             loadEncounterToEditModal(currentEdit);
             return;
        }
        
        // ì´ë™ ë¶ˆê°€ êµ¬ì—­ ìˆ˜ì •/ì‚­ì œ
        const existingImpIndex = impassablePoints.findIndex(p => p.x === gridX && p.y === gridY);
        if (existingImpIndex !== -1) {
            if (isImpassableMode) {
                // ì‚­ì œ ëª¨ë“œ
                impassablePoints.splice(existingImpIndex, 1);
                addLogItem(`ì‹œìŠ¤í…œ: ì´ë™ ë¶ˆê°€ êµ¬ì—­ (${gridX}, ${gridY}) ì‚­ì œ.`, 'system');
            } else {
                // ìˆ˜ì •/ì‚­ì œ ì•Œë¦¼
                if (confirm(`ì´ë™ ë¶ˆê°€ êµ¬ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (${gridX}, ${gridY})`)) {
                    impassablePoints.splice(existingImpIndex, 1);
                    addLogItem(`ì‹œìŠ¤í…œ: ì´ë™ ë¶ˆê°€ êµ¬ì—­ (${gridX}, ${gridY}) ì‚­ì œ.`, 'system');
                }
            }
            draw();
            return;
        }
        
        // ì¶”ê°€ ëª¨ë“œ ì²˜ë¦¬
        if (isEncounterMode) {
            // ìƒˆ ì¡°ìš° ì¶”ê°€
            currentEdit = { x: gridX, y: gridY, data: { name: `ì¡°ìš°_${gridX}_${gridY}`, text: '', charUrl: '', trigger: 'none', data: '', itemId: '', choices: [] } };
            loadEncounterToEditModal(currentEdit);
            isEncounterMode = false;
            document.getElementById('toggleEncounter').classList.remove('active');
            encounterPoints.push(currentEdit);
            draw();
        } else if (isImpassableMode) {
            // ìƒˆ ì´ë™ ë¶ˆê°€ êµ¬ì—­ ì¶”ê°€
            impassablePoints.push({ x: gridX, y: gridY });
            addLogItem(`ì‹œìŠ¤í…œ: ì´ë™ ë¶ˆê°€ êµ¬ì—­ (${gridX}, ${gridY}) ì¶”ê°€.`, 'system');
            isImpassableMode = false;
            document.getElementById('toggleImpassable').classList.remove('active');
            draw();
        }
        
    });

    // **[ìˆ˜ì • ì ìš©]** ì˜íƒ€ ë§µì´ë™ ë°©ì§€ ë° WASD/í™”ì‚´í‘œë§Œ í—ˆìš©
    document.onkeydown = (e) => {
        if (playerMode && !isEncountering && !isMoving) {
            let key = e.key.toLowerCase();
            let dx = 0;
            let dy = 0;

            if (key === 'w' || key === 'arrowup') {
                dy = -1;
            } else if (key === 's' || key === 'arrowdown') {
                dy = 1;
            } else if (key === 'a' || key === 'arrowleft') {
                dx = -1;
            } else if (key === 'd' || key === 'arrowright') {
                dx = 1;
            } else {
                return; // WASD/í™”ì‚´í‘œê°€ ì•„ë‹ˆë©´ ë¬´ì‹œ (ì˜íƒ€ ë°©ì§€)
            }

            if (dx !== 0 || dy !== 0) {
                e.preventDefault();
                handleMovement(dx, dy);
            }
        }
    };
    
    // Load existing admin panel position
    const savedAdminPanelLeft = localStorage.getItem('adminPanelLeft');
    const savedAdminPanelTop = localStorage.getItem('adminPanelTop');
    if (savedAdminPanelLeft && savedAdminPanelTop) {
        adminPanel.style.left = savedAdminPanelLeft;
        adminPanel.style.top = savedAdminPanelTop;
        adminPanel.style.right = 'auto';
    }
    
    // Save admin panel position on move
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            localStorage.setItem('adminPanelLeft', adminPanel.style.left);
            localStorage.setItem('adminPanelTop', adminPanel.style.top);
        }
    });

};

// Encounter Edit Functions (for brevity, keeping original structure)
const loadEncounterToEditModal = (enc) => {
    encNameInput.value = enc.data.name || '';
    encTextInput.value = enc.data.text || '';
    encCharUrlInput.value = enc.data.charUrl || '';
    encTriggerSelect.value = enc.data.trigger || 'none';
    encDataInput.value = enc.data.data || '';
    
    if (enc.data.itemId && !itemDefinitions[enc.data.itemId]) {
        encItemIdManualCheck.checked = true;
        encItemIdManual.style.display = 'block';
        encItemIdSelect.style.display = 'none';
        encItemIdManual.value = enc.data.itemId;
    } else {
        encItemIdManualCheck.checked = false;
        encItemIdManual.style.display = 'none';
        encItemIdSelect.style.display = 'block';
        encItemIdSelect.value = enc.data.itemId || '';
    }

    choicesDiv.innerHTML = '';
    (enc.data.choices || []).forEach((choice, index) => renderChoiceEdit(choice, index));
    
    editModal.style.display = 'flex';
};

const renderChoiceEdit = (choice, index) => {
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'choice';
    choiceDiv.setAttribute('data-index', index);
    
    const itemChangeType = choice.itemChange?.type || 'none';
    const itemChangeId = choice.itemChange?.itemId || '';
    const hpChange = choice.hpChange || '';

    choiceDiv.innerHTML = `
        <div class="choice-text-group">
            <input type="text" class="choiceText" placeholder="ì„ íƒì§€ í…ìŠ¤íŠ¸" value="${choice.text || ''}">
            <button class="del" onclick="window.removeChoiceEdit(${index})">ğŸ—‘ï¸</button>
        </div>
        <div class="choice-result-group">
            <label>ì„ íƒ ê²°ê³¼ ì§€ë¬¸</label>
            <textarea class="choiceResultText" placeholder="ì„ íƒ í›„ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì¼ ì§€ë¬¸" rows="2">${choice.resultText || ''}</textarea>
        </div>
        
        <div class="choice-item-group">
            <label>ì•„ì´í…œ</label>
            <select class="choiceItemChangeType">
                <option value="none" ${itemChangeType === 'none' ? 'selected' : ''}>ì—†ìŒ</option>
                <option value="add" ${itemChangeType === 'add' ? 'selected' : ''}>íšë“ (1ê°œ)</option>
                <option value="remove" ${itemChangeType === 'remove' ? 'selected' : ''}>ì†Œë¹„ (1ê°œ)</option>
            </select>
            <input type="text" class="choiceItemChangeId" placeholder="ì•„ì´í…œ ID" value="${itemChangeId}">
        </div>
        
        <div class="choice-hp-group">
            <label>HP ë³€í™”</label>
            <input type="number" class="choiceHpChange" placeholder="+/- HP" value="${hpChange}">
        </div>

        <div class="choice-trigger-group">
            <label>íŠ¸ë¦¬ê±°</label>
            <select class="choiceTrigger">
                <option value="none" ${choice.trigger === 'none' ? 'selected' : ''}>ì—†ìŒ</option>
                <option value="sound" ${choice.trigger === 'sound' ? 'selected' : ''}>ì‚¬ìš´ë“œ</option>
                <option value="image" ${choice.trigger === 'image' ? 'selected' : ''}>ì´ë¯¸ì§€ íŒì—…</option>
                <option value="map" ${choice.trigger === 'map' ? 'selected' : ''}>ë§µ ì „í™˜</option>
            </select>
            <input type="text" class="choiceData" placeholder="ë°ì´í„°(URL/ë§µëª…)" value="${choice.data || ''}">
        </div>
    `;
    choicesDiv.appendChild(choiceDiv);
};

const addChoiceToEditModal = () => {
    if (!currentEdit) return;
    const newChoice = { text: 'ìƒˆ ì„ íƒì§€', resultText: 'ì„ íƒ ê²°ê³¼ ì§€ë¬¸', itemChange: { type: 'none', itemId: '' }, hpChange: '', trigger: 'none', data: '' };
    currentEdit.data.choices.push(newChoice);
    renderChoiceEdit(newChoice, currentEdit.data.choices.length - 1);
};

window.removeChoiceEdit = (index) => {
    if (!currentEdit) return;
    currentEdit.data.choices.splice(index, 1);
    
    // UI ê°±ì‹ 
    choicesDiv.innerHTML = '';
    (currentEdit.data.choices || []).forEach((choice, idx) => renderChoiceEdit(choice, idx));
};

const saveEncounterEdit = () => {
    if (!currentEdit) return;

    currentEdit.data.name = encNameInput.value.trim();
    currentEdit.data.text = encTextInput.value.trim();
    currentEdit.data.charUrl = encCharUrlInput.value.trim();
    currentEdit.data.trigger = encTriggerSelect.value;
    currentEdit.data.data = encDataInput.value.trim();
    
    // ì•„ì´í…œ ID ì„¤ì •
    currentEdit.data.itemId = encItemIdManualCheck.checked ? encItemIdManual.value.trim() : encItemIdSelect.value;
    if (currentEdit.data.itemId === '') delete currentEdit.data.itemId;

    // ì„ íƒì§€ ì €ì¥
    currentEdit.data.choices = Array.from(choicesDiv.querySelectorAll('.choice')).map(choiceDiv => {
        const itemType = choiceDiv.querySelector('.choiceItemChangeType').value;
        const itemId = choiceDiv.querySelector('.choiceItemChangeId').value.trim();
        const hpChange = choiceDiv.querySelector('.choiceHpChange').value.trim();
        
        return {
            text: choiceDiv.querySelector('.choiceText').value.trim(),
            resultText: choiceDiv.querySelector('.choiceResultText').value.trim(),
            itemChange: itemType !== 'none' && itemId ? { type: itemType, itemId: itemId } : undefined,
            hpChange: hpChange !== '' ? parseInt(hpChange) : undefined,
            trigger: choiceDiv.querySelector('.choiceTrigger').value,
            data: choiceDiv.querySelector('.choiceData').value.trim()
        };
    }).filter(c => c.text !== ''); // í…ìŠ¤íŠ¸ê°€ ì—†ëŠ” ì„ íƒì§€ëŠ” ì œì™¸

    // ë¹ˆ í•„ë“œ ì •ë¦¬
    if (currentEdit.data.itemId === undefined) delete currentEdit.data.itemId;
    if (currentEdit.data.choices.length === 0) delete currentEdit.data.choices;
    if (!currentEdit.data.charUrl) delete currentEdit.data.charUrl;
    if (!currentEdit.data.data) delete currentEdit.data.data;
    
    // ê¸°ë³¸ íŠ¸ë¦¬ê±°ê°€ 'none'ì´ê³  ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í•„ë“œ ì‚­ì œ
    if (currentEdit.data.trigger === 'none' && !currentEdit.data.data) {
        delete currentEdit.data.trigger;
        delete currentEdit.data.data;
    }

    addLogItem(`ì‹œìŠ¤í…œ: ì¡°ìš° (${currentEdit.x}, ${currentEdit.y}) ìˆ˜ì • ì™„ë£Œ.`, 'system');
    editModal.style.display = 'none';
    currentEdit = null;
    draw();
};

const deleteEncounterEdit = () => {
    if (!currentEdit) return;
    if (confirm(`ì •ë§ë¡œ ì¡°ìš° [${currentEdit.data.name}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        const index = encounterPoints.findIndex(p => p.x === currentEdit.x && p.y === currentEdit.y);
        if (index !== -1) {
            encounterPoints.splice(index, 1);
            addLogItem(`ì‹œìŠ¤í…œ: ì¡°ìš° (${currentEdit.x}, ${currentEdit.y}) ì‚­ì œ.`, 'system');
        }
        editModal.style.display = 'none';
        currentEdit = null;
        draw();
    }
};

// Admin Functions (exposed to global window for HTML inline access)
window.deleteUser = async (userId) => {
    if (!adminMode) return;
    if (confirm(`${userId} í”Œë ˆì´ì–´ì˜ ê³„ì • ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        await deleteDoc(doc(db, 'users', userId));
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **[${userId}]** ì‚­ì œë¨.`, 'system');
        fetchAllUsers(true);
        if (userId === player.id) {
            localStorage.removeItem('loggedInUserId');
            player.id = null;
            updatePlayerUI(false);
        }
    }
};

window.deleteItemDefinition = async (itemId) => {
    if (!adminMode) return;
    if (confirm(`ì•„ì´í…œ ì •ì˜ [${itemDefinitions[itemId]?.name || itemId}]ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬ì˜ í•´ë‹¹ ì•„ì´í…œì€ ë‚¨ìŠµë‹ˆë‹¤)`)) {
        await deleteDoc(doc(db, 'item_definitions', itemId));
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ì •ì˜ **[${itemId}]** ì‚­ì œë¨.`, 'system');
        fetchAllItems(true);
    }
};

window.showUserInventory = async (playerId) => {
    if (!adminMode) return;
    const inventoryModal = document.getElementById('inventoryModal');
    const inventoryModalTitle = document.getElementById('inventoryModalTitle');
    const inventoryModalList = document.getElementById('inventoryModalList');
    
    inventoryModalTitle.textContent = `${playerId} í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬`;
    inventoryModalList.innerHTML = '';
    
    const user = usersData[playerId];
    if (!user || Object.keys(user.inventory).length === 0) {
        inventoryModalList.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px; padding: 10px;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
        inventoryModal.style.display = 'flex';
        return;
    }

    Object.entries(user.inventory).forEach(([itemId, count]) => {
        if (count > 0) {
            const itemDef = itemDefinitions[itemId] || { name: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ', description: 'ID: ' + itemId };
            const item = document.createElement('div');
            item.className = 'inventory-admin-item';
            item.innerHTML = `
                <span>
                    <strong>${itemDef.name}</strong> x${count}
                    <small style="display: block; color: #aaa;">${itemDef.description}</small>
                </span>
                <button onclick="window.removeAdminItem('${playerId}', '${itemId}')">ì œê±°</button>
            `;
            inventoryModalList.appendChild(item);
        }
    });

    inventoryModal.style.display = 'flex';
};

window.closeInventoryModal = () => {
    document.getElementById('inventoryModal').style.display = 'none';
};

window.removeAdminItem = async (playerId, itemId) => {
    if (confirm(`${playerId}ì—ê²Œì„œ ì•„ì´í…œ [${itemDefinitions[itemId]?.name || itemId}] 1ê°œë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        await removeItemFromPlayer(playerId, itemId, 1);
        // DB ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ì¸ë²¤í† ë¦¬ íŒì—…ì„ ì—´ì–´ ê°±ì‹ 
        window.showUserInventory(playerId); 
        fetchAllUsers(true); 
    }
};


// Initialization Sequence
initEventListeners(); 

onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        updateAdminUI(true);
        addLogItem(`ì‹œìŠ¤í…œ: ê´€ë¦¬ì (${user.email}) ë¡œê·¸ì¸ ì„±ê³µ.`, 'system');
    } else {
        if (!loggedInUserId) {
            updateAdminUI(false);
            updatePlayerUI(false);
        } else {
            updateAdminUI(false); 
        }
    }
});

const initialMap = localStorage.getItem('currentMap') || 'default';

Promise.all([
    fetchAllUsers(false),
    fetchAllItems(true),
    loadMapDataFromFirestore(initialMap).then(loaded => {
        if (!loaded) {
            mapNameInput.value = 'default';
            currentMapName = 'default';
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ë°ì´í„°ê°€ ì—†ì–´ **[default]** ë§µìœ¼ë¡œ ì´ˆê¸°í™”.`, 'system');
        }
    }),
    reloadMapList()
]).then(() => {
    startXInput.value = player.x;
    startYInput.value = player.y; 
    draw();

    const savedPlayerId = localStorage.getItem('loggedInUserId');
    if (savedPlayerId) {
        loggedInUserId = savedPlayerId;
        const savedPlayer = usersData[savedPlayerId];
        if (savedPlayer) {
            player.id = savedPlayerId;
            Object.assign(player, savedPlayer);
            
            // ìºë¦­í„° ì´ë¯¸ì§€ ë¡œë“œ
            characterImage.src = player.charUrl;
            characterImage.onload = draw;
            
            // ì €ì¥ëœ ë§µì´ í˜„ì¬ ë¡œë“œëœ ë§µê³¼ ë‹¤ë¥´ë©´ í•´ë‹¹ ë§µìœ¼ë¡œ ì´ë™
            if (player.currentMap && player.currentMap !== currentMapName) {
                loadMapDataFromFirestore(player.currentMap);
            }
            
            updatePlayerUI(true);
            addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **[${player.id}]** ìë™ ë¡œê·¸ì¸.`, 'system');
        } else {
            // DBì— ì—†ëŠ” IDë©´ ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ì œê±°
            localStorage.removeItem('loggedInUserId');
        }
    }
});
</script>
</body>
</html>
