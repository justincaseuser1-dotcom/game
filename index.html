<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tistoryìš© ê³µí¬ ì¯”ê¾¸ë¥´ (í™•ì¥ ê´€ë¦¬ìíŒ, Firebase í†µí•©)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
  :root{
    --bg:#000;
    --panel:rgba(0,0,0,0.9); /* ë” ë¶ˆíˆ¬ëª…í•˜ê²Œ */
    --accent:#c0392b;
    --border-dark:#222;
    --border-light:#444;
    --text-color:#eee;
    --input-bg:#1a1a1a;
  }
  body{
    margin:0;background:var(--bg);color:var(--text-color);font-family:'Noto Sans KR',sans-serif;
    display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;overflow:hidden;
  }
  /* Top Bar (ë¡œê·¸ì¸ ë²„íŠ¼ ë³€ê²½) */
  #topBar{
    display:flex;justify-content:space-between;width:100%;padding:8px 16px;position:fixed;top:0;right:0;left:0;
    z-index:10;background:var(--panel);box-shadow: 0 2px 5px rgba(0,0,0,0.5);height: 40px;align-items: center;box-sizing: border-box;
  }
  #authControls { display: flex; gap: 10px; align-items: center; }
  #authControls input { width: 100px; padding: 5px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  #bgmControls { display:flex;gap:10px;align-items:center;flex-shrink:0; }
  #bgmControls button, #adminBtn, #logoutBtn { padding:5px 10px;font-size:14px;line-height:1;height:30px; }
  #bgmVolume { width:80px;height:4px;background:var(--border-light);-webkit-appearance:none;appearance:none;border-radius:5px;cursor:pointer; }
  #bgmVolume::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px var(--accent);}
  
  /* Main Content Layout (ë§µ, ë¡œê·¸, ì¸ë²¤í† ë¦¬ í†µí•© ë°°ì¹˜) */
  #mainContent {
      display: flex;
      gap: 15px;
      margin-top: 60px; /* topBar ë†’ì´ë§Œí¼ ì—¬ë°± */
      max-height: calc(100vh - 150px); /* ì „ì²´ í™”ë©´ ë†’ì´ ì¡°ì • */
      align-items: flex-start;
  }
  
  /* ë§µ ì»¨í…Œì´ë„ˆ (ê¸°ì¡´ 640x480 ìœ ì§€) */
  #container{
    position:relative;width:640px;height:480px;overflow:hidden;border:3px solid var(--border-light);
    box-shadow:0 0 40px var(--accent);background:#000;z-index:5;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:1}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2}
  #dragGhost { position:absolute;width:32px;height:32px;background:rgba(0,255,255,0.4);border:2px solid cyan;pointer-events:none;display:none;z-index:4; }
  
  /* ì¢Œì¸¡ ë¡œê·¸/ì±„íŒ… íŒ¨ë„ (ì„¸ë¡œ ê½‰ ì°¨ê²Œ) */
  #logChatPanel {
      width: 280px;
      height: 480px; /* ë§µê³¼ ë†’ì´ ì¼ì¹˜ */
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; /* ë¡œê·¸ì¸ ì „ ìˆ¨ê¹€ */
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  #logChatHistory {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ */
  }
  .log-message { margin-bottom: 5px; font-size: 13px; line-height: 1.3; }
  .log-system { color: #888; font-style: italic; }
  .log-chat { color: var(--text-color); }
  .log-chat b { color: #5dade2; } /* í”Œë ˆì´ì–´ ë‹‰ë„¤ì„ */
  .log-chat .admin-name { color: var(--accent); } /* ê´€ë¦¬ì ë‹‰ë„¤ì„ */
  #chatInputArea {
      display: flex;
      flex-direction: column;
      gap: 5px;
  }
  #chatInputArea #nicknameInput { width: 100%; padding: 5px; font-size: 13px; }
  #chatInputArea > div { display: flex; gap: 5px; }
  #chatInput { flex-grow: 1; }
  
  /* ë¡œê·¸ ì•„ì¹´ì´ë¸Œ í† ê¸€ */
  #archiveToggle { width: 30px; height: 30px; padding: 0; flex-shrink: 0; background: #333; }
  #archiveToggle:hover { background: #555; }
  #archiveList {
      position: absolute;
      left: 10px;
      top: 10px;
      background: rgba(0,0,0,0.95);
      border: 1px solid var(--border-light);
      padding: 10px;
      border-radius: 5px;
      display: none;
      z-index: 50;
  }
  .archive-item { cursor: pointer; padding: 5px; margin-bottom: 3px; font-size: 13px; }
  .archive-item:hover { background: #333; }
  
  /* ìš°ì¸¡ ìƒíƒœ/ì¸ë²¤í† ë¦¬ íŒ¨ë„ */
  #statusInventoryPanel {
      width: 250px;
      height: 480px;
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; /* ë¡œê·¸ì¸ ì „ ìˆ¨ê¹€ */
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
  }
  #statusPanel h4, #inventoryPanel h4 { color: var(--accent); margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-dark); }
  #playerStatus { margin-bottom: 15px; font-size: 14px; }
  #hpBar { width: 100%; height: 15px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; }
  #hpValue { height: 100%; background: #27ae60; transition: width 0.3s; text-align: right; line-height: 15px; padding-right: 5px; font-size: 10px; font-weight: bold; color: #fff; }
  #inventoryGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 10px 0;
      flex-grow: 1;
  }
  .item-slot {
      width: 50px;
      height: 50px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
  }
  .item-slot img { max-width: 100%; max-height: 100%; object-fit: contain; }
  .item-slot:hover { border-color: var(--accent); }
  
  /* ê´€ë¦¬ì íŒ¨ë„ (ë§µ í•˜ë‹¨ ê³ ì • ë°°ì¹˜) */
  #adminPanel{
    position: static; /* fixed í•´ì œ */
    margin-top: 15px; /* ë§µê³¼ì˜ ê°„ê²© */
    z-index:15;background:var(--panel);padding:15px;border-radius:10px;
    font-size:14px;display:none;min-width:920px;max-width:920px;border:1px solid var(--accent);
    box-shadow:0 0 10px rgba(192,57,43,0.5);
  }
  #adminPanel h4{margin:0 0 12px 0;text-align:center;color:var(--accent);border-bottom: 1px solid var(--border-dark);padding-bottom: 8px;}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;width:100%;}
  .row label{white-space:nowrap;min-width: 60px;}
  hr {border: none;border-top: 1px dashed var(--border-dark);margin: 15px 0;}
  /* ... ê¸°ì¡´ ê´€ë¦¬ì íŒ¨ë„ ìŠ¤íƒ€ì¼ ìœ ì§€ ... */
  
  /* ê´€ë¦¬ì í™•ì¥ íŒ¨ë„ (Player/Tile Management) */
  #adminExtPanel {
      display: flex;
      gap: 15px;
      margin-top: 10px;
  }
  #adminPlayerManagement, #adminTileManagement {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border-dark);
      max-height: 400px;
      overflow-y: auto;
  }
  #playerListContainer { max-height: 200px; overflow-y: auto; padding: 5px; }
  .player-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 5px; background: #222; border-radius: 3px; }
  .player-item button { padding: 3px 6px; font-size: 12px; }
  .player-item span { flex: 1; }
  
  /* ë¡œê·¸ì¸/ëª¨ë‹¬/Encounter ìŠ¤íƒ€ì¼ ìœ ì§€ */
  /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€) ... */
  
  /* ì•„ì´í…œ ì •ë³´ ëª¨ë‹¬ (ì¡°ìš° ëª¨ë‹¬ UI ì¬í™œìš©) */
  .modal-bg#itemModalBg .modal { min-width: 350px; max-width: 450px; }
  
  /* ê´€ë¦¬ì ì±„íŒ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ */
  .chat-admin-actions { margin-left: auto; display: none; gap: 5px; }
  .chat-admin-actions button { padding: 2px 5px; font-size: 10px; background: #555; }
</style>
</head>
<body>
<audio id="bgmAudio" loop preload="auto"></audio>

<div id="topBar">
    <div id="bgmControls"> 
        <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" title="ë³¼ë¥¨">
        <button id="bgmToggleBtn">PLAY</button> 
    </div>
    <div id="authControls">
        <input type="text" id="playerIdInput" placeholder="í”Œë ˆì´ì–´ ID">
        <button id="playerLoginBtn">í”Œë ˆì´ì–´ ë¡œê·¸ì¸</button>
        <button id="adminBtn">ê´€ë¦¬ì</button>
    </div>
</div>

<div id="mainContent">
    
    <div id="logChatPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; padding: 0; color: #fff; border: none;">ë¡œê·¸ ë° ì±„íŒ…</h4>
            <div style="position: relative;">
                <button id="archiveToggle" title="ê¸°ë¡ ë³´ê¸°">ğŸ’¾</button>
                <div id="archiveList"></div>
            </div>
        </div>
        <div id="logChatHistory">
            <div class="log-system">[SYSTEM] í™˜ì˜í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
        </div>
        <div id="chatInputArea">
            <input type="text" id="nicknameInput" placeholder="ë‹‰ë„¤ì„ (ê´€ë¦¬ìë§Œ ì‚¬ìš©)" style="display: none;">
            <div>
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." disabled>
                <button id="chatSendBtn" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="container">
        <canvas id="game" width="640" height="480"></canvas>
        <div id="grid"></div>
        <div id="dragGhost"></div> 
        <canvas id="passableOverlay" width="640" height="480" style="position:absolute;left:0;top:0;z-index:3;pointer-events:none;"></canvas>
    </div>
    
    <div id="statusInventoryPanel">
        <div id="playerStatus">
            <h4 style="text-align: center;">ìƒíƒœ</h4>
            <div>
                <span id="playerNameDisplay"></span>
                <span id="playerHPDisplay">HP: N/A</span>
            </div>
            <div id="hpBar"><div id="hpValue"></div></div>
        </div>
        
        <div id="inventoryPanel">
            <h4 style="text-align: center;">ì¸ë²¤í† ë¦¬</h4>
            <div id="inventoryGrid">
                </div>
        </div>
    </div>
    
</div>

<div id="adminPanel">
  <h4>ê´€ë¦¬ì íŒ¨ë„</h4>
  <div class="row"><label>ë§µ ì´ë¦„</label><input id="mapName" type="text"><button id="saveMap">ë§µ ì €ì¥</button></div>
  <div class="row"><label>ë§µ ì´ë¯¸ì§€</label><input id="mapUrl" type="text" placeholder="ì´ë¯¸ì§€ URL"></div>
  <div class="row"><label>ìºë¦­í„°</label><input id="spriteUrl" type="text" placeholder="ìŠ¤í”„ë¼ì´íŠ¸ URL"></div>
  <div class="row"><label>BGM URL</label><input id="bgmUrl" type="text" placeholder="ë°°ê²½ìŒì•… URL"></div> 
  <div class="row">
      <label>ì‹œì‘ ì¢Œí‘œ</label>
      <input id="startX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
      <input id="startY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
      <button id="setPlayerPos" style="flex-shrink: 0;">ì„¤ì •</button>
  </div>
  
  <div class="control-group"> 
    <button id="reload">ë¡œë“œ</button>
    <button id="toggleGrid">ê·¸ë¦¬ë“œ</button>
    <button id="toggleEncounter">ì¡°ìš°</button> 
  </div>
  <hr>
  <div class="row" style="margin-bottom: 10px;"><button id="deleteAllEncounters" style="background: #880000; border-color: #aa0000; flex-grow: 1;">ëª¨ë“  ì¡°ìš° ì‚­ì œ</button></div>
  <div class="enc-list" id="encList"></div>
  <div id="mapButtons" style="margin-top:10px;"></div>
  
  <hr>
  <div id="adminExtPanel">
      <div id="adminPlayerManagement">
          <h4 style="border: none; margin-bottom: 5px;">í”Œë ˆì´ì–´/ì•„ì´í…œ/HP ê´€ë¦¬</h4>
          <div class="row"><input type="text" id="newPlayerId" placeholder="ìƒˆ í”Œë ˆì´ì–´ ID"><input type="text" id="newPlayerCharUrl" placeholder="ìºë¦­í„° ì´ë¯¸ì§€ URL"><button id="createPlayerBtn">ìƒì„±</button></div>
          <div class="row"><input type="text" id="newItemId" placeholder="ì•„ì´í…œ ID"><input type="text" id="newItemName" placeholder="ì•„ì´í…œ ì´ë¦„"><input type="text" id="newItemUrl" placeholder="ì•„ì´í…œ ì´ë¯¸ì§€ URL"><button id="createItemBtn">ì•„ì´í…œ ì •ì˜</button></div>
          <p style="font-size: 12px; margin: 5px 0; color: #888;">* ì•„ì´í…œ ì •ì˜ëŠ” ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ì ìš©ë©ë‹ˆë‹¤.</p>
          
          <h5 style="margin: 10px 0 5px 0; color: #aaa;">í”Œë ˆì´ì–´ ëª©ë¡ ë° ìƒíƒœ ìˆ˜ì •</h5>
          <div id="playerListContainer">
              </div>
      </div>
      <div id="adminTileManagement">
          <h4 style="border: none; margin-bottom: 5px;">ë§µ ì´ë™ ì œí•œ ì„¤ì •</h4>
          <div class="row"><button id="togglePassableOverlay">ì œí•œ ì˜ì—­ ë³´ê¸°</button><button id="setPassableTile">ì´ë™ ê°€ëŠ¥ íƒ€ì¼ ì„¤ì •</button></div>
          <div class="row"><p style="font-size: 12px; margin: 0; color: #888;">* í´ë¦­ ì‹œ ì´ë™ ì œí•œ(ë¹¨ê°„ìƒ‰)/ë”ë¸”í´ë¦­ ì‹œ ì´ë™ ê°€ëŠ¥(ì´ˆë¡ìƒ‰)ìœ¼ë¡œ í† ê¸€ë©ë‹ˆë‹¤.</p></div>
          <div id="passableMapList">
              </div>
      </div>
  </div>
  
</div>

<div id="loginBox">
  <div>ê´€ë¦¬ì ë¡œê·¸ì¸</div>
  <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
  <button id="loginBtn">ë¡œê·¸ì¸</button>
</div>

<div class="modal-bg" id="editModal">
  <div class="modal">
    <h4>ì¡°ìš° ìˆ˜ì •</h4>
    <label>ì´ë¦„</label><input id="encName" type="text">
    <label>ì§€ë¬¸</label><textarea id="encText" placeholder="ì¡°ìš° ì‹œ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì¼ ì§€ë¬¸" rows="3"></textarea>
    <label>ìºë¦­í„° ì´ë¯¸ì§€ URL</label><input id="encCharUrl" type="text" placeholder="ì¡°ìš° ì‹œ ë„ìš¸ ì´ë¯¸ì§€ URL">
    
    <label id="choicesLabel">ì„ íƒì§€</label> <div id="choices"></div>
    <div id="addChoiceContainer" style="text-align: right;"><button id="addChoice">ì„ íƒì§€ ì¶”ê°€</button></div>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ ì‚¬ìš©)</label>
    <select id="encTrigger">
        <option value="none">ì—†ìŒ</option>
        <option value="sound">ì‚¬ìš´ë“œ</option>
        <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
        <option value="map">ë§µ ì „í™˜</option>
        <option value="item">ì•„ì´í…œ íšë“</option> <option value="hp">HP ë³€ê²½</option> </select>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° ë°ì´í„°(URL/ë§µëª…/ItemID/HPê°’)</label><input id="encData" type="text">
    
    <div style="margin-top:20px;text-align:right">
      <button id="saveEncEdit">ì €ì¥</button>
      <button id="closeEncEdit">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="encounterModalBg">
    <div class="modal" id="encounterModal">
        <div class="char-img-container" id="encCharImgContainer">
            <img id="encCharImg" alt="Encounter Character" style="display:none;"/>
        </div>
        <h4 id="encModalName"></h4>
        <div class="info-text" id="encModalText"></div>
        <div id="encounterChoices"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeEncounterModal">ê³„ì† ì§„í–‰</button></div>
    </div>
</div>

<div class="modal-bg" id="itemModalBg">
    <div class="modal">
        <h4 id="itemModalName">ì•„ì´í…œ ì •ë³´</h4>
        <div class="char-img-container" style="height: 150px;"><img id="itemModalImg" alt="Item Image" style="display:none; object-fit: contain;"/></div>
        <div class="info-text" id="itemModalDescription"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeItemModal">ë‹«ê¸°</button></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
// StorageëŠ” íŒŒì¼ ì—…ë¡œë“œ ë¯¸êµ¬í˜„ìœ¼ë¡œ ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬
// import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtPPF9Y93XVKHjo5_mmmxycf0CUJjWIRo",
  authDomain: "horror-game-14aa8.firebaseapp.com",
  projectId: "horror-game-14aa8",
  storageBucket: "horror-game-14aa8.firebasestorage.app",
  messagingSenderId: "125297141331",
  appId: "1:125297141331:web:a15f971c34dde0c7d708a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// const storage = getStorage(app); // Storage ë¯¸ì‚¬ìš©

const ADMIN_EMAIL = "test@gmail.com";
const DEFAULT_MAX_HP = 100;
const MAX_INVENTORY_SLOTS = 12;

/* --- ì „ì—­ ìƒíƒœ --- */
const GRID = 32;
let currentPlayerId = null;
let currentPlayerData = null;
let isAdmin = false;
let isLoggedIn = false;
let currentMapName = null;
let encounterPoints = [];
let itemsDefinitions = {};
let mapPassable = {}; // { 'x,y': true/false }
let player = JSON.parse(localStorage.getItem('playerPos') || '{"x":2,"y":2}');

/* --- UI ìš”ì†Œ ë°”ì¸ë”© (ì¶”ê°€ ë° ë³€ê²½) --- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const logChatPanel = document.getElementById('logChatPanel');
const statusInventoryPanel = document.getElementById('statusInventoryPanel');
const mapContainer = document.getElementById('container');
const adminPanel = document.getElementById('adminPanel');
const logChatHistory = document.getElementById('logChatHistory');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const nicknameInput = document.getElementById('nicknameInput');
const archiveToggle = document.getElementById('archiveToggle');
const archiveList = document.getElementById('archiveList');
const playerNameDisplay = document.getElementById('playerNameDisplay');
const playerHPDisplay = document.getElementById('playerHPDisplay');
const hpValue = document.getElementById('hpValue');
const inventoryGrid = document.getElementById('inventoryGrid');
const itemModalBg = document.getElementById('itemModalBg');
const itemModalName = document.getElementById('itemModalName');
const itemModalImg = document.getElementById('itemModalImg');
const itemModalDescription = document.getElementById('itemModalDescription');
const passableOverlay = document.getElementById('passableOverlay');
const passableCtx = passableOverlay.getContext('2d');
const playerIdInput = document.getElementById('playerIdInput');
const playerLoginBtn = document.getElementById('playerLoginBtn');
const adminBtn = document.getElementById('adminBtn'); // ì´ì œ 'ë¡œê·¸ì•„ì›ƒ' ë²„íŠ¼
const adminPwInput = document.getElementById('adminPw');
const loginBtn = document.getElementById('loginBtn');
const mainContent = document.getElementById('mainContent');
const togglePassableOverlayBtn = document.getElementById('togglePassableOverlay');

/* --- Firebase Unsubscribers --- */
let mapDocUnsub = null;
let chatUnsub = null;
let userUnsub = null;
let allUsersUnsub = null;
let itemsUnsub = null;
let archiveCloseBtn = null; // ì•„ì¹´ì´ë¸Œ ë‹«ê¸° ë²„íŠ¼

/* --- ê¸°ì¡´ UI ìš”ì†Œ ë°”ì¸ë”© (ë‚˜ë¨¸ì§€ ìœ ì§€) --- */
let mapImg = new Image(), sprite = new Image();
let showGrid = true;
let adding = false;
let currentEdit = -1;
let mapList = JSON.parse(localStorage.getItem('mapList') || '[]');
let isDragging = false;
let draggedEncIndex = -1;
const dragGhost = document.getElementById('dragGhost');
const mapNameInput = document.getElementById('mapName');
const mapUrlInput = document.getElementById('mapUrl');
const spriteUrlInput = document.getElementById('spriteUrl');
const bgmUrlInput = document.getElementById('bgmUrl');
const bgmAudio = document.getElementById('bgmAudio');
const bgmToggleBtn = document.getElementById('bgmToggleBtn');
const bgmVolume = document.getElementById('bgmVolume');
const toggleGridBtn = document.getElementById('toggleGrid');
const toggleEncounterBtn = document.getElementById('toggleEncounter');
const deleteAllEncountersBtn = document.getElementById('deleteAllEncounters');

/* ========================================================================= */
/* UI/LAYOUT FUNCTIONS                          */
/* ========================================================================= */

/** ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ì „ì²´ UI ê°€ì‹œì„± ì—…ë°ì´íŠ¸ */
function updateUIVisibility() {
    logChatPanel.style.display = isLoggedIn ? 'flex' : 'none';
    statusInventoryPanel.style.display = isLoggedIn ? 'flex' : 'none';
    adminPanel.style.display = (isLoggedIn && isAdmin) ? 'block' : 'none';
    
    // ë§µì€ í•­ìƒ í‘œì‹œë˜ì§€ë§Œ, ìºë¦­í„°ëŠ” ë¡œê·¸ì¸ ì‹œì—ë§Œ
    if (!isLoggedIn) {
        // ë¯¸ë¡œê·¸ì¸ ì‹œ: ë§µë§Œ ë³´ì´ê²Œ
        canvas.style.opacity = 1;
    } else {
        // ë¡œê·¸ì¸ ì‹œ
    }
    
    // ì±„íŒ… ì…ë ¥ ê°€ëŠ¥/ë¶ˆê°€ëŠ¥ ì„¤ì •
    chatInput.disabled = !isLoggedIn;
    chatSendBtn.disabled = !isLoggedIn;
    nicknameInput.style.display = isAdmin ? 'block' : 'none';

    draw(); // ìºë¦­í„° í‘œì‹œ/ìˆ¨ê¹€ì„ ìœ„í•´ ë§µ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
}

/** HP ë°” ì—…ë°ì´íŠ¸ */
function updateStatusPanel() {
    if (!currentPlayerData) return;
    const { id, hp, maxHp } = currentPlayerData;
    
    playerNameDisplay.textContent = `í”Œë ˆì´ì–´: ${id}`;
    playerHPDisplay.textContent = `HP: ${hp}/${maxHp}`;
    
    const percent = maxHp > 0 ? (hp / maxHp) * 100 : 0;
    hpValue.style.width = `${percent}%`;
    hpValue.style.backgroundColor = percent > 50 ? '#27ae60' : percent > 20 ? '#f39c12' : '#e74c3c';
    hpValue.textContent = `${hp}`;
    
    drawInventory();
}

/** ì¸ë²¤í† ë¦¬ ê·¸ë¦¬ê¸° ë° ì•„ì´í…œ íŒì—… ì²˜ë¦¬ */
function drawInventory() {
    inventoryGrid.innerHTML = '';
    const inventory = currentPlayerData?.inventory || [];
    
    // 1. ì‹¤ì œ ì†Œìœ  ì•„ì´í…œ í‘œì‹œ
    inventory.forEach(itemId => {
        const itemDef = itemsDefinitions[itemId];
        const slot = document.createElement('div');
        slot.className = 'item-slot';
        slot.dataset.itemId = itemId;
        
        if (itemDef?.url) {
            const img = document.createElement('img');
            img.src = itemDef.url;
            img.alt = itemDef.name || 'ì•„ì´í…œ';
            slot.appendChild(img);
        } else {
            slot.textContent = itemId.slice(0, 3);
        }
        
        slot.onclick = () => openItemModal(itemId);
        inventoryGrid.appendChild(slot);
    });

    // 2. ë¹ˆ ìŠ¬ë¡¯ ì±„ìš°ê¸°
    for (let i = inventory.length; i < MAX_INVENTORY_SLOTS; i++) {
        const slot = document.createElement('div');
        slot.className = 'item-slot empty';
        inventoryGrid.appendChild(slot);
    }
}

/** ì•„ì´í…œ ìƒì„¸ ì •ë³´ íŒì—… */
function openItemModal(itemId) {
    const itemDef = itemsDefinitions[itemId];
    if (!itemDef) return;
    
    itemModalName.textContent = itemDef.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ';
    itemModalDescription.textContent = itemDef.description || 'ì•„ì´í…œ ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.';
    
    if (itemDef.url) {
        itemModalImg.src = itemDef.url;
        itemModalImg.style.display = 'block';
    } else {
        itemModalImg.style.display = 'none';
    }
    
    document.getElementById('itemModalBg').style.display = 'flex';
}
document.getElementById('closeItemModal').onclick = () => {
    document.getElementById('itemModalBg').style.display = 'none';
};

/** ë¡œê·¸/ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥ */
function printLog(message, type = 'system', senderId = null) {
    const d = document.createElement('div');
    d.className = `log-message log-${type}`;
    let content = message;
    
    if (type === 'chat' && senderId) {
        const isSelf = senderId === currentPlayerId;
        const sender = isSelf ? 'ë‚˜' : (senderId === 'admin' ? nicknameInput.value || 'ê´€ë¦¬ì' : senderId);
        const nameClass = senderId === 'admin' ? 'admin-name' : '';
        content = `<b><span class="${nameClass}">${sender}</span>:</b> ${message}`;
        
        if (isAdmin) {
            d.innerHTML += `<span class="chat-admin-actions" data-chat-id="${d.dataset.chatId || 'local'}">
                <button class="editChatBtn">ìˆ˜ì •</button>
                <button class="deleteChatBtn">ì‚­ì œ</button>
            </span>`;
            // ê´€ë¦¬ì ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ (CSSë¡œ ì œì–´)
        }
    } else if (type === 'system') {
        content = `[SYSTEM] ${message}`;
    }
    
    d.innerHTML = content;
    logChatHistory.appendChild(d);
    logChatHistory.scrollTop = logChatHistory.scrollHeight;
}

/** ì´ë™ ë¶ˆê°€ íƒ€ì¼ ì˜¤ë²„ë ˆì´ ê·¸ë¦¬ê¸° (ê´€ë¦¬ì ëª¨ë“œ) */
function drawPassableOverlay() {
    passableCtx.clearRect(0, 0, passableOverlay.width, passableOverlay.height);
    if (!isAdmin || !togglePassableOverlayBtn.classList.contains('active')) return;

    for (let y = 0; y < canvas.height / GRID; y++) {
        for (let x = 0; x < canvas.width / GRID; x++) {
            const key = `${x},${y}`;
            const isPassable = mapPassable[key] === true;
            
            if (mapPassable.hasOwnProperty(key)) {
                passableCtx.fillStyle = isPassable ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)';
                passableCtx.fillRect(x * GRID, y * GRID, GRID, GRID);
                passableCtx.strokeStyle = isPassable ? '#0f0' : '#f00';
                passableCtx.strokeRect(x * GRID + 1, y * GRID + 1, GRID - 2, GRID - 2);
            }
        }
    }
}

togglePassableOverlayBtn.onclick = () => {
    togglePassableOverlayBtn.classList.toggle('active');
    drawPassableOverlay();
    // ë§µ í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™”/ë¹„í™œì„±í™”
    canvas.onclick = togglePassableOverlayBtn.classList.contains('active') ? handleTileSet : handleMapClick;
};

// ë§µ í´ë¦­ ì‹œ íƒ€ì¼ ì„¤ì • (ê´€ë¦¬ì ëª¨ë“œ)
function handleTileSet(ev) {
    if (!isAdmin || !togglePassableOverlayBtn.classList.contains('active')) return;
    const r = canvas.getBoundingClientRect();
    const x = Math.floor((ev.clientX - r.left) / (r.width / (canvas.width / GRID)));
    const y = Math.floor((ev.clientY - r.top) / (r.height / (canvas.height / GRID)));
    const key = `${x},${y}`;

    // ê¸°ë³¸ì ìœ¼ë¡œ ì œí•œ (í´ë¦­)
    if (mapPassable[key] === false) {
        delete mapPassable[key]; // ì œí•œ í•´ì œ (ì´ë™ ê°€ëŠ¥)
    } else {
        mapPassable[key] = false; // ì œí•œ ì„¤ì • (ì´ë™ ë¶ˆê°€)
    }

    saveMapDataToFirestore(currentMapName || 'default_map');
    drawPassableOverlay();
}

canvas.ondblclick = (ev) => {
    if (!isAdmin || !togglePassableOverlayBtn.classList.contains('active')) return;
    const r = canvas.getBoundingClientRect();
    const x = Math.floor((ev.clientX - r.left) / (r.width / (canvas.width / GRID)));
    const y = Math.floor((ev.clientY - r.top) / (r.height / (canvas.height / GRID)));
    const key = `${x},${y}`;

    // ë”ë¸”í´ë¦­ ì‹œ ì´ë™ ê°€ëŠ¥ ì„¤ì •
    if (mapPassable[key] === true) {
        delete mapPassable[key]; // ì„¤ì • í•´ì œ (ë§µ ê¸°ë³¸ ì„¤ì • ë”°ë¦„)
    } else {
        mapPassable[key] = true; // ì´ë™ ê°€ëŠ¥ ì„¤ì •
    }

    saveMapDataToFirestore(currentMapName || 'default_map');
    drawPassableOverlay();
};


/* ========================================================================= */
/* FIREBASE INTEGRATION                         */
/* ========================================================================= */

/** ì•„ì´í…œ ì •ì˜ ë¦¬ìŠ¤ë„ˆ */
function subscribeToItemDefinitions() {
    if (itemsUnsub) itemsUnsub();
    itemsUnsub = onSnapshot(doc(db, 'globals', 'items'), (docSnap) => {
        if (docSnap.exists()) {
            itemsDefinitions = docSnap.data().definitions || {};
            // ì•„ì´í…œ ì •ì˜ê°€ ì—…ë°ì´íŠ¸ë˜ë©´ ì¸ë²¤í† ë¦¬ ë° ëª¨ë‹¬ì„ ë‹¤ì‹œ ê·¸ë¦¼
            if (isLoggedIn) {
                updateStatusPanel();
            }
        }
    });
}
subscribeToItemDefinitions(); // ì´ˆê¸° í˜¸ì¶œ

/** í”Œë ˆì´ì–´ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ */
function subscribeToPlayerData(userId) {
    if (userUnsub) userUnsub();
    const userRef = doc(db, 'users', userId);
    userUnsub = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            currentPlayerData = { id: userId, ...docSnap.data() };
            // HP, ì¸ë²¤í† ë¦¬, ë°œê²¬ ì¡°ìš° ëª©ë¡ ë“± ì—…ë°ì´íŠ¸
            updateStatusPanel();
            checkGameCompletion();
        } else {
            currentPlayerData = null;
            // ë¯¸ë¡œê·¸ì¸ ìƒíƒœë¡œ ë³µê·€ ì²˜ë¦¬
            logoutUser();
        }
    }, err => console.error('í”Œë ˆì´ì–´ ë°ì´í„° êµ¬ë… ì‹¤íŒ¨:', err));
}

/** ëª¨ë“  í”Œë ˆì´ì–´ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (ê´€ë¦¬ììš©) */
function subscribeToAllPlayers() {
    if (!isAdmin) return;
    if (allUsersUnsub) allUsersUnsub();
    const q = collection(db, 'users');
    allUsersUnsub = onSnapshot(q, (snapshot) => {
        const allPlayers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        redrawPlayerList(allPlayers);
    }, err => console.error('ëª¨ë“  í”Œë ˆì´ì–´ ë°ì´í„° êµ¬ë… ì‹¤íŒ¨:', err));
}

/** ì±„íŒ… ë¦¬ìŠ¤ë„ˆ */
function subscribeToChat() {
    if (chatUnsub) chatUnsub();
    const chatRef = collection(db, 'chats');
    const q = query(chatRef, where('mapName', '==', currentMapName || 'default_map'));
    
    // ì„ì‹œ: ëª¨ë“  ì±„íŒ… ë¡œë“œ í›„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
    chatUnsub = onSnapshot(q, (snapshot) => {
        // ì±„íŒ…ì°½ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨ (ê°„ë‹¨ êµ¬í˜„)
        logChatHistory.innerHTML = '';
        snapshot.docs.sort((a, b) => a.data().timestamp - b.data().timestamp).forEach(doc => {
            const data = doc.data();
            printLog(data.message, 'chat', data.senderId);
        });
        printLog(`[SYSTEM] ë§µ [${currentMapName || 'default_map'}] ì±„íŒ… ê¸°ë¡ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'system');
    }, err => console.error('ì±„íŒ… êµ¬ë… ì‹¤íŒ¨:', err));
}

/** ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ */
function logoutUser() {
    currentPlayerId = null;
    currentPlayerData = null;
    isLoggedIn = false;
    
    // Unsubscribe
    if (userUnsub) userUnsub();
    if (chatUnsub) chatUnsub();
    if (allUsersUnsub) allUsersUnsub();
    
    // UI ì´ˆê¸°í™”
    document.getElementById('playerNameDisplay').textContent = '';
    document.getElementById('playerHPDisplay').textContent = '';
    hpValue.style.width = '0%';
    inventoryGrid.innerHTML = '';
    logChatHistory.innerHTML = '<div class="log-system">[SYSTEM] ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
    
    updateUIVisibility();
}

/* ========================================================================= */
/* AUTHENTICATION / LOGIN                       */
/* ========================================================================= */

/** í”Œë ˆì´ì–´ ID-Only ë¡œê·¸ì¸ */
playerLoginBtn.onclick = async () => {
    const id = playerIdInput.value.trim();
    if (!id) { printLog('IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    
    try {
        const userRef = doc(db, 'users', id);
        const docSnap = await getDoc(userRef);
        
        if (!docSnap.exists() || docSnap.data().isAdmin) {
            printLog('ìœ íš¨í•˜ì§€ ì•Šì€ í”Œë ˆì´ì–´ IDì…ë‹ˆë‹¤.');
            return;
        }
        
        currentPlayerId = id;
        currentPlayerData = { id, ...docSnap.data() };
        isLoggedIn = true;
        isAdmin = false;
        
        // ë°ì´í„° êµ¬ë… ì‹œì‘
        subscribeToPlayerData(id);
        subscribeToChat();
        
        updateUIVisibility();
        printLog(`[SYSTEM] í”Œë ˆì´ì–´ **${id}**ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'system');
        
    } catch (err) {
        printLog('í”Œë ˆì´ì–´ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message, 'system');
        console.error(err);
    }
};

/** ê´€ë¦¬ì ë¡œê·¸ì¸ */
loginBtn.onclick = async () => {
    const pw = adminPwInput.value.trim();
    if (!pw) { printLog('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    
    try {
        const userCredential = await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pw);
        
        currentPlayerId = 'admin';
        currentPlayerData = {
            id: 'admin',
            hp: DEFAULT_MAX_HP,
            maxHp: DEFAULT_MAX_HP,
            isAdmin: true,
            inventory: [],
            charImgUrl: spriteUrlInput.value,
            discoveredEncounters: []
        };
        isLoggedIn = true;
        isAdmin = true;
        
        // ë°ì´í„° êµ¬ë… ì‹œì‘ (ê´€ë¦¬ìëŠ” ëª¨ë“  ìœ ì € êµ¬ë…)
        subscribeToChat();
        subscribeToAllPlayers();
        
        adminPwInput.value = '';
        document.getElementById('loginBox').style.display = 'none';
        
        updateUIVisibility();
        printLog('[SYSTEM] **ê´€ë¦¬ì**ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'system');
        
    } catch (err) {
        printLog('ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + err.message, 'system');
        console.error(err);
    }
};

/** ê´€ë¦¬ì/ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ */
function updateAdminButton() {
    if (isLoggedIn) {
        adminBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
        adminBtn.onclick = () => {
            if (isAdmin) {
                signOut(auth).catch(err => console.error('ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨', err));
                isAdmin = false;
            }
            logoutUser();
        };
    } else {
        adminBtn.textContent = 'ê´€ë¦¬ì';
        adminBtn.onclick = () => document.getElementById('loginBox').style.display = 'flex';
    }
}
onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        // Firebase Authë¥¼ í†µí•œ ê´€ë¦¬ì ìƒíƒœ ìœ ì§€ (Admin Logged In)
        currentPlayerId = 'admin';
        currentPlayerData = {
            id: 'admin',
            hp: DEFAULT_MAX_HP, maxHp: DEFAULT_MAX_HP, isAdmin: true, inventory: [], charImgUrl: spriteUrlInput.value, discoveredEncounters: []
        };
        isLoggedIn = true;
        isAdmin = true;
        
        document.getElementById('loginBox').style.display = 'none';
        
        subscribeToChat();
        subscribeToAllPlayers();
        updateUIVisibility();
        
    } else if (isAdmin) {
        // Firebase ë¡œê·¸ì•„ì›ƒ ì‹œ ê´€ë¦¬ì ìƒíƒœ í•´ì œ
        logoutUser();
    }
    updateAdminButton();
});

/* ========================================================================= */
/* CHAT & LOGGING                               */
/* ========================================================================= */

/** ì±„íŒ… ì „ì†¡ */
chatSendBtn.onclick = async () => {
    const msg = chatInput.value.trim();
    if (!isLoggedIn || !msg) return;
    
    const senderId = isAdmin ? 'admin' : currentPlayerId;
    const chatData = {
        senderId: senderId,
        message: msg,
        mapName: currentMapName || 'default_map',
        timestamp: Date.now()
    };
    
    try {
        const newChatRef = doc(collection(db, 'chats'));
        await setDoc(newChatRef, chatData);
        chatInput.value = '';
    } catch (err) {
        printLog('ì±„íŒ… ì „ì†¡ ì‹¤íŒ¨: ' + err.message, 'system');
    }
};

/** ì•„ì¹´ì´ë¸Œ ë¦¬ìŠ¤íŠ¸ í† ê¸€ ë° ë¡œë“œ */
archiveToggle.onclick = async () => {
    if (archiveList.style.display === 'block') {
        archiveList.style.display = 'none';
        return;
    }
    
    // ì„ì‹œ: ì•„ì¹´ì´ë¸Œ ëª©ë¡ ë¡œë“œ (ì‹¤ì œ êµ¬í˜„ í•„ìš”)
    archiveList.innerHTML = '<div class="archive-item">2023-10-20 ê¸°ë¡ (ì˜ˆì‹œ)</div>';
    archiveList.style.display = 'block';
    
    archiveList.querySelectorAll('.archive-item').forEach(item => {
        item.onclick = () => loadArchive(item.textContent.split(' ')[0]);
    });
};

/** ì•„ì¹´ì´ë¸Œ ë¡œë“œ (ê¸°ë¡ ë³´ê¸°) */
function loadArchive(date) {
    // 1. í˜„ì¬ ì±„íŒ…ì°½ ë‚´ìš©ì„ ì„ì‹œ ì €ì¥í•˜ê³  ì•„ì¹´ì´ë¸Œ ë©”ì‹œì§€ë¡œ êµì²´
    const archiveContent = `[SYSTEM] ${date} ì•„ì¹´ì´ë¸Œ ë¡œë“œ (ì‹¤ì œ ë°ì´í„° ì—†ìŒ).`;
    logChatHistory.innerHTML = `<div class="log-system">${archiveContent}</div>`;
    
    // 2. ë©”ì‹œì§€ ì…ë ¥ ì°½ì— ë‹«ê¸° ë²„íŠ¼ ìƒì„± ë° ê¸°ëŠ¥ ë¶€ì—¬
    const inputArea = document.getElementById('chatInputArea');
    if (!archiveCloseBtn) {
        archiveCloseBtn = document.createElement('button');
        archiveCloseBtn.textContent = 'ë‹«ê¸°';
        archiveCloseBtn.onclick = restoreChat;
        archiveCloseBtn.id = 'archiveCloseBtn';
    }
    
    // ì±„íŒ… ì…ë ¥/ì „ì†¡ ë²„íŠ¼ ìˆ¨ê¸°ê³  ë‹«ê¸° ë²„íŠ¼ í‘œì‹œ
    inputArea.querySelector('div').style.display = 'none';
    inputArea.appendChild(archiveCloseBtn);
}

/** ì‹¤ì‹œê°„ ì±„íŒ…ìœ¼ë¡œ ë³µê·€ */
function restoreChat() {
    // 1. ë‹«ê¸° ë²„íŠ¼ ì œê±°
    if (archiveCloseBtn) archiveCloseBtn.remove();
    
    // 2. ì±„íŒ… ì…ë ¥/ì „ì†¡ ë²„íŠ¼ í‘œì‹œ
    document.getElementById('chatInputArea').querySelector('div').style.display = 'flex';
    
    // 3. ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ì¬í™œì„±í™” (ì‹¤ì‹œê°„ ì±„íŒ… ë¡œë“œ)
    subscribeToChat();
}

/* ========================================================================= */
/* GAMEPLAY LOGIC (UPDATED)                     */
/* ========================================================================= */

/** í”Œë ˆì´ì–´ ì´ë™ (ì—…ë°ì´íŠ¸: ì´ë™ ì œí•œ íƒ€ì¼ ì²´í¬) */
function movePlayer(dx, dy) {
    if (!isLoggedIn || isEncounterActive) return;
    const nx = player.x + dx, ny = player.y + dy;
    
    // 1. ë§µ ê²½ê³„ ì²´í¬
    if (nx < 0 || ny < 0 || nx >= canvas.width / GRID || ny >= canvas.height / GRID) return;
    
    // 2. ì´ë™ ì œí•œ íƒ€ì¼ ì²´í¬
    const key = `${nx},${ny}`;
    const isRestricted = mapPassable.hasOwnProperty(key) && mapPassable[key] === false;

    if (isRestricted) {
        printLog('ë” ì´ìƒ ë‚˜ì•„ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì´ë™ ì œí•œ íƒ€ì¼)', 'system');
        return;
    }

    // 3. ì´ë™ ë° ì €ì¥
    printLog(`'${currentPlayerId}' ê°€ (${nx},${ny}) (ìœ¼)ë¡œ ì´ë™í•˜ì˜€ìŠµë‹ˆë‹¤.`, 'system', currentPlayerId);
    player.x = nx; player.y = ny;
    localStorage.setItem('playerPos', JSON.stringify(player));
    draw();
    checkEncounter();
}

/** ì¡°ìš° ì²˜ë¦¬ (ì—…ë°ì´íŠ¸: ì•„ì´í…œ íšë“ ë° HP ë³€ê²½ íŠ¸ë¦¬ê±° ë°˜ì˜) */
let isEncounterActive = false;
let currentEncounter = null;
let currentEncounterIndex = -1;

function checkEncounter() {
    if (!isLoggedIn || isEncounterActive) return;
    
    currentEncounterIndex = encounterPoints.findIndex(p => p.x === player.x && p.y === player.y);
    const e = encounterPoints[currentEncounterIndex];
    if (!e) return;
    
    currentEncounter = e;
    isEncounterActive = true;
    
    // 1. ì´ë¯¸ ë°œê²¬í•œ ì¡°ìš°ì¸ì§€ ì²´í¬ (ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬ë¥¼ ìœ„í•´)
    const encounterKey = `${e.x},${e.y}:${e.name}`;
    const alreadyDiscovered = currentPlayerData.discoveredEncounters.includes(encounterKey);
    if (!alreadyDiscovered) {
        // DBì— ì¡°ìš° ê¸°ë¡
        updateDoc(doc(db, 'users', currentPlayerId), {
            discoveredEncounters: arrayUnion(encounterKey)
        }).catch(err => console.error('ì¡°ìš° ê¸°ë¡ ì‹¤íŒ¨:', err));
        printLog(`'${currentPlayerId}' ê°€ (${e.x},${e.y}) ì—ì„œ ê·€ì‹ ê³¼ ì¡°ìš°í•˜ì˜€ìŠµë‹ˆë‹¤.`, 'system', currentPlayerId);
    }

    fadeScreen((resume) => {
        const choices = e.choices || [];
        const choiceContainer = document.getElementById('encounterChoices');
        
        setCharacterImage(e.charUrl, false);
        document.getElementById('encModalName').textContent = e.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì¡°ìš°';
        document.getElementById('encModalText').textContent = e.text || '...\n(ì§€ë¬¸ ì—†ìŒ)';
        choiceContainer.innerHTML = '';
        
        // 2. ì•„ì´í…œ ì¤‘ë³µ íšë“ ì²´í¬ (ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ)
        let isItemAlreadyTaken = false;
        if (choices.length === 0 && e.trigger === 'item') {
            const itemKey = `${currentMapName}:${e.data}`;
            if (currentPlayerData.inventory.includes(e.data)) {
                 document.getElementById('encModalText').textContent = '(í…… ë¹„ì–´ ìˆë‹¤...)';
                 isItemAlreadyTaken = true;
            }
        }
        
        if (choices.length > 0 && !isItemAlreadyTaken) {
            document.getElementById('closeEncounterModal').style.display = 'none';
            choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.textContent = choice.text || `ì„ íƒì§€ ${index + 1}`;
                btn.onclick = () => handleChoice(e, choice, resume);
                choiceContainer.appendChild(btn);
            });
        } else {
            // ì„ íƒì§€ê°€ ì—†ê±°ë‚˜ ì•„ì´í…œì„ ì´ë¯¸ ì–»ì€ ê²½ìš°
            document.getElementById('closeEncounterModal').style.display = 'block';
            if (!isItemAlreadyTaken) {
                // ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì•„ì´í…œ ì¤‘ë³µ íšë“ì´ ì•„ë‹Œ ê²½ìš°)
                if (e.trigger === 'image' && e.data) {
                    setCharacterImage(e.data, true);
                }
            }
        }
        
        document.getElementById('encounterModalBg').style.display = 'flex';
        document.getElementById('closeEncounterModal').onclick = () => {
            document.getElementById('encounterModalBg').style.display = 'none';
            isEncounterActive = false;
            if (choices.length === 0 && !isItemAlreadyTaken) {
                 executeTrigger(e.trigger, e.data, e);
            }
            resume();
        };
    });
}

/** ì¡°ìš° ì„ íƒì§€ ì²˜ë¦¬ */
function handleChoice(encounter, choice, resume) {
    const choiceContainer = document.getElementById('encounterChoices');
    
    // 1. ì„ íƒ ê²°ê³¼ ì§€ë¬¸ í‘œì‹œ
    document.getElementById('encModalText').textContent = choice.resultText || `${choice.text} ì„ íƒ.`;
    choiceContainer.innerHTML = ''; // ì„ íƒ ë²„íŠ¼ ì œê±°
    document.getElementById('closeEncounterModal').style.display = 'block';
    
    // 2. ì´ë¯¸ì§€ ë³€ê²½
    if (choice.trigger === 'image') {
        setCharacterImage(choice.data, true);
    } else {
        setCharacterImage(encounter.charUrl, false);
    }

    // 3. íŠ¸ë¦¬ê±° ì‹¤í–‰ ì¤€ë¹„
    document.getElementById('closeEncounterModal').onclick = () => {
        document.getElementById('encounterModalBg').style.display = 'none';
        isEncounterActive = false;
        
        executeTrigger(choice.trigger, choice.data, encounter);
        resume();
    };
}

/** íŠ¸ë¦¬ê±° ì‹¤í–‰ (ì•„ì´í…œ íšë“ ë° HP ë³€ê²½ ê¸°ëŠ¥ ì¶”ê°€) */
function executeTrigger(trigger, data, encounter) {
    if (!trigger || trigger === 'none' || trigger === 'image') return;
    
    if (trigger === 'sound') {
        const audio = new Audio(data || '');
        audio.play().catch(err => console.error("Sound play failed:", err));
    }
    else if (trigger === 'map') {
        if (data) loadMapDataFromFirestore(data).catch(err => alert('ë§µ ì „í™˜ ì‹¤íŒ¨: ' + err.message));
        else printLog('ë§µ íŠ¸ë¦¬ê±°ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'system');
    }
    else if (trigger === 'item') {
        acquireItem(data, encounter);
    }
    else if (trigger === 'hp') {
        changeHP(data);
    }
}

/** ì•„ì´í…œ íšë“ ê¸°ëŠ¥ */
function acquireItem(itemId, encounter) {
    if (!itemId) return printLog('íšë“í•  ì•„ì´í…œ IDê°€ ì—†ìŠµë‹ˆë‹¤.', 'system');
    
    // ì¤‘ë³µ íšë“ ë°©ì§€ ë° ì¸ë²¤í† ë¦¬ ì—…ë°ì´íŠ¸
    if (currentPlayerData.inventory.includes(itemId)) {
        return printLog(`ì´ë¯¸ ì•„ì´í…œ [${itemsDefinitions[itemId]?.name || itemId}]ì„(ë¥¼) ì†Œìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤.`, 'system');
    }
    
    // Firebase ì—…ë°ì´íŠ¸
    updateDoc(doc(db, 'users', currentPlayerId), {
        inventory: arrayUnion(itemId)
    }).then(() => {
        printLog(`[SYSTEM] ì•„ì´í…œ **${itemsDefinitions[itemId]?.name || itemId}**ì„(ë¥¼) íšë“í•˜ì˜€ìŠµë‹ˆë‹¤!`, 'system');
        // ë¡œì»¬ ë°ì´í„°ëŠ” ë¦¬ìŠ¤ë„ˆì— ì˜í•´ ì—…ë°ì´íŠ¸ë¨
        
        // (ì„ íƒ ì‚¬í•­) ì•„ì´í…œ íšë“ í›„ ì¡°ìš°ë¥¼ "ë¹„ì–´ìˆë‹¤" ìƒíƒœë¡œ ë§Œë“¤ì§€ ì—¬ë¶€ëŠ” í˜„ì¬ DBì— ë°˜ì˜í•˜ì§€ ì•ŠìŒ.
        // ëŒ€ì‹  ë§µ/ì¡°ìš° ë°ì´í„°ì— 'isItemTaken' í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë‚˜,
        // í˜„ì¬ëŠ” 'currentPlayerData.inventory.includes(itemId)'ë¡œ ì²´í¬í•˜ëŠ” ê²ƒìœ¼ë¡œ ëŒ€ì²´í•¨.
        
    }).catch(err => printLog('ì•„ì´í…œ íšë“ ì‹¤íŒ¨: ' + err.message, 'system'));
}

/** HP ë³€ê²½ ê¸°ëŠ¥ */
function changeHP(data) {
    const amount = parseInt(data);
    if (isNaN(amount) || !currentPlayerData) return printLog('ìœ íš¨í•˜ì§€ ì•Šì€ HP ë³€ê²½ ìˆ˜ì¹˜ì…ë‹ˆë‹¤.', 'system');
    
    if (amount !== 0) {
        updateDoc(doc(db, 'users', currentPlayerId), {
            hp: increment(amount)
        }).then(() => {
            const message = amount > 0 ? `HPê°€ ${amount}ë§Œí¼ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.` : `HPê°€ ${-amount}ë§Œí¼ ê°ì†Œí–ˆìŠµë‹ˆë‹¤.`;
            printLog(`[SYSTEM] ${message}`, 'system');
            // ë¡œì»¬ ë°ì´í„°ëŠ” ë¦¬ìŠ¤ë„ˆì— ì˜í•´ ì—…ë°ì´íŠ¸ë¨
        }).catch(err => printLog('HP ë³€ê²½ ì‹¤íŒ¨: ' + err.message, 'system'));
    }
}

/** ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬ */
async function checkGameCompletion() {
    if (!isLoggedIn || isAdmin) return; // ê´€ë¦¬ìëŠ” ì²´í¬í•˜ì§€ ì•ŠìŒ
    
    try {
        // 1. ëª¨ë“  ì¡°ìš° ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (í˜„ì¬ ë§µ)
        const allEncounters = encounterPoints.map(e => `${currentMapName}:${e.x},${e.y}:${e.name}`);
        const totalEncounters = allEncounters.length;

        if (totalEncounters === 0) return; // ì¡°ìš°ê°€ ì—†ìœ¼ë©´ ì²´í¬í•  í•„ìš” ì—†ìŒ

        // 2. ëª¨ë“  í”Œë ˆì´ì–´ê°€ ë°œê²¬í•œ ì¡°ìš° ëª©ë¡ í†µí•©
        const usersRef = collection(db, 'users');
        const q = query(usersRef, where('isAdmin', '==', false));
        const allUsersSnap = await getDocs(q);

        const allDiscoveredEncounters = new Set();
        allUsersSnap.forEach(doc => {
            const userData = doc.data();
            userData.discoveredEncounters.forEach(encKey => {
                // í˜„ì¬ ë§µì˜ ì¡°ìš°ë§Œ ì„¸ê¸°
                if (encKey.startsWith(`${currentMapName}:`)) {
                    allDiscoveredEncounters.add(encKey);
                }
            });
        });

        // 3. ì¢…ë£Œ ì¡°ê±´ í™•ì¸ (ì „ì› í•©ì³ì„œ ëª¨ë“  ì¡°ìš° ë°œê²¬)
        if (allDiscoveredEncounters.size >= totalEncounters) {
            // ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ì±„íŒ… ì•Œë¦¼ ì „ì†¡ (DBì— ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì €ì¥)
            const chatData = {
                senderId: 'system',
                message: "ë” ì´ìƒ ì¡°ì‚¬í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.",
                mapName: currentMapName || 'default_map',
                timestamp: Date.now() + 1 // ì‹œê°„ì°¨ë¥¼ ë‘ì–´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ í‘œì‹œ
            };
            const newChatRef = doc(collection(db, 'chats'));
            await setDoc(newChatRef, chatData);
            printLog("ëª¨ë“  ì¡°ì‚¬ í•­ëª©ì´ ë°œê²¬ë˜ì–´ ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.", 'system');
        }

    } catch (err) {
        console.error("ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", err);
    }
}

/* ========================================================================= */
/* ADMIN MANAGEMENT (EXTENDED)                  */
/* ========================================================================= */

/** ì•„ì´í…œ ì •ì˜ ìƒì„± */
document.getElementById('createItemBtn').onclick = async () => {
    if (!isAdmin) return;
    const id = document.getElementById('newItemId').value.trim();
    const name = document.getElementById('newItemName').value.trim();
    const url = document.getElementById('newItemUrl').value.trim();
    
    if (!id || !name || !url) { alert('ì•„ì´í…œ ID, ì´ë¦„, URLì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
    const itemsRef = doc(db, 'globals', 'items');
    await updateDoc(itemsRef, {
        [`definitions.${id}`]: { id, name, url, description: 'ê´€ë¦¬ìê°€ ì •ì˜í•œ ì•„ì´í…œì…ë‹ˆë‹¤.' }
    }, { merge: true });
    
    alert(`ì•„ì´í…œ [${id}] ì •ì˜ ì™„ë£Œ`);
};

/** í”Œë ˆì´ì–´ ê³„ì • ìƒì„± */
document.getElementById('createPlayerBtn').onclick = async () => {
    if (!isAdmin) return;
    const id = document.getElementById('newPlayerId').value.trim();
    const charUrl = document.getElementById('newPlayerCharUrl').value.trim();
    
    if (!id || !charUrl) { alert('IDì™€ ìºë¦­í„° URLì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
    
    const userRef = doc(db, 'users', id);
    await setDoc(userRef, {
        hp: DEFAULT_MAX_HP,
        maxHp: DEFAULT_MAX_HP,
        isAdmin: false,
        inventory: [],
        charImgUrl: charUrl,
        discoveredEncounters: []
    });
    
    alert(`í”Œë ˆì´ì–´ [${id}] ìƒì„± ì™„ë£Œ.`);
    document.getElementById('newPlayerId').value = '';
    document.getElementById('newPlayerCharUrl').value = '';
};

/** í”Œë ˆì´ì–´ ëª©ë¡ ê·¸ë¦¬ê¸° (ê´€ë¦¬ììš©) */
function redrawPlayerList(players) {
    if (!isAdmin) return;
    const container = document.getElementById('playerListContainer');
    container.innerHTML = '';

    players.filter(p => !p.isAdmin).forEach(p => {
        const d = document.createElement('div');
        d.className = 'player-item';
        d.innerHTML = `
            <span>${p.id} (HP: ${p.hp}/${p.maxHp}, I: ${p.inventory.length})</span>
            <div>
                <button data-id="${p.id}" class="adminEditStatus">ìˆ˜ì •</button>
                <button data-id="${p.id}" class="adminDeletePlayer" style="background: #880000;">ì‚­ì œ</button>
            </div>
        `;
        container.appendChild(d);
    });
    
    container.querySelectorAll('.adminEditStatus').forEach(b => {
        b.onclick = (e) => openAdminStatusEdit(e.target.dataset.id, players);
    });
    // ... ì‚­ì œ ê¸°ëŠ¥ ...
}

/** ê´€ë¦¬ì ìƒíƒœ/ì¸ë²¤í† ë¦¬ ìˆ˜ì • ëª¨ë‹¬ (ê°„ë‹¨ íŒì—…) */
function openAdminStatusEdit(playerId, players) {
    if (!isAdmin) return;
    const p = players.find(player => player.id === playerId);
    if (!p) return;
    
    const hpInput = prompt(`[${playerId}] HP ìˆ˜ì • (í˜„ì¬ ${p.hp}/${p.maxHp}):`, p.hp);
    if (hpInput !== null) {
        const newHp = parseInt(hpInput);
        if (!isNaN(newHp)) {
            updateDoc(doc(db, 'users', playerId), { hp: Math.min(newHp, p.maxHp) });
        }
    }

    const itemAction = prompt(`[${playerId}] ì¸ë²¤í† ë¦¬ ìˆ˜ì •\n(í˜„ì¬: ${p.inventory.join(', ')}). \n\n'add:ITEM_ID' ë˜ëŠ” 'remove:ITEM_ID' ì…ë ¥:`, '');
    if (itemAction) {
        const [action, itemId] = itemAction.split(':').map(s => s.trim());
        if (action === 'add' && itemId) {
            updateDoc(doc(db, 'users', playerId), { inventory: arrayUnion(itemId) });
        } else if (action === 'remove' && itemId) {
            updateDoc(doc(db, 'users', playerId), { inventory: arrayRemove(itemId) });
        }
    }
}

/* ========================================================================= */
/* MAP LOAD/SAVE (FIREBASE)                     */
/* ========================================================================= */

async function saveMapDataToFirestore(name) {
    // ... (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ...
    const startX = parseInt(document.getElementById('startX').value) || 0;
    const startY = parseInt(document.getElementById('startY').value) || 0;

    const mapData = {
        map: mapUrlInput.value || '',
        sprite: spriteUrlInput.value || '',
        bgm: bgmUrlInput.value || '',
        encounters: encounterPoints || [],
        startPos: { x: startX, y: startY },
        passable: mapPassable || {}, // ì´ë™ ì œí•œ ë°ì´í„° ì¶”ê°€
        updatedAt: new Date()
    };
    await setDoc(doc(db, 'maps', name), mapData);
    if (!mapList.includes(name)) {
        mapList.push(name);
        localStorage.setItem('mapList', JSON.stringify(mapList));
    }
    currentMapName = name;
    subscribeToMap(name);
    if(isAdmin) alert(`ë§µ [${name}] Firestore ì €ì¥ ì™„ë£Œ`);
    redrawMapButtons();
}

async function loadMapDataFromFirestore(name) {
    const snap = await getDoc(doc(db, 'maps', name));
    if (!snap.exists()) return alert('í•´ë‹¹ ë§µì´ ì—†ìŒ');
    const data = snap.data();
    
    // ... (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ...
    mapNameInput.value = name;
    mapUrlInput.value = data.map || '';
    spriteUrlInput.value = data.sprite || '';
    bgmUrlInput.value = data.bgm || '';
    encounterPoints = data.encounters || [];
    mapPassable = data.passable || {}; // ì´ë™ ì œí•œ ë°ì´í„° ë¡œë“œ
    localStorage.setItem('encPoints', JSON.stringify(encounterPoints));

    if (data.startPos) {
        player.x = data.startPos.x;
        player.y = data.startPos.y;
        localStorage.setItem('playerPos', JSON.stringify(player));
        document.getElementById('startX').value = player.x;
        document.getElementById('startY').value = player.y;
    }

    currentMapName = name;
    subscribeToMap(name);
    loadResources();
    redrawEncList();
    draw();
    drawPassableOverlay(); // ì˜¤ë²„ë ˆì´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    if(isAdmin) alert(`ë§µ [${name}] Firestoreì—ì„œ ë¡œë“œ ì™„ë£Œ`);
    
    // ë§µ ì „í™˜ ì‹œ ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ì—…ë°ì´íŠ¸
    if(isLoggedIn) subscribeToChat();
}

function subscribeToMap(name) {
    if (mapDocUnsub) { mapDocUnsub(); mapDocUnsub = null; }
    const mapRef = doc(db, 'maps', name);
    mapDocUnsub = onSnapshot(mapRef, (snap) => {
      if (!snap.exists()) return;
      const data = snap.data();
      // ... (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ...
      const remoteEnc = JSON.stringify(data.encounters || []);
      const localEnc = JSON.stringify(encounterPoints || []);
      const remotePassable = JSON.stringify(data.passable || {});
      const localPassable = JSON.stringify(mapPassable || {});

      if (remoteEnc !== localEnc) {
        encounterPoints = data.encounters || [];
        localStorage.setItem('encPoints', JSON.stringify(encounterPoints));
        redrawEncList();
        draw();
      }
      if (remotePassable !== localPassable) {
          mapPassable = data.passable || {};
          drawPassableOverlay();
      }
      // UI ì—…ë°ì´íŠ¸
      if (data.map !== mapUrlInput.value) mapUrlInput.value = data.map || '';
      if (data.sprite !== spriteUrlInput.value) spriteUrlInput.value = data.sprite || '';
      if (data.bgm !== bgmUrlInput.value) bgmUrlInput.value = data.bgm || '';
    }, err => console.warn('êµ¬ë… ì˜¤ë¥˜:', err));
}

// ì´ˆê¸° ë¡œë“œ ì‹œ ë§µ ë¡œë“œ
loadMapDataFromFirestore(mapList[0] || 'default_map').catch(e => {
    // ë§µì´ ì—†ì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
    currentMapName = 'default_map';
    subscribeToMap(currentMapName);
});


/* --- ê¸°ì¡´ ë¡œì§ í†µí•© ë° ì´ˆê¸°í™” --- */
loadResources();
redrawMapButtons();
updateControlButtons();
document.getElementById('startX').value = player.x;
document.getElementById('startY').value = player.y;
updateAdminButton();
draw(); // ë§µ ë° ìºë¦­í„° ê·¸ë¦¬ê¸°
drawPassableOverlay(); // ì´ë™ ë¶ˆê°€ ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™”

// ... (ë‚˜ë¨¸ì§€ ê¸°ì¡´ í•¨ìˆ˜: loadBGM, draw, redrawEncList, openEditModal, fadeScreen, setCharacterImage, handleMapClick/drag, choice functions ë“±ì€ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ì— ë§ê²Œ ìˆ˜ì •ë¨) ...
// ì°¸ê³ : ê¸°ì¡´ì˜ canvas.addEventListener('click', ...)ëŠ” handleMapClickìœ¼ë¡œ ë³€ê²½ë˜ê³ , togglePassableOverlayBtnì˜ ìƒíƒœì— ë”°ë¼ handleTileSetìœ¼ë¡œ ë¶„ê¸°ë¨.
canvas.addEventListener('click', (ev) => {
    if (togglePassableOverlayBtn.classList.contains('active')) {
        handleTileSet(ev); // íƒ€ì¼ ì„¤ì • ëª¨ë“œ
    } else {
        // ê¸°ì¡´ ì¡°ìš° ì¶”ê°€ ë¡œì§ (Adding ëª¨ë“œ)
        if (!adding || !isAdmin || isDragging) return;
        const r = canvas.getBoundingClientRect();
        const x = Math.floor((ev.clientX - r.left) / (r.width / (canvas.width / GRID)));
        const y = Math.floor((ev.clientY - r.top) / (r.height / (canvas.height / GRID)));
        if (!encounterPoints.find(p => p.x === x && p.y === y)) {
            encounterPoints.push({ x, y, name: 'ìƒˆ ì¡°ìš°', text: 'ì§€ë¬¸ ì…ë ¥', charUrl: '', trigger: 'none', data: '', choices: [] });
            saveMapDataToFirestore(currentMapName || 'default_map');
            redrawEncList();
            draw();
        } else { alert('ì´ë¯¸ ì¡°ìš° í¬ì¸íŠ¸ê°€ ìˆëŠ” ìœ„ì¹˜ì…ë‹ˆë‹¤.'); }
    }
});

</script>
</body>
</html>
