<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tistoryìš© ê³µí¬ ì¯”ê¾¸ë¥´ (í™•ì¥ ê´€ë¦¬ìíŒ, Firebase í†µí•©)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
  :root{
    --bg:#000;
    --panel:rgba(0,0,0,0.85);
    --accent:#c0392b;
    --border-dark:#222;
    --border-light:#444;
    --text-color:#eee;
    --input-bg:#1a1a1a;
  }
  body{
    margin:0;background:var(--bg);color:var(--text-color);font-family:'Noto Sans KR',sans-serif;
    /* ë§µ ì¤‘ì•™ ë°°ì¹˜ ë° ì „ì²´ í™”ë©´ ìŠ¤í¬ë¡¤ í—ˆìš© (Admin Panel ë•Œë¬¸ì—) */
    display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
    height:100vh;
    overflow-y: auto; /* ê´€ë¦¬ì íŒ¨ë„ ë•Œë¬¸ì— ìŠ¤í¬ë¡¤ í—ˆìš© */
  }
  
  /* --- ë©”ì¸ ì½˜í…ì¸  ë ˆì´ì•„ì›ƒ (ë§µ, ë¡œê·¸, ì¸ë²¤í† ë¦¬ ë°°ì¹˜) --- */
  #mainContent {
      display: flex;
      gap: 15px;
      margin-top: 60px; /* topBar ë†’ì´ë§Œí¼ ì—¬ë°± */
      margin-bottom: 20px;
      align-items: flex-start;
      flex-shrink: 0;
      /* ë§µ ì¤‘ì•™ ë°°ì¹˜ë¥¼ ìœ„í•œ ì¡°ì • (ë§µ í¬ê¸° 640x480ì„ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ ë§ì¶¤) */
      /* ë§µ/ë¡œê·¸/ì¸ë²¤í† ë¦¬ íŒ¨ë„ ì „ì²´ë¥¼ ê°€ë¡œë¡œ ì¤‘ì•™ì— ë°°ì¹˜ */
      position: relative; 
      left: 50%;
      transform: translateX(-50%);
  }
  
  #topBar{
    display:flex;justify-content:space-between;width:100%;padding:8px 16px;position:fixed;top:0;right:0;left:0;
    z-index:50;background:var(--panel);box-shadow: 0 2px 5px rgba(0,0,0,0.5);height: 40px;align-items: center;box-sizing: border-box;
  }
  #authControls { display: flex; gap: 10px; align-items: center; }
  #authControls input { width: 100px; padding: 5px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  #bgmControls { display:flex;gap:10px;align-items:center;flex-shrink:0; }
  #bgmControls button, #adminBtn, #playerLoginBtn, #logoutBtn { padding:5px 10px;font-size:14px;line-height:1;height:30px; }
  #bgmVolume { width:80px;height:4px;background:var(--border-light);-webkit-appearance:none;appearance:none;border-radius:5px;cursor:pointer; }
  #bgmVolume::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px var(--accent);}

  /* ë§µ ì»¨í…Œì´ë„ˆ (ê¸°ì¡´ 640x480 ìœ ì§€) */
  #container{
    position:relative;width:640px;height:480px;overflow:hidden;border:3px solid var(--border-light);
    box-shadow:0 0 40px var(--accent);background:#000;z-index:5;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:1}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2}
  #dragGhost { position:absolute;width:32px;height:32px;background:rgba(0,255,255,0.4);border:2px solid cyan;pointer-events:none;display:none;z-index:4; }
  
  /* --- 1. ì¢Œì¸¡ ë¡œê·¸/ì±„íŒ… íŒ¨ë„ --- */
  #logChatPanel {
      width: 280px;
      height: 480px; 
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; 
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      flex-shrink: 0;
  }
  #logChatHistory {
      flex-grow: 1;
      overflow-y: auto;
      margin-bottom: 10px;
      padding-right: 5px; 
      font-size: 13px;
      line-height: 1.4;
  }
  .log-message { margin-bottom: 3px; }
  .log-system { color: #888; font-style: italic; }
  .log-chat b { color: #5dade2; } 
  .log-chat .admin-name { color: var(--accent); } 
  .log-chat { display: flex; align-items: flex-start; }
  .chat-text-content { flex-grow: 1; }
  .chat-admin-actions { margin-left: auto; flex-shrink: 0; display: none; gap: 3px; }
  .chat-admin-actions button { padding: 1px 4px; font-size: 10px; background: #555; border: 1px solid #444; border-radius: 3px; cursor: pointer; }
  #chatInputArea { display: flex; flex-direction: column; gap: 5px; }
  #chatInputArea > div { display: flex; gap: 5px; }
  #chatInput { flex-grow: 1; padding: 6px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  #nicknameInput { width: 100%; padding: 5px; font-size: 13px; margin-bottom: 5px; background: var(--input-bg); border: 1px solid var(--border-dark); color: var(--text-color); }
  
  /* ì•„ì¹´ì´ë¸Œ í† ê¸€ */
  #archiveToggle { width: 30px; height: 30px; padding: 0; flex-shrink: 0; background: #333; border: 1px solid var(--border-dark); border-radius: 5px; cursor: pointer; }
  #archiveList { position: absolute; left: 10px; top: 40px; background: rgba(0,0,0,0.95); border: 1px solid var(--border-light); padding: 10px; border-radius: 5px; display: none; z-index: 50; }
  .archive-item { cursor: pointer; padding: 5px; margin-bottom: 3px; font-size: 13px; }
  .archive-item:hover { background: #333; }
  #archiveCloseBtn { padding: 6px 12px; background: var(--accent); border: none; color: white; border-radius: 5px; cursor: pointer; }

  /* --- 2. ìš°ì¸¡ ìƒíƒœ/ì¸ë²¤í† ë¦¬ íŒ¨ë„ --- */
  #statusInventoryPanel {
      width: 250px;
      height: 480px;
      background: var(--panel);
      border: 3px solid var(--border-light);
      border-radius: 8px;
      padding: 10px;
      display: none; 
      flex-direction: column;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
      flex-shrink: 0;
  }
  #statusPanel h4, #inventoryPanel h4 { color: var(--accent); margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border-dark); text-align: center;}
  #playerStatus { margin-bottom: 15px; font-size: 14px; }
  #playerStatus div { display: flex; justify-content: space-between; margin-bottom: 5px; }
  #hpBar { width: 100%; height: 18px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-light); }
  #hpValue { height: 100%; background: #27ae60; transition: width 0.3s; text-align: center; line-height: 18px; font-size: 12px; font-weight: bold; color: #fff; }
  #inventoryGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 8px 0;
      flex-grow: 1;
  }
  .item-slot {
      width: 50px;
      height: 50px;
      background: var(--input-bg);
      border: 1px solid var(--border-dark);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      box-shadow: inset 0 0 3px rgba(255,255,255,0.1);
  }
  .item-slot img { max-width: 100%; max-height: 100%; object-fit: contain; }
  .item-slot:hover { border-color: var(--accent); }
  
  /* --- 3. ê´€ë¦¬ì íŒ¨ë„ (ë§µ í•˜ë‹¨ ê³ ì • ë°°ì¹˜ - ìŠ¤í¬ë¡¤ ì ìš©) --- */
  #adminPanel{
    position: relative; /* ë©”ì¸ ì»¨í…ì¸  ë°”ë¡œ ì•„ë˜ì— ìœ„ì¹˜ */
    margin-top: 15px; 
    margin-bottom: 40px; /* body ìŠ¤í¬ë¡¤ ì—¬ë°± */
    z-index:15;background:var(--panel);padding:15px;border-radius:10px;
    font-size:14px;display:none;min-width:1180px;max-width:1180px;border:1px solid var(--accent);
    box-shadow:0 0 10px rgba(192,57,43,0.5);
    /* ê´€ë¦¬ì íŒ¨ë„ ìŠ¤í¬ë¡¤ ì ìš© */
    max-height: 80vh; 
    overflow-y: auto;
  }
  #adminPanel h4{margin:0 0 12px 0;text-align:center;color:var(--accent);border-bottom: 1px solid var(--border-dark);padding-bottom: 8px;}
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;width:100%;}
  .row label{white-space:nowrap;min-width: 60px;}
  hr {border: none;border-top: 1px dashed var(--border-dark);margin: 15px 0;}
  
  /* ê´€ë¦¬ì í™•ì¥ íŒ¨ë„ (Player/Tile Management) */
  #adminExtPanel {
      display: flex;
      gap: 15px;
      margin-top: 10px;
  }
  #adminPlayerManagement, #adminTileManagement {
      flex: 1;
      background: rgba(255, 255, 255, 0.05);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border-dark);
      max-height: 400px;
      overflow-y: auto;
  }
  #playerListContainer { max-height: 200px; overflow-y: auto; padding: 5px; }
  .player-item { 
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; 
      padding: 5px; background: #222; border-radius: 3px; font-size: 13px; 
  }
  .player-item button { padding: 3px 6px; font-size: 11px; }
  .player-item span { flex: 1; }
  
  /* ë¡œê·¸ì¸/ëª¨ë‹¬/Encounter ìŠ¤íƒ€ì¼ ìœ ì§€ ë° ì¡°ì • */
  .modal-bg{
    position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);
    display:none;align-items:center;justify-content:center;z-index:100; /* Z-index ë†’ì„ */
  }
  .modal{
    background:var(--panel);padding:20px;border-radius:10px;border:1px solid var(--border-light);
    box-shadow:0 0 15px rgba(0,0,0,0.8);max-width:500px;width:90%;
  }
  #loginBox{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    background:var(--panel);padding:20px;border-radius:10px;z-index:110; /* Z-index ë†’ì„ */
    border:1px solid var(--accent);box-shadow:0 0 10px var(--accent);
    display:none;flex-direction:column;gap:10px;align-items:center;
  }
  #loginBox input{padding:10px;width:200px;background:var(--input-bg);border:1px solid var(--border-dark);color:var(--text-color);}

  /* ì•„ì´í…œ ì •ë³´ ëª¨ë‹¬ (ì¡°ìš° ëª¨ë‹¬ UI ì¬í™œìš©) */
  .modal-bg#itemModalBg .modal { min-width: 350px; max-width: 450px; }
  .char-img-container { height: 200px; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
  .char-img-container img { max-height: 100%; max-width: 100%; object-fit: contain; border-radius: 5px; }
  .info-text { margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; white-space: pre-wrap; }

  /* ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  button{background:var(--accent);color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;transition:background 0.2s;}
  button:hover{background:#a63125;}
  button:disabled{background:#555;cursor:not-allowed;}
  input, textarea, select{background:var(--input-bg);color:var(--text-color);border:1px solid var(--border-dark);padding:8px;border-radius:5px;}

</style>
</head>
<body>
<audio id="bgmAudio" loop preload="auto"></audio>

<div id="topBar">
    <div id="bgmControls"> 
        <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" title="ë³¼ë¥¨">
        <button id="bgmToggleBtn">PLAY</button> 
    </div>
    <div id="authControls">
        <input type="text" id="playerIdInput" placeholder="í”Œë ˆì´ì–´ ID">
        <button id="playerLoginBtn">í”Œë ˆì´ì–´ ë¡œê·¸ì¸</button>
        <button id="adminBtn">ê´€ë¦¬ì</button>
    </div>
</div>

<div id="mainContent">
    
    <div id="logChatPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h4 style="margin: 0; padding: 0; color: #fff; border: none; font-size: 16px;">ë¡œê·¸ ë° ì±„íŒ…</h4>
            <div style="position: relative;">
                <button id="archiveToggle" title="ê¸°ë¡ ë³´ê¸°">ğŸ’¾</button>
                <div id="archiveList"></div>
            </div>
        </div>
        <div id="logChatHistory">
            <div class="log-system">[SYSTEM] í™˜ì˜í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ê²Œì„ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
        </div>
        <div id="chatInputArea">
            <input type="text" id="nicknameInput" placeholder="ê´€ë¦¬ì ë‹‰ë„¤ì„ (ì…ë ¥ ì‹œ ì±„íŒ…ëª… ë³€ê²½)" style="display: none;">
            <div>
                <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." disabled>
                <button id="chatSendBtn" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="container">
        <canvas id="game" width="640" height="480"></canvas>
        <div id="grid"></div>
        <div id="dragGhost"></div> 
        <canvas id="passableOverlay" width="640" height="480" style="position:absolute;left:0;top:0;z-index:3;pointer-events:none;"></canvas>
    </div>
    
    <div id="statusInventoryPanel">
        <div id="playerStatus">
            <h4 style="text-align: center;">ìƒíƒœ</h4>
            <div>
                <span id="playerNameDisplay"></span>
                <span id="playerHPDisplay"></span>
            </div>
            <div id="hpBar"><div id="hpValue"></div></div>
        </div>
        
        <div id="inventoryPanel">
            <h4 style="text-align: center;">ì¸ë²¤í† ë¦¬</h4>
            <div id="inventoryGrid">
                </div>
        </div>
    </div>
    
</div>

<div id="adminPanel">
  <h4>ê´€ë¦¬ì ì„¤ì • íŒ¨ë„</h4>
  <div style="display: flex; gap: 15px; width: 100%;">
      <div style="flex: 1;">
          <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">ë§µ ê¸°ë³¸ ì„¤ì •</h5>
          <div class="row"><label>ë§µ ì´ë¦„</label><input id="mapName" type="text"><button id="saveMap">ë§µ ì €ì¥</button></div>
          <div class="row"><label>ë§µ ì´ë¯¸ì§€</label><input id="mapUrl" type="text" placeholder="ì´ë¯¸ì§€ URL"></div>
          <div class="row"><label>ìºë¦­í„°</label><input id="spriteUrl" type="text" placeholder="ìŠ¤í”„ë¼ì´íŠ¸ URL"></div>
          <div class="row"><label>BGM URL</label><input id="bgmUrl" type="text" placeholder="ë°°ê²½ìŒì•… URL"></div> 
          <div class="row">
              <label>ì‹œì‘ ì¢Œí‘œ</label>
              <input id="startX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
              <input id="startY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
              <button id="setPlayerPos" style="flex-shrink: 0;">ì„¤ì •</button>
          </div>
          <div class="control-group" style="margin-top: 15px;"> 
            <button id="reload">ë¡œë“œ</button>
            <button id="toggleGrid">ê·¸ë¦¬ë“œ</button>
            <button id="toggleEncounter">ì¡°ìš°</button> 
          </div>
          <hr>
          <div class="row" style="margin-bottom: 10px;"><button id="deleteAllEncounters" style="background: #880000; border-color: #aa0000; flex-grow: 1;">ëª¨ë“  ì¡°ìš° ì‚­ì œ</button></div>
          <div class="enc-list" id="encList" style="max-height: 200px; overflow-y: auto;"></div>
          <div id="mapButtons" style="margin-top:10px;"></div>
      </div>

      <div id="adminExtPanel" style="flex: 2; display: flex; gap: 15px;">
          <div id="adminPlayerManagement" style="flex: 1;">
              <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">í”Œë ˆì´ì–´/ì•„ì´í…œ/HP ê´€ë¦¬</h5>
              <p style="font-size: 12px; margin: 0 0 5px 0; color: #ccc;">**ê³„ì • ìƒì„±**</p>
              <div class="row" style="align-items: stretch; margin-bottom: 5px;">
                  <input type="text" id="newPlayerId" placeholder="ìƒˆ í”Œë ˆì´ì–´ ID" style="flex: 1;">
                  <input type="text" id="newPlayerCharUrl" placeholder="ìºë¦­í„° ì´ë¯¸ì§€ URL" style="flex: 1;">
                  <button id="createPlayerBtn" style="flex-shrink: 0; padding: 5px 10px;">ìƒì„±</button>
              </div>
              <p style="font-size: 12px; margin: 10px 0 5px 0; color: #ccc;">**ê¸€ë¡œë²Œ ì•„ì´í…œ ì •ì˜**</p>
              <div class="row" style="align-items: stretch; margin-bottom: 10px;">
                  <input type="text" id="newItemId" placeholder="ID" style="width: 50px;">
                  <input type="text" id="newItemName" placeholder="ì´ë¦„">
                  <input type="text" id="newItemUrl" placeholder="ì´ë¯¸ì§€ URL" style="flex: 1;">
                  <button id="createItemBtn" style="flex-shrink: 0; padding: 5px 10px;">ì •ì˜</button>
              </div>
              
              <h5 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px;">í”Œë ˆì´ì–´ ëª©ë¡ ë° ìƒíƒœ ìˆ˜ì •</h5>
              <div id="playerListContainer">
                  <p style="font-size: 12px; color: #777;">í”Œë ˆì´ì–´ ëª©ë¡ ë¡œë”© ì¤‘...</p>
              </div>
          </div>
          <div id="adminTileManagement" style="flex: 1;">
              <h5 style="color: #aaa; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">ë§µ ì´ë™ ì œí•œ ì„¤ì •</h5>
              <div class="row" style="margin-bottom: 5px;">
                  <button id="togglePassableOverlay">ì œí•œ ì˜ì—­ ë³´ê¸°</button>
                  <button id="setPassableTile">ì´ë™ ì œí•œ/ê°€ëŠ¥ ëª¨ë“œ</button>
              </div>
              <p style="font-size: 12px; margin: 0 0 10px 0; color: #888;">* ì‹±ê¸€ í´ë¦­: ì´ë™ ë¶ˆê°€ (ë¹¨ê°•) / í•´ì œ í† ê¸€. ë”ë¸”í´ë¦­: ì´ë™ ê°€ëŠ¥ (ì´ˆë¡) / í•´ì œ í† ê¸€.</p>
              
              <h5 style="margin: 10px 0 5px 0; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px;">í˜„ì¬ ë§µ ì œí•œ íƒ€ì¼ ëª©ë¡</h5>
              <div id="passableMapList" style="max-height: 250px; overflow-y: auto;">
                  <p style="font-size: 12px; color: #777;">ì œí•œ íƒ€ì¼ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
              </div>
          </div>
      </div>
  </div>
</div>

<div id="loginBox">
  <div>ê´€ë¦¬ì ë¡œê·¸ì¸</div>
  <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
  <button id="loginBtn">ë¡œê·¸ì¸</button>
</div>

<div class="modal-bg" id="editModal">
  <div class="modal">
    <h4>ì¡°ìš° ìˆ˜ì •</h4>
    <label>ì´ë¦„</label><input id="encName" type="text">
    <label>ì§€ë¬¸</label><textarea id="encText" placeholder="ì¡°ìš° ì‹œ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì¼ ì§€ë¬¸" rows="3"></textarea>
    <label>ìºë¦­í„° ì´ë¯¸ì§€ URL</label><input id="encCharUrl" type="text" placeholder="ì¡°ìš° ì‹œ ë„ìš¸ ì´ë¯¸ì§€ URL">
    
    <label id="choicesLabel">ì„ íƒì§€</label> <div id="choices"></div>
    <div id="addChoiceContainer" style="text-align: right;"><button id="addChoice">ì„ íƒì§€ ì¶”ê°€</button></div>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ ì‚¬ìš©)</label>
    <select id="encTrigger">
        <option value="none">ì—†ìŒ</option>
        <option value="sound">ì‚¬ìš´ë“œ</option>
        <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
        <option value="map">ë§µ ì „í™˜</option>
        <option value="item">ì•„ì´í…œ íšë“</option> 
        <option value="hp">HP ë³€ê²½</option> 
    </select>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° ë°ì´í„°(URL/ë§µëª…/ItemID/HPê°’)</label><input id="encData" type="text">
    
    <div style="margin-top:20px;text-align:right">
      <button id="saveEncEdit">ì €ì¥</button>
      <button id="closeEncEdit">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="encounterModalBg">
    <div class="modal" id="encounterModal">
        <div class="char-img-container" id="encCharImgContainer">
            <img id="encCharImg" alt="Encounter Character" style="display:none;"/>
        </div>
        <h4 id="encModalName"></h4>
        <div class="info-text" id="encModalText"></div>
        <div id="encounterChoices"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeEncounterModal">ê³„ì† ì§„í–‰</button></div>
    </div>
</div>

<div class="modal-bg" id="itemModalBg">
    <div class="modal">
        <h4 id="itemModalName">ì•„ì´í…œ ì •ë³´</h4>
        <div class="char-img-container" style="height: 150px;"><img id="itemModalImg" alt="Item Image" style="display:none; object-fit: contain;"/></div>
        <div class="info-text" id="itemModalDescription"></div>
        <div style="margin-top:20px;text-align:right"><button id="closeItemModal">ë‹«ê¸°</button></div>
    </div>
</div>

<script type="module">
// Firebase SDK import ë° ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, collection, query, where, getDocs, onSnapshot, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  // ì‹¤ì œ Firebase ì„¤ì •ìœ¼ë¡œ ëŒ€ì²´í•´ì•¼ í•©ë‹ˆë‹¤.
  apiKey: "AIzaSyCtPPF9Y93XVKHjo5_mmmxycf0CUJjWIRo",
  authDomain: "horror-game-14aa8.firebaseapp.com",
  projectId: "horror-game-14aa8",
  storageBucket: "horror-game-14aa8.firebasestorage.app",
  messagingSenderId: "125297141331",
  appId: "1:125297141331:web:a15f971c34dde0c7d708a6"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const ADMIN_EMAIL = "test@gmail.com";
const DEFAULT_MAX_HP = 100;
const MAX_INVENTORY_SLOTS = 12;
const GRID = 32;

/* --- ì „ì—­ ìƒíƒœ ë° UI ë°”ì¸ë”© (ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) --- */
let currentPlayerId = null;
let currentPlayerData = null;
let isAdmin = false;
let isLoggedIn = false;
let currentMapName = null;
let encounterPoints = [];
let itemsDefinitions = {};
let mapPassable = {}; 
let player = JSON.parse(localStorage.getItem('playerPos') || '{"x":2,"y":2}');

// UI ìš”ì†Œ ë°”ì¸ë”© (ìƒˆë¡œìš´ ìš”ì†Œ í¬í•¨)
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const logChatPanel = document.getElementById('logChatPanel');
const statusInventoryPanel = document.getElementById('statusInventoryPanel');
const adminPanel = document.getElementById('adminPanel');
const logChatHistory = document.getElementById('logChatHistory');
const chatInput = document.getElementById('chatInput');
const chatSendBtn = document.getElementById('chatSendBtn');
const nicknameInput = document.getElementById('nicknameInput');
const archiveToggle = document.getElementById('archiveToggle');
const archiveList = document.getElementById('archiveList');
const playerNameDisplay = document.getElementById('playerNameDisplay');
const playerHPDisplay = document.getElementById('playerHPDisplay');
const hpValue = document.getElementById('hpValue');
const inventoryGrid = document.getElementById('inventoryGrid');
const itemModalBg = document.getElementById('itemModalBg');
const itemModalName = document.getElementById('itemModalName');
const itemModalImg = document.getElementById('itemModalImg');
const itemModalDescription = document.getElementById('itemModalDescription');
const passableOverlay = document.getElementById('passableOverlay');
const passableCtx = passableOverlay.getContext('2d');
const playerIdInput = document.getElementById('playerIdInput');
const playerLoginBtn = document.getElementById('playerLoginBtn');
const adminBtn = document.getElementById('adminBtn'); 
const adminPwInput = document.getElementById('adminPw');
const loginBtn = document.getElementById('loginBtn');
const togglePassableOverlayBtn = document.getElementById('togglePassableOverlay');

let mapDocUnsub = null;
let chatUnsub = null;
let userUnsub = null;
let allUsersUnsub = null;
let itemsUnsub = null;
let archiveCloseBtn = null; 
let isEncounterActive = false;
let currentEncounter = null;
let currentEncounterIndex = -1;

// ê¸°ì¡´ ë³€ìˆ˜ ë°”ì¸ë”©
let mapImg = new Image(), sprite = new Image();
let showGrid = true;
let adding = false;
let currentEdit = -1;
let mapList = JSON.parse(localStorage.getItem('mapList') || '[]');
let isDragging = false;
let draggedEncIndex = -1;
const dragGhost = document.getElementById('dragGhost');
const mapNameInput = document.getElementById('mapName');
const mapUrlInput = document.getElementById('mapUrl');
const spriteUrlInput = document.getElementById('spriteUrl');
const bgmUrlInput = document.getElementById('bgmUrl');
const bgmAudio = document.getElementById('bgmAudio');
const bgmToggleBtn = document.getElementById('bgmToggleBtn');
const bgmVolume = document.getElementById('bgmVolume');
const toggleGridBtn = document.getElementById('toggleGrid');
const toggleEncounterBtn = document.getElementById('toggleEncounter');
const deleteAllEncountersBtn = document.getElementById('deleteAllEncounters');
const startXInput = document.getElementById('startX');
const startYInput = document.getElementById('startY');
const setPlayerPosBtn = document.getElementById('setPlayerPos');
const reloadBtn = document.getElementById('reload');
const saveMapBtn = document.getElementById('saveMap');
const addChoiceBtn = document.getElementById('addChoice');
const encName = document.getElementById('encName');
const encText = document.getElementById('encText');
const encCharUrl = document.getElementById('encCharUrl');
const encTrigger = document.getElementById('encTrigger');
const encData = document.getElementById('encData');
const saveEncEditBtn = document.getElementById('saveEncEdit');
const closeEncEditBtn = document.getElementById('closeEncEdit');
const encListDiv = document.getElementById('encList');
const mapButtonsDiv = document.getElementById('mapButtons');
const choicesDiv = document.getElementById('choices');


/* ========================================================================= */
/* UI/LAYOUT FUNCTIONS                          */
/* ========================================================================= */

/** ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¥¸ ì „ì²´ UI ê°€ì‹œì„± ì—…ë°ì´íŠ¸ */
function updateUIVisibility() {
    logChatPanel.style.display = isLoggedIn ? 'flex' : 'none';
    statusInventoryPanel.style.display = isLoggedIn ? 'flex' : 'none';
    adminPanel.style.display = (isLoggedIn && isAdmin) ? 'block' : 'none';
    
    // í”Œë ˆì´ì–´/ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
    if (isLoggedIn) {
        adminBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
        adminBtn.onclick = logoutUser;
        playerLoginBtn.style.display = 'none';
        playerIdInput.style.display = 'none';
    } else {
        adminBtn.textContent = 'ê´€ë¦¬ì';
        adminBtn.onclick = () => document.getElementById('loginBox').style.display = 'flex';
        playerLoginBtn.style.display = 'block';
        playerIdInput.style.display = 'block';
    }
    
    chatInput.disabled = !isLoggedIn;
    chatSendBtn.disabled = !isLoggedIn;
    nicknameInput.style.display = isAdmin ? 'block' : 'none';

    draw(); 
    drawPassableOverlay(); 
    if (isAdmin) subscribeToAllPlayers(); 
    else if (allUsersUnsub) allUsersUnsub();
}

/** HP ë°” ì—…ë°ì´íŠ¸ */
function updateStatusPanel() {
    if (!currentPlayerData) return;
    const { id, hp, maxHp } = currentPlayerData;
    
    playerNameDisplay.textContent = `í”Œë ˆì´ì–´: ${id}`;
    playerHPDisplay.textContent = `HP: ${hp}/${maxHp}`;
    
    const percent = maxHp > 0 ? (hp / maxHp) * 100 : 0;
    hpValue.style.width = `${percent}%`;
    hpValue.style.backgroundColor = percent > 50 ? '#27ae60' : percent > 20 ? '#f39c12' : '#e74c3c';
    hpValue.textContent = `${hp}`;
    
    drawInventory();
}

/** ì¸ë²¤í† ë¦¬ ê·¸ë¦¬ê¸° ë° ì•„ì´í…œ íŒì—… ì²˜ë¦¬ */
function drawInventory() {
    inventoryGrid.innerHTML = '';
    const inventory = currentPlayerData?.inventory || [];
    
    for (let i = 0; i < MAX_INVENTORY_SLOTS; i++) {
        const itemId = inventory[i];
        const itemDef = itemsDefinitions[itemId];
        const slot = document.createElement('div');
        slot.className = 'item-slot';
        
        if (itemId) {
            slot.dataset.itemId = itemId;
            if (itemDef?.url) {
                const img = document.createElement('img');
                img.src = itemDef.url;
                img.alt = itemDef.name || 'ì•„ì´í…œ';
                slot.appendChild(img);
            } else {
                slot.textContent = itemId.slice(0, 3);
                slot.style.fontSize = '12px';
                slot.style.color = '#fff';
            }
            slot.onclick = () => openItemModal(itemId);
        } else {
             slot.className += ' empty';
        }
        
        inventoryGrid.appendChild(slot);
    }
}

/** ì•„ì´í…œ ìƒì„¸ ì •ë³´ íŒì—… */
function openItemModal(itemId) {
    const itemDef = itemsDefinitions[itemId];
    if (!itemDef) return;
    
    itemModalName.textContent = itemDef.name || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ';
    itemModalDescription.textContent = itemDef.description || 'ì•„ì´í…œ ì§€ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.';
    
    if (itemDef.url) {
        itemModalImg.src = itemDef.url;
        itemModalImg.style.display = 'block';
    } else {
        itemModalImg.style.display = 'none';
    }
    
    document.getElementById('itemModalBg').style.display = 'flex';
}
document.getElementById('closeItemModal').onclick = () => {
    document.getElementById('itemModalBg').style.display = 'none';
};

/** ë¡œê·¸/ì±„íŒ… ë©”ì‹œì§€ ì¶œë ¥ */
function printLog(message, type = 'system', senderId = null, chatId = null) {
    const d = document.createElement('div');
    d.className = `log-message log-${type}`;
    d.dataset.chatId = chatId; 

    let content = `<span class="chat-text-content">${message}</span>`;
    
    if (type === 'chat' && senderId) {
        const isSelf = senderId === currentPlayerId;
        const sender = isSelf ? 'ë‚˜' : (senderId === 'admin' ? nicknameInput.value || 'ê´€ë¦¬ì' : senderId);
        const nameClass = senderId === 'admin' ? 'admin-name' : '';
        content = `<span class="chat-text-content"><b><span class="${nameClass}">${escapeHtml(sender)}</span>:</b> ${escapeHtml(message)}</span>`;
        
        if (isAdmin && chatId) {
            content += `<span class="chat-admin-actions" style="display: flex;">
                <button class="editChatBtn" data-id="${chatId}">ìˆ˜ì •</button>
                <button class="deleteChatBtn" data-id="${chatId}">ì‚­ì œ</button>
            </span>`;
        }
    } else if (type === 'system') {
        content = `[SYSTEM] ${escapeHtml(message)}`;
    }
    
    d.innerHTML = content;
    logChatHistory.appendChild(d);
    logChatHistory.scrollTop = logChatHistory.scrollHeight;
    
    if (isAdmin && chatId) {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë˜ë„ë¡ ìˆ˜ì •
        const editBtn = d.querySelector('.editChatBtn');
        const deleteBtn = d.querySelector('.deleteChatBtn');
        if (editBtn) editBtn.onclick = (e) => editChat(e.target.dataset.id, message);
        if (deleteBtn) deleteBtn.onclick = (e) => deleteChat(e.target.dataset.id);

        const actionsContainer = d.querySelector('.chat-admin-actions');
        if (actionsContainer) actionsContainer.style.display = 'flex';
    }
}

/** ê´€ë¦¬ì ì±„íŒ… ìˆ˜ì • ê¸°ëŠ¥ */
async function editChat(chatId, currentMessage) {
    if (!isAdmin) return;
    const newMessage = prompt('ì±„íŒ… ìˆ˜ì •:', currentMessage);
    if (newMessage === null || newMessage.trim() === currentMessage.trim() || !newMessage.trim()) return;

    try {
        await updateDoc(doc(db, 'chats', chatId), { message: newMessage.trim(), edited: true });
        printLog(`ì±„íŒ… ID ${chatId} ìˆ˜ì •ë¨.`, 'system');
    } catch (e) {
        printLog('ì±„íŒ… ìˆ˜ì • ì‹¤íŒ¨: ' + e.message, 'system');
    }
}

/** ê´€ë¦¬ì ì±„íŒ… ì‚­ì œ ê¸°ëŠ¥ */
async function deleteChat(chatId) {
    if (!isAdmin || !confirm('ì •ë§ë¡œ ì´ ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
        await deleteDoc(doc(db, 'chats', chatId));
        printLog(`ì±„íŒ… ID ${chatId} ì‚­ì œë¨.`, 'system');
    } catch (e) {
        printLog('ì±„íŒ… ì‚­ì œ ì‹¤íŒ¨: ' + e.message, 'system');
    }
}

/** ì´ë™ ë¶ˆê°€ íƒ€ì¼ ì˜¤ë²„ë ˆì´ ê·¸ë¦¬ê¸° (ê´€ë¦¬ì ëª¨ë“œ) */
function drawPassableOverlay() {
    passableCtx.clearRect(0, 0, passableOverlay.width, passableOverlay.height);
    if (!isAdmin || !togglePassableOverlayBtn.classList.contains('active')) return;

    for (let y = 0; y < canvas.height / GRID; y++) {
        for (let x = 0; x < canvas.width / GRID; x++) {
            const key = `${x},${y}`;
            const isPassable = mapPassable[key] === true;
            
            if (mapPassable.hasOwnProperty(key)) {
                passableCtx.fillStyle = isPassable ? 'rgba(0, 255, 0, 0.3)' : 'rgba(255, 0, 0, 0.3)';
                passableCtx.fillRect(x * GRID, y * GRID, GRID, GRID);
                passableCtx.strokeStyle = isPassable ? '#0f0' : '#f00';
                passableCtx.strokeRect(x * GRID + 1, y * GRID + 1, GRID - 2, GRID - 2);
            }
        }
    }
}

/** ë§µ ì´ë¯¸ì§€ ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬) */
function loadMapImage(url) {
    return new Promise((resolve, reject) => {
        if (!url) {
            mapImg.src = '';
            resolve();
            return;
        }
        mapImg.onload = () => resolve();
        mapImg.onerror = () => reject(new Error('ë§µ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + url));
        mapImg.src = url;
    });
}

/** ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬) */
function loadSpriteImage(url) {
    return new Promise((resolve, reject) => {
        if (!url) {
            sprite.src = '';
            resolve();
            return;
        }
        sprite.onload = () => resolve();
        sprite.onerror = () => reject(new Error('ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ' + url));
        sprite.src = url;
    });
}

/** ë§µ ê·¸ë¦¬ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬ ë° ì¤‘ì•™ ë°°ì¹˜ ìœ ì§€) */
function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (mapImg.src) {
        ctx.drawImage(mapImg, 0, 0, canvas.width, canvas.height);
    }
    
    // ìºë¦­í„° ê·¸ë¦¬ê¸° (ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ)
    if (isLoggedIn && sprite.src) {
        ctx.drawImage(sprite, player.x * GRID, player.y * GRID, GRID, GRID);
    }

    if (showGrid) {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        grid.style.border = '1px solid #444'; 
        for (let y = 0; y < canvas.height / GRID; y++) {
            for (let x = 0; x < canvas.width / GRID; x++) {
                const cell = document.createElement('div');
                cell.style.cssText = `position:absolute;left:${x * GRID}px;top:${y * GRID}px;width:${GRID}px;height:${GRID}px;border:1px dashed rgba(255,255,255,0.2);box-sizing:border-box;`;
                grid.appendChild(cell);

                // ì¡°ìš° í¬ì¸íŠ¸ í‘œì‹œ
                if (encounterPoints.find(p => p.x === x && p.y === y)) {
                    cell.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    if (isAdmin) {
                         cell.textContent = 'E';
                         cell.style.color = '#fff';
                         cell.style.textAlign = 'center';
                         cell.style.lineHeight = `${GRID}px`;
                    }
                }
            }
        }
    } else {
        document.getElementById('grid').innerHTML = '';
        document.getElementById('grid').style.border = 'none';
    }
}

/** ë§µ ë°ì´í„° ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬) */
async function loadMapDataFromFirestore(mapName) {
    currentMapName = mapName;
    const mapRef = doc(db, 'maps', mapName);
    const docSnap = await getDoc(mapRef);
    
    if (docSnap.exists()) {
        const data = docSnap.data();
        mapNameInput.value = data.name || mapName;
        mapUrlInput.value = data.mapUrl || '';
        spriteUrlInput.value = data.spriteUrl || '';
        bgmUrlInput.value = data.bgmUrl || '';
        encounterPoints = data.encounters || [];
        mapPassable = data.passable || {}; 
        
        await loadResources();
        
        // ë§µ ë¦¬ìŠ¤ë„ˆ ì¬êµ¬ë…
        if (mapDocUnsub) mapDocUnsub();
        subscribeToMap(mapName);
        
        // ì±„íŒ… ë¦¬ìŠ¤ë„ˆ ì¬êµ¬ë…
        subscribeToChat();
        
        // ë§µ ì „í™˜ ì‹œ í”Œë ˆì´ì–´ ìœ„ì¹˜ ì´ˆê¸°í™”
        player.x = data.startX || 0;
        player.y = data.startY || 0;
        localStorage.setItem('playerPos', JSON.stringify(player));
        startXInput.value = player.x;
        startYInput.value = player.y;
        
        draw();
        redrawEncList();
        updateControlButtons();
        printLog(`ë§µ [${mapName}]ì„(ë¥¼) ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`, 'system');
        checkGameCompletion(); // ê²Œì„ ì¢…ë£Œ ì¡°ê±´ ì²´í¬
    } else {
        printLog(`ë§µ [${mapName}]ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë§µìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.`, 'system');
        mapNameInput.value = mapName;
        mapUrlInput.value = '';
        spriteUrlInput.value = '';
        bgmUrlInput.value = '';
        encounterPoints = [];
        mapPassable = {};
        await loadResources();
        draw();
        redrawEncList();
        updateControlButtons();
        subscribeToMap(mapName);
        subscribeToChat();
    }
}

/** ë¦¬ì†ŒìŠ¤ ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬) */
async function loadResources() {
    try {
        await loadMapImage(mapUrlInput.value);
        await loadSpriteImage(spriteUrlInput.value);
        loadBGM(bgmUrlInput.value);
        await loadItemsDefinition(); // ì•„ì´í…œ ì •ì˜ ë¡œë“œ
    } catch (e) {
        console.error(e.message);
        printLog(e.message, 'system');
    }
}

/** BGM ë¡œë“œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬) */
function loadBGM(url) {
    if (bgmAudio.src !== url) {
        bgmAudio.src = url;
        bgmAudio.load();
        bgmAudio.play().catch(e => console.log("BGM ìë™ ì¬ìƒ ì°¨ë‹¨ë¨."));
        bgmToggleBtn.textContent = 'STOP';
    }
}

/** ì•„ì´í…œ ì •ì˜ ë¡œë“œ (ì‹ ê·œ ê¸°ëŠ¥) */
async function loadItemsDefinition() {
     if (itemsUnsub) itemsUnsub();
     const itemsRef = collection(db, 'items');
     itemsUnsub = onSnapshot(itemsRef, (snapshot) => {
         itemsDefinitions = {};
         snapshot.forEach(doc => {
             itemsDefinitions[doc.id] = doc.data();
         });
         // ì•„ì´í…œ ì •ì˜ ë¡œë“œ í›„ ì¸ë²¤í† ë¦¬ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
         if (isLoggedIn) updateStatusPanel(); 
     }, err => console.error('ì•„ì´í…œ ì •ì˜ ë¡œë“œ ì‹¤íŒ¨:', err));
}

/* ========================================================================= */
/* BUTTONS & ADMIN LOGIC (ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° ë° í•¨ìˆ˜ ë³µêµ¬) */
/* ========================================================================= */

// ê´€ë¦¬ì: ë§µ ì €ì¥
saveMapBtn.onclick = () => {
    if (!isAdmin) return;
    const mapData = {
        name: mapNameInput.value.trim(),
        mapUrl: mapUrlInput.value.trim(),
        spriteUrl: spriteUrlInput.value.trim(),
        bgmUrl: bgmUrlInput.value.trim(),
        startX: parseInt(startXInput.value) || 0,
        startY: parseInt(startYInput.value) || 0,
        encounters: encounterPoints,
        passable: mapPassable
    };
    saveMapDataToFirestore(mapData.name, mapData).then(() => {
        printLog(`ë§µ **${mapData.name}** ì €ì¥ ì™„ë£Œ.`, 'system');
        updateControlButtons();
    }).catch(e => {
        printLog('ë§µ ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'system');
    });
};

// ê´€ë¦¬ì: ë§µ ë¡œë“œ/ìƒˆë¡œê³ ì¹¨
reloadBtn.onclick = () => {
    if (!isAdmin) return;
    loadMapDataFromFirestore(mapNameInput.value || 'default_map');
};

// ê´€ë¦¬ì: ê·¸ë¦¬ë“œ í† ê¸€
toggleGridBtn.onclick = () => {
    if (!isAdmin) return;
    showGrid = !showGrid;
    toggleGridBtn.textContent = showGrid ? 'ê·¸ë¦¬ë“œ ìˆ¨ê¹€' : 'ê·¸ë¦¬ë“œ í‘œì‹œ';
    draw();
};

// ê´€ë¦¬ì: ì¡°ìš° ì„¤ì • ëª¨ë“œ í† ê¸€
toggleEncounterBtn.onclick = () => {
    if (!isAdmin) return;
    adding = !adding;
    toggleEncounterBtn.textContent = adding ? 'ì¡°ìš° ì„¤ì • ì¤‘ (ì·¨ì†Œ)' : 'ì¡°ìš°';
    document.getElementById('container').style.cursor = adding ? 'crosshair' : 'default';
    printLog(adding ? 'ì¡°ìš° í¬ì¸íŠ¸ ì„¤ì • ëª¨ë“œ í™œì„±í™”ë¨. ë§µì„ í´ë¦­í•˜ì„¸ìš”.' : 'ì¡°ìš° í¬ì¸íŠ¸ ì„¤ì • ëª¨ë“œ ë¹„í™œì„±í™”ë¨.', 'system');
};

// ê´€ë¦¬ì: í”Œë ˆì´ì–´ ìœ„ì¹˜ ì„¤ì •
setPlayerPosBtn.onclick = () => {
    if (!isAdmin) return;
    const x = parseInt(startXInput.value);
    const y = parseInt(startYInput.value);
    if (isNaN(x) || isNaN(y)) return alert('ìœ íš¨í•œ ì¢Œí‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    
    player.x = x; player.y = y;
    localStorage.setItem('playerPos', JSON.stringify(player));
    draw();
    printLog(`ì‹œì‘ ìœ„ì¹˜ë¥¼ (${x}, ${y})ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`, 'system');
};

// ê´€ë¦¬ì: ëª¨ë“  ì¡°ìš° ì‚­ì œ
deleteAllEncountersBtn.onclick = () => {
    if (!isAdmin || !confirm('ì •ë§ë¡œ ëª¨ë“  ì¡°ìš° í¬ì¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    encounterPoints = [];
    saveMapDataToFirestore(currentMapName).then(() => {
        redrawEncList();
        draw();
        printLog('ëª¨ë“  ì¡°ìš° í¬ì¸íŠ¸ ì‚­ì œ ì™„ë£Œ.', 'system');
    });
};

// ê´€ë¦¬ì: ì¡°ìš° ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function redrawEncList() {
    encListDiv.innerHTML = '';
    encounterPoints.forEach((e, i) => {
        const div = document.createElement('div');
        div.className = 'enc-item';
        div.draggable = isAdmin;
        div.dataset.index = i;
        div.style.cssText = 'padding: 5px; margin-bottom: 3px; background: #333; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
        div.innerHTML = `
            <span>[${e.x},${e.y}] ${escapeHtml(e.name || 'ë¯¸ì§€ì • ì¡°ìš°')}</span>
            <div>
                <button data-index="${i}" class="editEncBtn" style="padding: 3px 6px; font-size: 11px;">ìˆ˜ì •</button>
                <button data-index="${i}" class="delEncBtn" style="padding: 3px 6px; font-size: 11px; margin-left: 5px; background: #c0392b;">ì‚­ì œ</button>
            </div>
        `;
        encListDiv.appendChild(div);
    });

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
    encListDiv.querySelectorAll('.editEncBtn').forEach(btn => {
        btn.onclick = (e) => openEditModal(parseInt(e.target.dataset.index));
    });
    encListDiv.querySelectorAll('.delEncBtn').forEach(btn => {
        btn.onclick = (e) => deleteEncounter(parseInt(e.target.dataset.index));
    });
    // Drag/Drop ì´ë²¤íŠ¸ ì—°ê²° (ê¸°ì¡´ ë¡œì§ ê°€ì •)
    // ...
}

// ê´€ë¦¬ì: ì¡°ìš° ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function openEditModal(index) {
    if (!isAdmin) return;
    currentEdit = index;
    const e = encounterPoints[index];
    encName.value = e.name || '';
    encText.value = e.text || '';
    encCharUrl.value = e.charUrl || '';
    encTrigger.value = e.trigger || 'none';
    encData.value = e.data || '';
    
    choicesDiv.innerHTML = '';
    e.choices.forEach(choice => addChoiceUI(choice));
    
    document.getElementById('editModal').style.display = 'flex';
}

// ê´€ë¦¬ì: ì¡°ìš° ì‚­ì œ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function deleteEncounter(index) {
    if (!isAdmin || !confirm('ì •ë§ë¡œ ì´ ì¡°ìš° í¬ì¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    encounterPoints.splice(index, 1);
    saveMapDataToFirestore(currentMapName).then(() => {
        redrawEncList();
        draw();
        printLog(`ì¡°ìš° #${index} ì‚­ì œ ì™„ë£Œ.`, 'system');
    });
}

// ê´€ë¦¬ì: ì„ íƒì§€ ì¶”ê°€ UI (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function addChoiceUI(choice = {}) {
    const c = choicesDiv;
    const div = document.createElement('div');
    div.className = 'choice';
    div.style.cssText = 'border: 1px solid #444; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: rgba(0,0,0,0.3);';
    div.innerHTML = `
        <label>ì„ íƒì§€ í…ìŠ¤íŠ¸</label><input type="text" class="choiceText" value="${escapeHtml(choice.text || '')}">
        <label>ê²°ê³¼ ì§€ë¬¸</label><textarea class="choiceResultText" rows="2">${escapeHtml(choice.resultText || '')}</textarea>
        <label>íŠ¸ë¦¬ê±°</label>
        <select class="choiceTrigger">
            <option value="none">ì—†ìŒ</option>
            <option value="sound">ì‚¬ìš´ë“œ</option>
            <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
            <option value="map">ë§µ ì „í™˜</option>
            <option value="item">ì•„ì´í…œ íšë“</option> 
            <option value="hp">HP ë³€ê²½</option> 
        </select>
        <label>íŠ¸ë¦¬ê±° ë°ì´í„°</label><input type="text" class="choiceData" value="${escapeHtml(choice.data || '')}">
        <button class="removeChoice" style="background:#555;margin-top:10px;">ì‚­ì œ</button>
    `;
    div.querySelector('.choiceTrigger').value = choice.trigger || 'none';
    div.querySelector('.removeChoice').onclick = () => div.remove();
    c.appendChild(div);
}
addChoiceBtn.onclick = () => addChoiceUI();


// ê´€ë¦¬ì: ì¡°ìš° ìˆ˜ì • ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
saveEncEditBtn.onclick = () => {
    const e = encounterPoints[currentEdit];
    e.name = encName.value;
    e.text = encText.value;
    e.charUrl = encCharUrl.value; 
    e.trigger = encTrigger.value;
    e.data = encData.value;
    e.choices = [...document.querySelectorAll('#choices .choice')].map(ch => {
        const triggerSelect = ch.querySelector('.choiceTrigger');
        const dataInput = ch.querySelector('.choiceData');
        return {
            text: ch.querySelector('.choiceText').value,
            resultText: ch.querySelector('.choiceResultText').value, 
            trigger: triggerSelect ? triggerSelect.value : 'none',
            data: dataInput ? dataInput.value : ''
        };
    }).filter(ch => ch.text.trim() !== ''); 
    
    saveMapDataToFirestore(currentMapName).then(() => {
        redrawEncList();
        document.getElementById('editModal').style.display = 'none';
        draw();
        printLog(`ì¡°ìš° #${currentEdit} ì €ì¥ ì™„ë£Œ.`, 'system');
    });
};

closeEncEditBtn.onclick = () => document.getElementById('editModal').style.display = 'none';

// BGM í† ê¸€ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
bgmToggleBtn.onclick = () => {
    if (bgmAudio.paused) {
        bgmAudio.play().then(() => bgmToggleBtn.textContent = 'STOP').catch(e => console.error("BGM ì¬ìƒ ì‹¤íŒ¨:", e));
    } else {
        bgmAudio.pause();
        bgmToggleBtn.textContent = 'PLAY';
    }
};

bgmVolume.oninput = () => {
    bgmAudio.volume = bgmVolume.value;
};


/* ========================================================================= */
/* DATA & FIREBASE (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬ ë° í™•ì¥) */
/* ========================================================================= */

// ë§µ ë°ì´í„° ì €ì¥ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
async function saveMapDataToFirestore(mapName, data = null) {
    if (!isAdmin) return;
    const mapRef = doc(db, 'maps', mapName);
    const finalData = data || {
        name: mapNameInput.value.trim(),
        mapUrl: mapUrlInput.value.trim(),
        spriteUrl: spriteUrlInput.value.trim(),
        bgmUrl: bgmUrlInput.value.trim(),
        startX: parseInt(startXInput.value) || 0,
        startY: parseInt(startYInput.value) || 0,
        encounters: encounterPoints,
        passable: mapPassable
    };
    
    await setDoc(mapRef, finalData, { merge: true });
}

// ë§µ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function subscribeToMap(mapName) {
    if (mapDocUnsub) mapDocUnsub();
    const mapRef = doc(db, 'maps', mapName);
    mapDocUnsub = onSnapshot(mapRef, (docSnap) => {
        if (docSnap.exists() && !isAdmin) { 
            const data = docSnap.data();
            // í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œ ë§µ ë°ì´í„° ë™ê¸°í™”
            mapUrlInput.value = data.mapUrl || '';
            spriteUrlInput.value = data.spriteUrl || '';
            bgmUrlInput.value = data.bgmUrl || '';
            encounterPoints = data.encounters || [];
            mapPassable = data.passable || {};
            
            // ë§µ ë° ìŠ¤í”„ë¼ì´íŠ¸ ì´ë¯¸ì§€, BGM ë™ê¸°í™”
            loadResources();
            draw();
            drawPassableOverlay(); 
            checkEncounter(); // ë§µ ë¡œë“œì‹œ ì¡°ìš° ì²´í¬
        }
    }, err => console.error('ë§µ ë°ì´í„° êµ¬ë… ì‹¤íŒ¨:', err));
}

// í”Œë ˆì´ì–´ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function subscribeToPlayerData(id) {
    if (userUnsub) userUnsub();
    const userRef = doc(db, 'users', id);
    userUnsub = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            currentPlayerData = { id, ...docSnap.data() };
            updateStatusPanel(); 
        } else {
            // í”Œë ˆì´ì–´ ë°ì´í„°ê°€ ì‚­ì œëœ ê²½ìš°
            logoutUser();
        }
    }, err => console.error('í”Œë ˆì´ì–´ ë°ì´í„° êµ¬ë… ì‹¤íŒ¨:', err));
}


/* ========================================================================= */
/* INITIALIZATION (ì´ˆê¸°í™” ë¡œì§ ë³µêµ¬) */
/* ========================================================================= */

// Utility í•¨ìˆ˜
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('\"','&quot;'); }

// ë§µ ëª©ë¡ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function redrawMapButtons() {
    mapButtonsDiv.innerHTML = '';
    const uniqueMaps = [...new Set(mapList)];
    uniqueMaps.forEach(mapName => {
        const btn = document.createElement('button');
        btn.textContent = mapName;
        btn.onclick = () => loadMapDataFromFirestore(mapName);
        mapButtonsDiv.appendChild(btn);
    });
    
    const newBtn = document.createElement('button');
    newBtn.textContent = 'ìƒˆ ë§µ';
    newBtn.onclick = () => {
        const newName = prompt('ìƒˆ ë§µ ì´ë¦„:');
        if (newName && newName.trim()) {
            mapList.push(newName.trim());
            localStorage.setItem('mapList', JSON.stringify(mapList));
            redrawMapButtons();
            loadMapDataFromFirestore(newName.trim());
        }
    };
    mapButtonsDiv.appendChild(newBtn);
}

// ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ í•¨ìˆ˜ ë³µêµ¬)
function updateControlButtons() {
    toggleGridBtn.textContent = showGrid ? 'ê·¸ë¦¬ë“œ ìˆ¨ê¹€' : 'ê·¸ë¦¬ë“œ í‘œì‹œ';
    toggleEncounterBtn.textContent = adding ? 'ì¡°ìš° ì„¤ì • ì¤‘ (ì·¨ì†Œ)' : 'ì¡°ìš°';
}

// ë§µ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ë²„íŠ¼ ë¡œì§ê³¼ ë¶„ë¦¬)
canvas.onclick = handleMapClickOrTileSet;

// í‚¤ë³´ë“œ ì´ë™ ì´ë²¤íŠ¸ (ê¸°ì¡´ ë¡œì§ ê°€ì •)
document.addEventListener('keydown', (e) => {
    if (isEncounterActive || !isLoggedIn || chatInput === document.activeElement) return;

    let dx = 0, dy = 0;
    if (e.key === 'ArrowUp') dy = -1;
    else if (e.key === 'ArrowDown') dy = 1;
    else if (e.key === 'ArrowLeft') dx = -1;
    else if (e.key === 'ArrowRight') dx = 1;

    if (dx !== 0 || dy !== 0) {
        e.preventDefault();
        movePlayer(dx, dy);
    }
});


/* ========================================================================= */
/* MAIN EXECUTION */
/* ========================================================================= */

// ëª¨ë“  ë¡œì§ì´ ì •ì˜ëœ í›„ ì´ˆê¸°í™” ì‹¤í–‰
redrawMapButtons();
updateControlButtons(); 
startXInput.value = player.x;
startYInput.value = player.y;
updateUIVisibility();
loadMapDataFromFirestore(mapList[0] || 'default_map');

</script>
</body>
</html>
