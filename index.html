<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tistoryìš© ê³µí¬ ì¯”ê¾¸ë¥´ (í™•ì¥ ê´€ë¦¬ìíŒ, Firebase í†µí•©)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap');
  :root{
    --bg:#000;
    --panel:rgba(0,0,0,0.85);
    --accent:#c0392b;
    --border-dark:#222;
    --border-light:#444;
    --text-color:#eee;
    --input-bg:#1a1a1a;
    --panel-width: 250px; 
    --main-width: 640px; 
    --main-height: 480px; 
  }
  body{
    margin:0;background:var(--bg);color:var(--text-color);font-family:'Noto Sans KR',sans-serif;
    display:flex;flex-direction:row;align-items:center;justify-content:center;height:100vh;overflow:hidden;
    gap: 10px; 
  }
  #topBar{
    display:flex;justify-content:space-between;width:100%;padding:8px 16px;position:fixed;top:0;right:0;left:0;
    z-index:20;background:var(--panel);box-shadow: 0 2px 5px rgba(0,0,0,0.5);height: 40px;align-items: center;box-sizing: border-box;
  }
  #topBarControls { display: flex; gap: 10px; align-items: center; } 
  #bgmControls { display:flex;gap:10px;align-items:center;flex-shrink:0; }
  #bgmControls button, #adminBtn, #playerLoginBtnTop { padding:5px 10px;font-size:14px;line-height:1;height:30px; }
  #bgmVolume { width:80px;height:4px;background:var(--border-light);-webkit-appearance:none;appearance:none;border-radius:5px;cursor:pointer; }
  #bgmVolume::-webkit-slider-thumb {-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 5px var(--accent);}
  
  /* --- Side Panels: Log/Chat (Left) & Status/Inventory (Right) --- */
  .side-panel {
    width: var(--panel-width);
    height: var(--main-height); 
    background: var(--panel);
    border: 1px solid var(--border-light);
    box-shadow: 0 0 15px rgba(0,0,0,0.5);
    padding: 10px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    z-index: 5;
  }
  
  /* Log/Chat Panel: **[ìˆ˜ì •]** ë¡œê·¸ì¸ ì „ ê¸°ë³¸ ìˆ¨ê¹€ */
  #logChatPanel { order: 1; display: none; }
  
  /* **[ìˆ˜ì •]** ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤: ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€, ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
  #logDisplay {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ëª…ì‹œì ìœ¼ë¡œ ìˆ¨ê¹€ */
    background: var(--input-bg);
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid var(--border-dark);
    word-wrap: break-word; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ */
    overflow-wrap: break-word; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ */
  }
  
  .log-item, .chat-item { 
    font-size: 13px; 
    line-height: 1.4; 
    padding: 2px 0; 
    border-bottom: 1px dotted rgba(255,255,255,0.05); 
    white-space: normal; /* ì¤„ë°”ê¿ˆ í—ˆìš© */
    word-break: break-all; /* ë‹¨ì–´ê°€ ê¸¸ì–´ë„ ê°•ì œ ì¤„ë°”ê¿ˆ */
  }
  
  /* **[ìˆ˜ì •]** ì±„íŒ…ì°½ ì•Œë¦¼(ì‹œìŠ¤í…œ)ì€ ë…¸ë€ìƒ‰, í”Œë ˆì´ì–´/ê´€ë¦¬ì ì±„íŒ… ë‚´ìš©ì€ í°ìƒ‰ */
  .log-item.system { color: #f1c40f; } /* ë…¸ë€ìƒ‰ */
  .log-item.item { color: #2ecc71; }
  .chat-item { color: var(--text-color); } /* í”Œë ˆì´ì–´ ì±„íŒ… (í°ìƒ‰) */
  .chat-item.admin { color: var(--text-color); font-weight: bold; } /* ê´€ë¦¬ì ì±„íŒ… (í°ìƒ‰ìœ¼ë¡œ ë³€ê²½) */
  
  .chat-input-group { display: flex; gap: 5px; }
  .chat-input-group input { flex-grow: 1; }
  .chat-input-group button { flex-shrink: 0; padding: 5px 10px; }
  
  /* Log/Chat Panel UI & Layout Fixes */
  .chat-controls { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 5px;
      gap: 5px; 
  }
  
  #logChatPanel .chat-controls button {
      width: 30px; 
      height: 30px; 
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px; 
      line-height: 1;
      flex-shrink: 0;
  }
  #logToggleBtn { 
      font-size: 18px; 
      margin-right: 5px; 
  } 

  .chat-controls > div {
      display: flex; 
      align-items: center; 
      flex-grow: 1; 
      min-width: 50px; 
  }

  .chat-controls #chatNickname {
      width: 100%; 
      padding: 5px; 
      margin: 0; 
      box-sizing: border-box; 
  }

  .chat-item span.admin-actions { margin-left: auto; display: none; } 
  .chat-item span.admin-actions button { margin-left: 5px; padding: 2px 5px; font-size: 10px; }

  /* Status/Inventory Panel (Right Panel) */
  #statusInventoryPanel { order: 3; display: none; } /* **[ìˆ˜ì •]** ê¸°ë³¸ ìˆ¨ê¹€ */
  
  /* Player Content */
  #playerContent { display: flex; flex-direction: column; flex-grow: 1; }
  #playerStatus {
      padding: 5px;
      border-bottom: 1px solid var(--border-dark);
      margin-bottom: 10px;
  }
  #playerHP { font-size: 16px; font-weight: bold; color: var(--accent); }
  #inventoryList {
      flex-grow: 1;
      overflow-y: auto;
      padding: 5px;
  }
  .inventory-item { 
      display: flex;
      gap: 10px;
      padding: 8px;
      margin-bottom: 5px;
      background: var(--input-bg);
      border-radius: 4px;
      border: 1px solid var(--border-dark);
      align-items: center;
      cursor: pointer;
  }
  .inventory-item:hover { background: #2a2a2a; }
  .item-name { font-weight: bold; font-size: 14px; }
  .item-image { width: 40px; height: 40px; object-fit: cover; border-radius: 3px; border: 1px solid var(--accent); }
  .item-desc { font-size: 12px; color: #aaa; }

  /* Admin Info Content **[ìˆ˜ì •]** ê¹”ë”í•˜ê²Œ ì¬ì •ë ¬ ë° í”Œë ˆì´ì–´ ì •ë³´ ì¶”ê°€ */
  #adminRightInfo { 
      padding: 5px; 
      flex-grow: 1; 
      font-size: 14px; 
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
  }
  #adminRightInfo h4 { 
      width: 100%; 
      margin-top: 0; 
      border-bottom: 1px solid var(--border-dark); 
      padding-bottom: 8px; 
      color: var(--accent); 
  }
  #adminRightInfo p { 
      margin-bottom: 8px; 
      line-height: 1.5;
      flex-shrink: 0; 
  }
  #adminRightInfo hr {
      width: 100%;
      margin: 15px 0;
  }
  #playerOnMapList {
      flex-grow: 1;
      overflow-y: auto;
      margin-top: 5px;
      padding: 5px;
      background: var(--input-bg);
      border-radius: 4px;
      border: 1px solid var(--border-dark);
  }
  .player-on-map-item {
      padding: 5px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.1);
      line-height: 1.4;
  }
  .player-on-map-item:last-child { border-bottom: none; }
  .player-on-map-item strong { color: #5dade2; } 
  .player-on-map-item small { display: block; color: #aaa; font-size: 11px; margin-left: 5px; }
  
  #container{
    order: 2; 
    position:relative;width:var(--main-width);height:var(--main-height);overflow:hidden;border:3px solid var(--border-light);
    box-shadow:0 0 40px var(--accent);background:#000;z-index:5;
  }
  canvas{position:absolute;left:0;top:0;width:100%;height:100%;display:block;z-index:1}
  #grid{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:2}
  #dragGhost { position:absolute;width:32px;height:32px;background:rgba(0,255,255,0.4);border:2px solid cyan;pointer-events:none;display:none;z-index:4; }
  
  /* Admin Panel tabs */
  #adminPanel{
    position:fixed; 
    right: 20px; 
    top: 60px;
    z-index:15;background:var(--panel);padding:15px;border-radius:10px;
    font-size:14px;display:none;min-width:400px;max-width:400px;border:1px solid var(--accent);
    box-shadow:0 0 10px rgba(192,57,43,0.5);max-height: calc(100vh - 80px);overflow-y: auto;
    transition: width 0.3s, height 0.3s, padding 0.3s, overflow 0.3s; 
  }

  /* --- ìŠ¤í¬ë¡¤ë°” ë””ìì¸ í†µì¼ --- */
  #adminPanel, #editModal .modal, #choices, #logDisplay, #inventoryList { 
      scrollbar-width: thin; 
      scrollbar-color: var(--accent) rgba(0,0,0,0.2); 
  }
  #adminPanel::-webkit-scrollbar, 
  #editModal .modal::-webkit-scrollbar, 
  #choices::-webkit-scrollbar, 
  #logDisplay::-webkit-scrollbar,
  #inventoryList::-webkit-scrollbar { 
      width: 8px; 
  }
  #adminPanel::-webkit-scrollbar-thumb, 
  #editModal .modal::-webkit-scrollbar-thumb, 
  #choices::-webkit-scrollbar-thumb, 
  #logDisplay::-webkit-scrollbar-thumb,
  #inventoryList::-webkit-scrollbar-thumb { 
      background-color: var(--accent); 
      border-radius: 4px; 
      visibility: hidden; 
  }
  #adminPanel:hover::-webkit-scrollbar-thumb, 
  #editModal .modal:hover::-webkit-scrollbar-thumb, 
  #choices:hover::-webkit-scrollbar-thumb, 
  #logDisplay:hover::-webkit-scrollbar-thumb,
  #inventoryList:hover::-webkit-scrollbar-thumb { 
      visibility: visible; 
  }
  #adminPanel::-webkit-scrollbar-track,
  #editModal .modal::-webkit-scrollbar-track,
  #choices::-webkit-scrollbar-track,
  #logDisplay::-webkit-scrollbar-track,
  #inventoryList::-webkit-scrollbar-track { 
      background: rgba(0,0,0,0.2); 
  }
  /* --- ìŠ¤í¬ë¡¤ë°” ë --- */
  
  /* Drag handle style */
  #adminPanel h4{
      margin:0 0 12px 0;text-align:center;color:var(--accent);border-bottom: 1px solid var(--border-dark);padding-bottom: 8px;
      cursor: grab; 
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  /* Minimize button style */
  #minimizeBtn {
      background: none;
      border: none;
      color: var(--accent);
      padding: 0 5px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      transition: color 0.2s;
      margin-left: 10px;
  }
  #minimizeBtn:hover { color: #fff; }

  /* Minimized State */
  #adminPanel.minimized {
    width: 150px;
    min-width: 150px;
    height: auto; 
    max-height: 50px;
    padding: 10px 15px;
    overflow: hidden;
    right: 20px !important; 
    left: auto !important;
    top: 60px !important;
  }
  #adminPanel.minimized h4 {
    margin: 0;
    padding: 0;
    border-bottom: none;
  }
  #adminPanel.minimized #minimizeBtn {
      margin-left: 0;
  }
  #adminPanel.minimized .admin-tabs,
  #adminPanel.minimized .admin-tab-content {
    display: none !important;
  }

  
  .admin-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid var(--border-dark); }
  .admin-tabs button { flex: 1; padding: 10px 5px; background: var(--border-dark); border: none; border-radius: 4px 4px 0 0; color: var(--text-color); cursor: pointer; transition: background 0.2s; }
  .admin-tabs button:not(.active):hover { background: #444; }
  .admin-tabs button.active { background: var(--accent); color: #fff; border-bottom: 1px solid var(--accent); }
  
  .admin-tab-content { display: none; }
  .admin-tab-content.active { display: block; }
  
  /* Existing Admin Panel styles */
  .row{display:flex;gap:10px;align-items:center;margin-bottom:10px;width:100%;}
  .row label{white-space:nowrap;min-width: 60px;}
  hr {border: none;border-top: 1px dashed var(--border-dark);margin: 15px 0;}
  input[type=text], input[type=password], input[type=number], select, textarea{
    background:var(--input-bg);border:1px solid var(--border-dark);padding:8px;border-radius:4px;
    color:var(--text-color);width:100%;box-sizing:border-box;transition: border-color 0.2s;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--accent);outline: none;}
  button{
    background:var(--border-dark);border:1px solid var(--border-light);color:var(--text-color);
    padding:8px 12px;border-radius:4px;cursor:pointer;white-space:nowrap;
    transition: background 0.2s, color: 0.2s;text-align: center;
  }
  button:hover{background:var(--accent);border-color:var(--accent);color:#fff;}
  #toggleGrid.active, #toggleEncounter.active, #toggleImpassable.active {background: var(--accent);border-color: var(--accent);color: #fff;}
  
  /* [1. ë¡œë“œ/ê·¸ë¦¬ë“œ/ì¡°ìš°/ì œí•œ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ê°€ë¡œ ë„“ì´ ê· ë“± ë¶„ë°°] */
  .control-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
  }
  .control-group button {
      flex: 1; /* ëª¨ë“  ë²„íŠ¼ì´ ë™ì¼í•œ ë¹„ìœ¨ë¡œ í™•ì¥ */
      min-width: 0;
  }
  
  #adminPanel > .row:first-of-type #mapName {flex-grow: 1;}
  #adminPanel > .row:first-of-type #saveMap {flex-grow: 1;width: auto;flex-shrink: 1;}
  #mapButtons {display: block !important;}
  
  /* [2. ì¡°ìš°/ì œí•œ ì „ì²´ ì‚­ì œ ë²„íŠ¼ ì œê±°ë¡œ ì¸í•œ ë ˆì´ì•„ì›ƒ ìˆ˜ì •] */
  #mapButtons > div {display: flex;gap: 10px;margin-bottom: 5px;width: 100%;}
  #mapButtons > div button {
      flex-grow: 1; 
      min-width: 0;
  }

  /* Map List Item Style */
  .map-list-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 8px; 
      border-bottom: 1px dashed var(--border-dark); 
      cursor: pointer;
      transition: background 0.2s;
  }
  .map-list-item:hover { 
      background: rgba(192, 57, 43, 0.1); 
  }
  .map-list-item span { 
      font-weight: bold; 
      color: var(--text-color);
  }
  .map-list-item:last-child { border-bottom: none; }
  .map-list-item button { 
      padding: 4px 8px; 
      font-size: 11px;
      background: #550000;
      border-color: #770000;
  }
  
  /* Login Boxes - FIXED CSS */
  #loginBox, #playerLoginBox {
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.8); 
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center; 
    z-index:25; 
  }
  #loginBox .modal, #playerLoginBox .modal {
    background:var(--panel);padding:20px;
    border-radius:8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);border:1px solid var(--border-light);
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  #loginBox div, #playerLoginBox div {font-size: 1.1em;margin-bottom: 10px;}
  #loginBox input, #playerLoginBox input{ margin-top:8px;padding:10px;border-radius:4px;border:none;background:#2a2a2a;color:#fff;width:220px;text-align:center; }
  #loginBox button, #playerLoginBox button{ margin-top:15px;padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:4px; }
  #loginBox button:hover, #playerLoginBox button:hover{background: #e74c3c;}
  
  /* User/Item List Styles */
  .list-container { max-height:250px;overflow-y:auto;padding:8px;background:rgba(255,255,255,0.05); border-radius:4px;margin-top:10px;border: 1px solid var(--border-dark); }
  .list-item{ display:flex;justify-content:space-between;gap:8px;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.05);font-size:13px;align-items:center; }
  .list-item:last-child {border-bottom: none;}
  .list-item > span {flex-grow: 1;}
  .list-item div {display: flex;gap: 5px;}
  .list-item button {padding: 4px 8px;font-size: 12px;}
  .list-item button.del {background: #550000;border-color: #770000;}
  .list-item button.del:hover {background: #e74c3c;}
  .list-item input[type=text], .list-item input[type=number] { margin: 0; padding: 4px; height: auto; font-size: 12px; }

  /* Modal Styles */
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:30;}
  .modal{background:#111;padding:15px;border-radius:10px;min-width:450px;max-width: 600px; width: auto;color:var(--text-color);box-sizing:border-box;border:2px solid var(--accent);box-shadow: 0 0 15px rgba(192, 57, 43, 0.7);}
  
  /* ì¡°ìš° íŒì—… ë‚´ ìŠ¤í¬ë¡¤ íŠ€ì–´ë‚˜ì˜´ ë¬¸ì œ ìˆ˜ì • */
  #editModal .modal { 
      min-width: 600px; 
      max-width: 800px; 
      width: 70vw; 
      overflow-y: auto; 
      max-height: 90vh; 
  }
  
  #editModal .modal h4 { margin-top: 5px; margin-bottom: 8px; }
  .modal label { display: block; margin-top: 8px; margin-bottom: 3px; font-weight: bold; color: var(--accent); }
  
  #choices { 
      padding: 5px; 
      border-radius: 4px; 
      max-height: 200px; 
      min-height: 40px; 
      overflow-y: auto; 
      background: rgba(255, 255, 255, 0.03); 
      box-sizing: border-box; 
      margin-top: 5px;
  }
  .choice{ margin-bottom:10px; padding: 8px; width:100%; border: 1px solid var(--border-dark); border-radius: 4px; background: var(--input-bg); box-sizing: border-box; }
  .choice:last-child { margin-bottom: 0; }
  .choice-text-group, .choice-result-group, .choice-trigger-group, .choice-item-group, .choice-hp-group { padding: 2px 0; } 
  .choice label { font-weight: 400; font-size: 13px; color: var(--text-color); margin-top: 5px; margin-bottom: 3px; }
  
  .choice-text-group {display: flex;gap: 5px;width: 100%;align-items: center;}
  .choice-text-group input.choiceText {flex: 1;padding: 6px;line-height: normal; min-width: 0;}
  .choice-text-group button {padding: 6px 10px;font-size: 13px;flex-shrink: 0;width: 30px;height: auto;}
  
  .choice-result-group { display: flex;flex-direction: column;gap: 5px;padding-left: 0;width: 100%;box-sizing: border-box; }
  .choice-result-group textarea.choiceResultText {flex: 1;resize: vertical;min-height: 50px;max-height: 150px;padding: 6px; margin-bottom: 0;}
  
  .choice-trigger-group, .choice-item-group { display: flex; gap: 8px; margin-bottom: 0; align-items: center; padding-left: 0; width: 100%; box-sizing: border-box; }
  .choice-hp-group { display: flex; gap: 8px; margin-bottom: 0; align-items: center; padding-left: 0; width: 100%; box-sizing: border-box; } 
  
  .choice-trigger-group label, .choice-item-group label, .choice-hp-group label { flex-shrink: 0; width: 70px; } 
  .choice-trigger-group select.choiceTrigger { flex: 0 0 120px; width: 120px; padding: 6px; }
  .choice-trigger-group input.choiceData { flex: 1; padding: 6px; min-width: 50px; }
  
  .choice-item-group select, .choice-item-group input {padding: 6px; flex-shrink: 0; }
  .choice-item-group select { width: 150px; }
  .choice-item-group input[type="number"] { width: 80px; text-align: center;} 
  .choice-hp-group input.choiceHpChange { flex: 0 0 80px; width: 80px; text-align: center; padding: 6px; } 

  #addChoiceContainer { text-align: right; margin-top: 10px; margin-bottom: 5px; }
  .modal > div:last-child { margin-top: 10px !important; }
  #encounterModal {min-width: 500px;padding: 20px;}
  #encounterModal h4 {color: #fff;border-color: var(--accent);}
  #encounterModal .info-text { white-space: pre-wrap;background: rgba(255,255,255,0.05);padding: 10px;border-radius: 5px;margin-bottom: 15px;border: 1px solid var(--border-dark);font-style: italic; }
  #encounterChoices button {display: block;width: 100%;margin-top: 10px;background: #444;}
  #encounterChoices button:hover {background: var(--accent);}
  /* **[ìˆ˜ì •]** ì„ íƒì§€ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
  #encounterChoices button:disabled { 
      background: #333 !important; 
      color: #999; 
      opacity: 0.7; 
      cursor: default;
  }
  .char-img-container { display: flex;justify-content: center;margin-bottom: 15px;height: 250px;width: 100%;overflow: hidden; }
  .char-img-container img { max-width: 100%; height: 100%; width: 100%; object-fit: cover; border-radius: 5px; box-shadow: 0 0 10px rgba(192, 57, 43, 0.5); }

  /* Item Use Modal **[ìˆ˜ì •]** ë²„íŠ¼ í•˜ë‹¨ ì •ë ¬ */
  #itemUseModal .modal { 
      min-width: 350px; 
      display: flex; 
      flex-direction: column; 
  }
  #itemUseModal h4 { border-bottom: none; }
  #itemUseModal .item-image { width: 80px; height: 80px; margin: 10px auto; display: block; }
  #itemUseModal .item-desc { 
      text-align: center; 
      margin-bottom: 10px; 
      flex-grow: 1; 
  }
  #itemUseModal .modal > div:last-child {
      padding-top: 10px; 
      border-top: 1px solid var(--border-dark); 
      margin-top: 0;
      display: flex; /* **[ì¶”ê°€]** */
      justify-content: flex-end; /* **[ì¶”ê°€]** */
      gap: 10px;
  }

  /* Inventory Modal */
  #inventoryModal .modal { min-width: 300px; max-height: 80vh; overflow-y: auto; }
  .inventory-admin-item { 
      display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed var(--border-dark);
  }
  .inventory-admin-item:last-child { border-bottom: none; }
  .inventory-admin-item button { 
      background: #550000; border-color: #770000; padding: 4px 8px; font-size: 11px;
      transition: opacity 0.2s;
  }
</style>
</head>
<body>
<audio id="bgmAudio" loop preload="auto"></audio>
<div id="topBar">
    <div id="bgmControls"> 
        <input type="range" id="bgmVolume" min="0" max="1" step="0.05" value="0.5" title="ë³¼ë¥¨">
        <button id="bgmToggleBtn">PLAY</button> 
    </div>
    <div id="topBarControls">
        <button id="playerLoginBtnTop">í”Œë ˆì´ì–´ ë¡œê·¸ì¸</button>
        <button id="adminBtn">ê´€ë¦¬ì</button>
    </div>
</div>

<div id="logChatPanel" class="side-panel">
    <div class="chat-controls">
        <button id="logToggleBtn" title="ì „ì²´ ì±„íŒ… ê¸°ë¡ ë³´ê¸°">
            ğŸ”—
        </button>
        <button id="deleteAllChatBtn" title="ì±„íŒ… ì „ì²´ì‚­ì œ" style="background: #880000; border-color: #aa0000; display: none;">
            ğŸ—‘ï¸
        </button> 
        <div style="display: flex; align-items: center; flex-grow: 1;">
            <input type="text" id="chatNickname" placeholder="ë‹‰ë„¤ì„" value="íƒí—˜ê°€">
        </div>
    </div>
    <div id="logDisplay">
        <div class="log-item system">ì‹œìŠ¤í…œ: ë¡œê·¸/ì±„íŒ… ì‹œì‘.</div>
    </div>
    <div class="chat-input-group">
        <input type="text" id="chatInput" placeholder="ì±„íŒ… ì…ë ¥" disabled>
        <button id="sendChatBtn" disabled>ì „ì†¡</button>
    </div>
</div>

<div id="container">
  <canvas id="game" width="640" height="480"></canvas>
  <div id="grid"></div>
  <div id="dragGhost"></div> 
</div>

<div id="statusInventoryPanel" class="side-panel">
    <div id="playerContent" style="display:none;"> 
        <h4>í”Œë ˆì´ì–´ ìƒíƒœ</h4>
        <div id="playerStatus">
            HP: <span id="playerHP">100</span>
        </div>
        <h4>ì¸ë²¤í† ë¦¬</h4>
        <div id="inventoryList">
        </div>
    </div>
    <div id="adminRightInfo" style="display:none; padding: 5px;">
        <h4>ê´€ë¦¬ì ì •ë³´</h4>
        <p><strong>í˜„ì¬ ë§µ:</strong> <span id="adminInfoMap">-</span></p>
        <p><strong>ë‚¨ì€ ì¡°ìš° ìˆ˜:</strong> <span id="adminInfoRemainingEnc">0</span></p>
        <hr>
        <p style="margin-bottom: 5px;"><strong>í˜„ì¬ ë§µ í”Œë ˆì´ì–´:</strong></p>
        <div id="playerOnMapList">
             <div style="text-align: center; color: #aaa; font-size: 13px;">í”Œë ˆì´ì–´ ì—†ìŒ</div>
        </div>
    </div>
</div>

<div id="adminPanel">
  <h4>
    <span>ê´€ë¦¬ì íŒ¨ë„</span>
    <button id="minimizeBtn" title="ìµœì†Œí™”/ë³µì›">[â€”]</button>
  </h4>
  
  <div class="admin-tabs">
    <button id="mapTabBtn" class="active">ë§µ ì„¤ì •</button>
    <button id="userTabBtn">ì‚¬ìš©ì ê´€ë¦¬</button>
    <button id="itemTabBtn">ì•„ì´í…œ ê´€ë¦¬</button>
  </div>
  
  <div id="mapTabContent" class="admin-tab-content active">
    <div class="row"><label>ë§µ ì´ë¦„</label><input id="mapName" type="text"><button id="saveMap">ë§µ ì €ì¥</button></div>
    <div class="row"><label>ë§µ ì´ë¯¸ì§€</label><input id="mapUrl" type="text" placeholder="ì´ë¯¸ì§€ URL"></div>
    <div class="row"><label>BGM URL</label><input id="bgmUrl" type="text" placeholder="ë°°ê²½ìŒì•… URL"></div> 
    <div class="row">
        <label>ì‹œì‘ ì¢Œí‘œ</label>
        <input id="startX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
        <input id="startY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
        <button id="setPlayerPos" style="flex-shrink: 0;">ì„¤ì •</button>
    </div>
    
    <div class="row">
        <label>ë§µ ì´ë™ ì¢Œí‘œ</label>
        <input id="transitionX" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="X">
        <input id="transitionY" type="number" min="0" style="width: 50px; flex-grow: 0; text-align: center;" placeholder="Y">
        <button id="setTransitionPos" style="flex-shrink: 0;">ì„¤ì •</button>
    </div>
    <div class="row"><label>ì´ë™í•  ë§µ</label><input id="nextMapName" type="text" placeholder="í´ë¦¬ì–´ ì‹œ ì´ë™í•  ë§µ ì´ë¦„"></div>

    <div class="control-group"> 
      <button id="reload">ë¡œë“œ</button>
      <button id="toggleGrid">ê·¸ë¦¬ë“œ</button>
      <button id="toggleEncounter">ì¡°ìš° ì¶”ê°€</button> 
      <button id="toggleImpassable">ì œí•œ ì¶”ê°€</button> 
    </div>
    
    <hr>
    
    <p style="text-align: center; color: #999; font-size: 13px;">ë§µ ìƒì˜ ì¡°ìš° ë° ì´ë™ ì œí•œ êµ¬ì—­ì„ **í´ë¦­**í•˜ì—¬ ìˆ˜ì •/ì‚­ì œí•©ë‹ˆë‹¤.</p>
    
    <div id="mapButtons" style="margin-top:10px;">
        <div class="row"> 
            <button id="initMapBtn" style="background: #e74c3c; border-color: #c0392b;">í˜„ì¬ ë§µ ì´ˆê¸°í™” (ì‚­ì œ X)</button>
        </div>
    </div>

    <hr>
    <h5>ì €ì¥ëœ ë§µ ëª©ë¡ (í´ë¦­ ë¡œë“œ)</h5>
    <div class="list-container" id="mapListContainer">
        </div>
  </div>
  
  <div id="userTabContent" class="admin-tab-content">
    <h5>í”Œë ˆì´ì–´ ê³„ì • ê´€ë¦¬</h5>
    <div class="row">
      <input type="text" id="newUserId" placeholder="ìƒˆ í”Œë ˆì´ì–´ ID">
      <input type="text" id="newUserCharUrl" placeholder="ìºë¦­í„° ì´ë¯¸ì§€ URL">
      <button id="addPlayerBtn">ìƒì„±</button>
    </div>
    <div class="list-container" id="userList"></div>
    
    <h5 style="margin-top: 15px;">í”Œë ˆì´ì–´ ìƒíƒœ ê´€ë¦¬</h5>
    <div class="row">
        <select id="selectPlayerId" style="flex-grow: 1;"></select>
        <input type="number" id="playerHpInput" placeholder="HP" style="width: 50px;">
        <button id="updatePlayerStatusBtn">ìƒíƒœ ì €ì¥</button>
    </div>

    <h5 style="margin-top: 15px;">í”Œë ˆì´ì–´ ë§µ/ìœ„ì¹˜ ê´€ë¦¬</h5>
    <div class="row">
        <select id="selectPlayerIdMap" style="flex-grow: 1;"></select>
        <input type="text" id="playerMapInput" placeholder="ë§µ ì´ë¦„">
        <input type="number" id="playerXInput" placeholder="X" min="0" style="width: 50px;">
        <input type="number" id="playerYInput" placeholder="Y" min="0" style="width: 50px;">
        <button id="updatePlayerMapBtn">ìœ„ì¹˜ ì €ì¥</button>
    </div>

    <h5 style="margin-top: 15px;">ì•„ì´í…œ ì§ì ‘ ì§€ê¸‰</h5>
    <div class="row">
        <select id="giveItemPlayerSelect" style="flex-grow: 1;"></select>
        <select id="giveItemSelect" style="width: 120px;"></select> <button id="giveItemBtn">ì§€ê¸‰</button>
    </div>
  </div>

  <div id="itemTabContent" class="admin-tab-content">
    <h5>ì•„ì´í…œ ì •ì˜ ê´€ë¦¬</h5>
    <div class="row">
      <input type="text" id="newItemId" placeholder="ì•„ì´í…œ ID (ê³ ìœ )">
      <input type="text" id="newItemName" placeholder="ì•„ì´í…œ ì´ë¦„">
    </div>
    <div class="row">
        <input type="text" id="newItemImageUrl" placeholder="ì´ë¯¸ì§€ URL">
        <input type="number" id="newItemHpRecover" placeholder="HP íšŒë³µëŸ‰ (0ì´ë©´ ì‚¬ìš© ë¶ˆê°€)" min="0" value="0" style="width: 80px;"> <button id="addItemBtn" style="flex-shrink: 0;">ë“±ë¡</button>
    </div>
    <textarea id="newItemDescription" placeholder="ì•„ì´í…œ ì„¤ëª…" rows="2"></textarea>
    <div class="list-container" id="itemList"></div> </div>
</div>

<div class="modal-bg" id="loginBox">
  <div class="modal">
    <div>ê´€ë¦¬ì ë¡œê·¸ì¸</div>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
    <button id="loginBtn">ë¡œê·¸ì¸</button>
  </div>
</div>

<div class="modal-bg" id="playerLoginBox">
    <div class="modal">
      <div>í”Œë ˆì´ì–´ ë¡œê·¸ì¸</div>
      <input type="text" id="playerIdInput" placeholder="ì•„ì´ë”” ì…ë ¥">
      <button id="playerLoginBtnSubmit">ë¡œê·¸ì¸</button>
    </div>
</div>

<div class="modal-bg" id="editModal">
  <div class="modal">
    <h4>ì¡°ìš° ìˆ˜ì •</h4>
    <label>ì´ë¦„</label><input id="encName" type="text">
    <label>ì§€ë¬¸</label><textarea id="encText" placeholder="ì¡°ìš° ì‹œ í”Œë ˆì´ì–´ì—ê²Œ ë³´ì¼ ì§€ë¬¸" rows="3"></textarea>
    
    <label>íšë“ ì•„ì´í…œ ID (ì„ íƒ)</label>
    <select id="encItemIdSelect" style="margin-bottom: 5px;"></select>
    <input id="encItemIdManual" type="text" placeholder="ì§ì ‘ ì…ë ¥ ë˜ëŠ” ìƒˆë¡œìš´ ì•„ì´í…œ ID" style="display:none;">
    <input type="checkbox" id="encItemIdManualCheck"><label for="encItemIdManualCheck" style="display: inline-block; font-weight: normal; margin-left: 5px; color: #aaa;">ì§ì ‘ ì…ë ¥/ì—†ëŠ” ì•„ì´í…œ</label>

    <label>ìºë¦­í„° ì´ë¯¸ì§€ URL</label><input id="encCharUrl" type="text" placeholder="ì¡°ìš° ì‹œ ë„ìš¸ ì´ë¯¸ì§€ URL">
    
    <label id="choicesLabel">ì„ íƒì§€</label> <div id="choices"></div>
    <div id="addChoiceContainer" style="text-align: right;"><button id="addChoice">ì„ íƒì§€ ì¶”ê°€</button></div>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° (ì„ íƒì§€ê°€ ì—†ì„ ë•Œë§Œ ì‚¬ìš©)</label>
    <select id="encTrigger">
        <option value="none">ì—†ìŒ</option>
        <option value="sound">ì‚¬ìš´ë“œ</option>
        <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
        <option value="map">ë§µ ì „í™˜</option>
    </select>
    
    <label>ê¸°ë³¸ íŠ¸ë¦¬ê±° ë°ì´í„°(URL/ë§µëª…)</label><input id="encData" type="text">
    
    <div style="margin-top:20px; text-align:right; display: flex; justify-content: space-between; align-items: center;"> 
        <button id="deleteEncEdit" style="background: #e74c3c; border-color: #c0392b; font-size: 18px; line-height: 1; padding: 6px 10px;">
            ğŸ—‘ï¸
        </button>
        <div>
            <button id="saveEncEdit">ì €ì¥</button>
            <button id="closeEncEdit">ë‹«ê¸°</button>
        </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="encounterModalBg">
    <div class="modal" id="encounterModal">
        <div class="char-img-container" id="encCharImgContainer">
            <img id="encCharImg" alt="Encounter Character" style="display:none;"/>
        </div>
        <h4 id="encModalName"></h4>
        <div class="info-text" id="encModalText"></div>
        <div id="encounterChoices"></div> <div style="margin-top:20px;text-align:right"><button id="closeEncounterModal">ê³„ì† ì§„í–‰</button></div>
    </div>
</div>

<div class="modal-bg" id="itemUseModalBg">
    <div class="modal" id="itemUseModal">
        <h4 id="itemUseName"></h4>
        <img id="itemUseImage" class="item-image" alt="Item Image"/>
        <div class="item-desc" id="itemUseDescription"></div>
        <div>
            <button id="useItemBtn" style="background: #2ecc71;">ì‚¬ìš©</button>
            <button id="closeItemUseModal">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="inventoryModal">
    <div class="modal">
        <h4 id="inventoryModalTitle">í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬</h4>
        <div class="list-container" id="inventoryModalList"> 
        </div>
        <div style="margin-top:10px;text-align:right">
            <button id="closeInventoryModal">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script type="module">
/* Firebase + ì•± ë¡œì§ í†µí•© */
// NOTE: Please replace with your actual Firebase configuration
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, getDocs, onSnapshot, updateDoc, arrayUnion, arrayRemove, where, orderBy, limit, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyCtPPF9Y93XVKHjo5_mmmxycf0CUJjWIRo", // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ í‚¤ë¡œ ë³€ê²½í•˜ì„¸ìš”
    authDomain: "horror-game-14aa8.firebaseapp.com",
    projectId: "horror-game-14aa8",
    storageBucket: "horror-game-14aa8.firebasestorage.app",
    messagingSenderId: "125297141331",
    appId: "1:125299141331:web:a15f971c34dde0c7d708a6"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_EMAIL = "test@gmail.com"; // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ ê´€ë¦¬ì ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ì„¸ìš”
const ADMIN_DUMMY_PW = "testpassword"; // <-- [í•„ìˆ˜ ìˆ˜ì •] ì‹¤ì œ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•˜ì„¸ìš”
const GRID = 32;
const MAX_HP = 100;

/* --- State Variables --- */
// **[ìˆ˜ì •]** encountered í•„ë“œ ìˆ˜ì •: { x_y: { usedChoices: ["choiceId1", ...], visited: true } }
let player = { 
    x: 0, 
    y: 0, 
    hp: MAX_HP, 
    charUrl: '', 
    inventory: {}, 
    encountered: {} // Key: "mapname_x_y", Value: { usedChoices: ["choiceId"], visited: true }
}; 
let currentMapName = 'default';
let encounterPoints = []; // [{x, y, data: {...}}]
let impassablePoints = []; // [{x, y}]
let mapData = { url: '', spriteUrl: '', bgmUrl: '', startX: 0, startY: 0, transitionX: null, transitionY: null, nextMapName: '' };
let isGridMode = false;
let isEncounterMode = false;
let isImpassableMode = false;
let dragStartPoint = null;
let currentEdit = null; // Currently selected encounter point for editing
let itemDefinitions = {}; // {itemId: {name, imageUrl, hpRecover, description}}
let loggedInUserId = null;
let playerMode = false;
let currentSelectedItem = null; // Item ID for itemUseModal
let adminMode = false;
let chatUnsub = null;
let usersData = {}; // {userId: {hp, currentMap, x, y, charUrl, inventory, encountered}} 
let characterImage = new Image();
let mapImage = new Image();
let mapLoaded = false;
let isMoving = false;
let isEncountering = false;
let animationFrameId = null;

/* --- UI Bindings (Explicitly defined to fix ReferenceError) --- */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const logDisplay = document.getElementById('logDisplay');
const bgmAudio = document.getElementById('bgmAudio');
const bgmToggleBtn = document.getElementById('bgmToggleBtn');
const bgmVolume = document.getElementById('bgmVolume');
const playerHPDisplay = document.getElementById('playerHP');

// Main Game/Admin
const container = document.getElementById('container');
const adminPanel = document.getElementById('adminPanel');
const mapNameInput = document.getElementById('mapName');
const mapUrlInput = document.getElementById('mapUrl');
const bgmUrlInput = document.getElementById('bgmUrl');
const startXInput = document.getElementById('startX');
const startYInput = document.getElementById('startY');
const transitionXInput = document.getElementById('transitionX');
const transitionYInput = document.getElementById('transitionY');
const nextMapNameInput = document.getElementById('nextMapName');
const adminBtn = document.getElementById('adminBtn');
// **[ìˆ˜ì •]** ë§µ ì´ˆê¸°í™” ë²„íŠ¼ ID ë³€ê²½ ë° ë°”ì¸ë”©
const initMapBtn = document.getElementById('initMapBtn'); 

// Admin Modals (Encounter Edit)
const editModal = document.getElementById('editModal');
const encNameInput = document.getElementById('encName');
const encTextInput = document.getElementById('encText');
const encCharUrlInput = document.getElementById('encCharUrl');
const encTriggerSelect = document.getElementById('encTrigger');
const encDataInput = document.getElementById('encData');
const encItemIdSelect = document.getElementById('encItemIdSelect');
const encItemIdManual = document.getElementById('encItemIdManual');
const encItemIdManualCheck = document.getElementById('encItemIdManualCheck');
const choicesDiv = document.getElementById('choices');

// Player Modals (Encounter/Item)
const encounterModalBg = document.getElementById('encounterModalBg');
const encModalName = document.getElementById('encModalName');
const encModalText = document.getElementById('encModalText');
const encounterChoicesDiv = document.getElementById('encounterChoices');
const closeEncounterModalBtn = document.getElementById('closeEncounterModal');
const itemUseModalBg = document.getElementById('itemUseModalBg');
const useItemBtn = document.getElementById('useItemBtn');
const closeItemUseModalBtn = document.getElementById('closeItemUseModal');

// Item/User Tab elements
const itemListDiv = document.getElementById('itemList'); // **[ì¶”ê°€]** ì•„ì´í…œ ëª©ë¡ ì»¨í…Œì´ë„ˆ
const giveItemSelect = document.getElementById('giveItemSelect'); // **[ì¶”ê°€]** ì•„ì´í…œ ì§€ê¸‰ ë“œë¡­ë‹¤ìš´


/* --- Utility Functions --- */

const addLogItem = (text, type = 'log', isChat = false) => {
    const item = document.createElement('div');
    item.className = isChat ? `chat-item ${type}` : `log-item ${type}`;
    item.innerHTML = text;
    logDisplay.appendChild(item);
    logDisplay.scrollTop = logDisplay.scrollHeight;
};

const showModal = (modalElement) => {
    modalElement.style.display = 'flex';
};

const hideModal = (modalElement) => {
    modalElement.style.display = 'none';
};

const generateUniqueId = () => {
    return '_' + Math.random().toString(36).substr(2, 9);
};

/* --- Game Engine Logic --- */

const drawMap = () => {
    // ... (map drawing logic)
    if (!mapLoaded || !mapImage.complete) {
        ctx.fillStyle = 'black';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.fillText('ë§µ ë¡œë”© ì¤‘...', canvas.width / 2, canvas.height / 2);
        return;
    }
    ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

    if (isGridMode) {
        drawGrid();
    }
    drawImpassablePoints();
    drawEncounterPoints();
    drawStartPoint();
    drawTransitionPoint();
};

const drawImpassablePoints = () => {
    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
    impassablePoints.forEach(p => {
        ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID);
    });
};

const drawEncounterPoints = () => {
    ctx.fillStyle = 'rgba(0, 255, 255, 0.5)';
    encounterPoints.forEach(p => {
        ctx.fillRect(p.x * GRID, p.y * GRID, GRID, GRID);
    });
};

const drawStartPoint = () => {
    ctx.fillStyle = 'rgba(0, 255, 0, 0.7)';
    ctx.fillRect(mapData.startX * GRID, mapData.startY * GRID, GRID, GRID);
    ctx.strokeStyle = 'lime';
    ctx.lineWidth = 2;
    ctx.strokeRect(mapData.startX * GRID + 2, mapData.startY * GRID + 2, GRID - 4, GRID - 4);
};

const drawTransitionPoint = () => {
    if (mapData.transitionX !== null && mapData.transitionY !== null) {
        ctx.fillStyle = 'rgba(255, 255, 0, 0.7)';
        ctx.fillRect(mapData.transitionX * GRID, mapData.transitionY * GRID, GRID, GRID);
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 2;
        ctx.strokeRect(mapData.transitionX * GRID + 2, mapData.transitionY * GRID + 2, GRID - 4, GRID - 4);
    }
};

const drawGrid = () => {
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 1;
    for (let x = 0; x < canvas.width / GRID; x++) {
        ctx.beginPath();
        ctx.moveTo(x * GRID, 0);
        ctx.lineTo(x * GRID, canvas.height);
        ctx.stroke();
    }
    for (let y = 0; y < canvas.height / GRID; y++) {
        ctx.beginPath();
        ctx.moveTo(0, y * GRID);
        ctx.lineTo(canvas.width, y * GRID);
        ctx.stroke();
    }
};

const drawPlayer = () => {
    if (!loggedInUserId || !playerMode) return;
    
    // Fallback if character image is not loaded
    if (!characterImage.complete || !player.charUrl) {
        ctx.fillStyle = 'blue';
        ctx.fillRect(player.x * GRID, player.y * GRID, GRID, GRID);
        return;
    }

    ctx.drawImage(characterImage, player.x * GRID, player.y * GRID, GRID, GRID);
};

const draw = () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawMap();
    drawPlayer();
    animationFrameId = requestAnimationFrame(draw);
};

/* --- Firebase Interaction: Player State --- */

const savePlayerState = async () => {
    if (!loggedInUserId) return;
    try {
        const playerRef = doc(db, 'players', loggedInUserId);
        await setDoc(playerRef, {
            id: loggedInUserId,
            hp: player.hp,
            currentMap: currentMapName,
            x: player.x,
            y: player.y,
            charUrl: player.charUrl,
            inventory: player.inventory,
            encountered: player.encountered // **[ìˆ˜ì •]** encountered í•„ë“œ ì €ì¥
        }, { merge: true });
        // updatePlayerOnMapList(); // Keep the admin right panel updated
    } catch (e) {
        console.error("Error saving player state: ", e);
    }
};

const loadPlayerState = async (playerId) => {
    const playerRef = doc(db, 'players', playerId);
    const docSnap = await getDoc(playerRef);

    if (docSnap.exists()) {
        const data = docSnap.data();
        player.x = data.x || mapData.startX || 0;
        player.y = data.y || mapData.startY || 0;
        player.hp = data.hp || MAX_HP;
        player.charUrl = data.charUrl || '';
        player.inventory = data.inventory || {};
        player.encountered = data.encountered || {}; // **[ìˆ˜ì •]** encountered í•„ë“œ ë¡œë“œ

        // Load character image
        if (player.charUrl && player.charUrl !== characterImage.src) {
            characterImage.onload = () => {
                draw(); // Redraw once image is loaded
            };
            characterImage.src = player.charUrl;
        }

        // Check if the map has changed
        if (data.currentMap && data.currentMap !== currentMapName) {
            await loadMapDataFromFirestore(data.currentMap);
        }
        
        updatePlayerUI(true);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ [${playerId}] ìƒíƒœ ë¡œë“œ ì™„ë£Œ. í˜„ì¬ ë§µ: ${currentMapName}`, 'system');

        // Check if player is on a map different from the one they logged into.
        if (data.currentMap && data.currentMap !== currentMapName) {
            await loadMapDataFromFirestore(data.currentMap);
        }

    } else {
        // New player: Initialize state
        player.x = mapData.startX || 0;
        player.y = mapData.startY || 0;
        player.hp = MAX_HP;
        player.inventory = {};
        player.encountered = {}; // **[ìˆ˜ì •]** ì´ˆê¸°í™”
        
        // Find the user's initial charUrl from usersData if available
        const userData = usersData[playerId];
        player.charUrl = userData ? userData.charUrl : ''; 
        if (player.charUrl && player.charUrl !== characterImage.src) {
             characterImage.src = player.charUrl;
        }

        // Save initial state
        await savePlayerState();
        addLogItem(`ì‹œìŠ¤í…œ: ìƒˆë¡œìš´ í”Œë ˆì´ì–´ [${playerId}] ìƒíƒœ ì´ˆê¸°í™” ë° ì €ì¥.`, 'system');
    }
};

/* --- Firebase Interaction: Map Data --- */

const loadMapDataFromFirestore = async (mapId) => {
    const mapRef = doc(db, 'maps', mapId);
    const docSnap = await getDoc(mapRef);

    if (docSnap.exists()) {
        const data = docSnap.data();
        currentMapName = mapId;
        mapData = {
            url: data.url || '',
            bgmUrl: data.bgmUrl || '',
            startX: data.startX || 0,
            startY: data.startY || 0,
            transitionX: data.transitionX === undefined ? null : data.transitionX,
            transitionY: data.transitionY === undefined ? null : data.transitionY,
            nextMapName: data.nextMapName || ''
        };
        encounterPoints = data.encounterPoints || [];
        impassablePoints = data.impassablePoints || [];

        // Update Admin UI
        mapNameInput.value = currentMapName;
        mapUrlInput.value = mapData.url;
        bgmUrlInput.value = mapData.bgmUrl;
        startXInput.value = mapData.startX;
        startYInput.value = mapData.startY;
        transitionXInput.value = mapData.transitionX === null ? '' : mapData.transitionX;
        transitionYInput.value = mapData.transitionY === null ? '' : mapData.transitionY;
        nextMapNameInput.value = mapData.nextMapName;
        document.getElementById('adminInfoMap').textContent = currentMapName;
        document.getElementById('adminInfoRemainingEnc').textContent = encounterPoints.length;

        // Load map image
        mapLoaded = false;
        mapImage.onload = () => {
            mapLoaded = true;
            draw();
        };
        mapImage.onerror = () => {
            mapLoaded = true;
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨. ë¹ˆ í™”ë©´ìœ¼ë¡œ ëŒ€ì²´.`, 'system');
            draw();
        };
        mapImage.src = mapData.url || '';

        // Play BGM
        if (mapData.bgmUrl) {
            bgmAudio.src = mapData.bgmUrl;
            bgmAudio.play().catch(e => console.log("BGM Play failed (user interaction required):", e));
            bgmToggleBtn.textContent = 'PAUSE';
        } else {
            bgmAudio.pause();
            bgmToggleBtn.textContent = 'PLAY';
            bgmAudio.src = '';
        }

        addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${currentMapName}** ë¡œë“œ ì™„ë£Œ.`, 'system');

        return true;
    } else {
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${mapId}** ë°ì´í„° ì—†ìŒ. ì´ˆê¸° ìƒíƒœë¡œ ë¡œë“œ.`, 'system');
        
        // Save an empty map document to Firestore so it appears in the list
        await setDoc(mapRef, {
            url: '',
            bgmUrl: '',
            startX: 0,
            startY: 0,
            transitionX: null,
            transitionY: null,
            nextMapName: '',
            encounterPoints: [],
            impassablePoints: []
        });

        // Local state reset for empty map
        currentMapName = mapId;
        mapData = { url: '', bgmUrl: '', startX: 0, startY: 0, transitionX: null, transitionY: null, nextMapName: '' };
        encounterPoints = [];
        impassablePoints = [];
        mapNameInput.value = currentMapName; 
        mapUrlInput.value = '';
        bgmUrlInput.value = '';
        startXInput.value = 0;
        startYInput.value = 0;
        transitionXInput.value = '';
        transitionYInput.value = '';
        nextMapNameInput.value = '';
        document.getElementById('adminInfoMap').textContent = currentMapName;
        document.getElementById('adminInfoRemainingEnc').textContent = 0;

        mapLoaded = true;
        mapImage.src = '';
        bgmAudio.pause();
        bgmToggleBtn.textContent = 'PLAY';
        bgmAudio.src = '';

        return false;
    }
};

const saveMapData = async () => {
    const mapId = mapNameInput.value.trim();
    if (!mapId) {
        alert('ë§µ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const mapRef = doc(db, 'maps', mapId);

    mapData.url = mapUrlInput.value;
    mapData.bgmUrl = bgmUrlInput.value;
    mapData.startX = parseInt(startXInput.value) || 0;
    mapData.startY = parseInt(startYInput.value) || 0;
    mapData.transitionX = transitionXInput.value ? parseInt(transitionXInput.value) : null;
    mapData.transitionY = transitionYInput.value ? parseInt(transitionYInput.value) : null;
    mapData.nextMapName = nextMapNameInput.value;

    try {
        await setDoc(mapRef, {
            ...mapData,
            encounterPoints: encounterPoints,
            impassablePoints: impassablePoints
        }, { merge: false });

        currentMapName = mapId; // Ensure currentMapName is updated if a new map was created/saved
        await loadMapDataFromFirestore(currentMapName); // Reload to apply changes immediately
        await reloadMapList(); // Update the map list
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${mapId}** ì €ì¥ ì™„ë£Œ.`, 'system');

        // Update all players on the old map (if mapId changed)
        if (mapId !== currentMapName) {
             // This case is unlikely if we always set currentMapName = mapId above, but included for robustness.
        }

    } catch (e) {
        console.error("Error saving map data: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì €ì¥ ì‹¤íŒ¨.`, 'system');
    }
};

// **[ìˆ˜ì •]** ë§µ ì‚­ì œ ê¸°ëŠ¥ ì œê±°, ë§µ ì´ˆê¸°í™” ê¸°ëŠ¥ìœ¼ë¡œ ë³€ê²½
const initCurrentMap = async () => {
    if (!currentMapName || currentMapName === 'default') {
         alert('ê¸°ë³¸ ë§µì€ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
         return;
    }
    
    if (confirm(`**${currentMapName}** ë§µì˜ ëª¨ë“  ì¡°ìš°, ì œí•œ êµ¬ì—­, ì‹œì‘ ì¢Œí‘œ, ì´ë™ ì¢Œí‘œ, BGM URL, ë§µ ì´ë¯¸ì§€ URLì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë§µ ìì²´ì˜ Firestore ë¬¸ì„œëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)`)) {
        addLogItem(`ì‹œìŠ¤í…œ: **${currentMapName}** ë§µ ì´ˆê¸°í™” ì‹œì‘. (Firestore ë¬¸ì„œ ìœ ì§€)`, 'system');

        const mapRef = doc(db, 'maps', currentMapName);

        // Map data to reset to minimal state
        const resetMapData = {
            url: '',
            bgmUrl: '',
            startX: 0,
            startY: 0,
            transitionX: null,
            transitionY: null,
            nextMapName: '',
            encounterPoints: [],
            impassablePoints: []
        };
        
        try {
            // Update the map document to reset all fields
            await setDoc(mapRef, resetMapData);

            // Local state reset
            mapData = resetMapData;
            encounterPoints = [];
            impassablePoints = [];
            
            // Update UI
            mapUrlInput.value = '';
            bgmUrlInput.value = '';
            startXInput.value = 0;
            startYInput.value = 0;
            transitionXInput.value = '';
            transitionYInput.value = '';
            nextMapNameInput.value = '';
            document.getElementById('adminInfoRemainingEnc').textContent = 0;
            
            // Reload map image/bgm
            mapImage.src = '';
            mapLoaded = true;
            bgmAudio.pause();
            bgmToggleBtn.textContent = 'PLAY';
            bgmAudio.src = '';

            addLogItem(`ì‹œìŠ¤í…œ: **${currentMapName}** ë§µ ì´ˆê¸°í™” ì™„ë£Œ.`, 'system');
            draw();
            
            // Note: Player position reset to (0,0) will happen on next login/map load if mapData.startX/Y are 0.
            // For the admin's immediate view, the player is moved to (0,0) only if mapData.startX/Y are used on load.
            // We'll update the player's position to the new start point (0,0) if they are on this map.
            if (loggedInUserId && playerMode && currentMapName === player.currentMap) {
                 player.x = 0;
                 player.y = 0;
                 await savePlayerState();
            }

        } catch (e) {
            console.error("Error initializing map: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ˆê¸°í™” ì‹¤íŒ¨.`, 'system');
        }
    }
};

const deleteMap = async (mapId) => {
    if (mapId === 'default') {
        alert('ê¸°ë³¸ ë§µì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    if (confirm(`ë§µ **${mapId}**ë¥¼ Firestoreì—ì„œ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
            await deleteDoc(doc(db, 'maps', mapId));
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${mapId}** ì‚­ì œ ì™„ë£Œ.`, 'system');
            await reloadMapList();
            if (mapId === currentMapName) {
                // If current map is deleted, load 'default'
                await loadMapDataFromFirestore('default');
            }
        } catch (e) {
            console.error("Error deleting map: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì‚­ì œ ì‹¤íŒ¨.`, 'system');
        }
    }
};

const reloadMapList = async () => {
    const mapListContainer = document.getElementById('mapListContainer');
    mapListContainer.innerHTML = '';
    
    try {
        const q = query(collection(db, 'maps'), orderBy('__name__'));
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
            mapListContainer.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ì €ì¥ëœ ë§µì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        querySnapshot.forEach((doc) => {
            const mapId = doc.id;
            const item = document.createElement('div');
            item.className = 'map-list-item';
            item.innerHTML = `
                <span title="í´ë¦­í•˜ì—¬ ë¡œë“œ">${mapId}</span>
                <div>
                    <button onclick="deleteMap('${mapId}')" style="background: #e74c3c; border-color: #c0392b;">ì‚­ì œ</button>
                </div>
            `;
            item.querySelector('span').addEventListener('click', () => loadMapDataFromFirestore(mapId));
            mapListContainer.appendChild(item);
        });
    } catch (e) {
        console.error("Error reloading map list: ", e);
        mapListContainer.innerHTML = '<div style="text-align: center; color: #ff0000; font-size: 13px;">ë§µ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜.</div>';
    }
};

/* --- Encounter Logic --- */

const getEncounterAt = (x, y) => {
    return encounterPoints.find(p => p.x === x && p.y === y);
};

const getImpassableAt = (x, y) => {
    return impassablePoints.find(p => p.x === x && p.y === y);
};

const addEncounter = (x, y, data = {}) => {
    const existing = getEncounterAt(x, y);
    if (existing) {
        alert('ì´ë¯¸ ì¡°ìš° ì§€ì ì´ ìˆìŠµë‹ˆë‹¤. ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
        openEditModal(existing);
        return;
    }
    
    // Create a new encounter object with a unique choice ID structure
    const newEncData = {
        name: 'ìƒˆë¡œìš´ ì¡°ìš°',
        text: 'ì¡°ìš° ì§€ë¬¸',
        charUrl: '',
        itemId: '',
        trigger: 'none',
        data: '',
        choices: [
            { id: generateUniqueId(), text: 'ì„ íƒì§€ 1', resultText: 'ì„ íƒì§€ 1 ê²°ê³¼ ì§€ë¬¸', trigger: 'none', data: '', hpChange: 0, itemId: '' },
            { id: generateUniqueId(), text: 'ì„ íƒì§€ 2', resultText: 'ì„ íƒì§€ 2 ê²°ê³¼ ì§€ë¬¸', trigger: 'none', data: '', hpChange: 0, itemId: '' }
        ],
        ...data 
    };

    const newEnc = { x, y, data: newEncData };
    encounterPoints.push(newEnc);
    document.getElementById('adminInfoRemainingEnc').textContent = encounterPoints.length;
    openEditModal(newEnc); 
    draw();
};

const openEditModal = (enc) => {
    currentEdit = enc;
    encNameInput.value = enc.data.name;
    encTextInput.value = enc.data.text;
    encCharUrlInput.value = enc.data.charUrl;
    encTriggerSelect.value = enc.data.trigger || 'none';
    encDataInput.value = enc.data.data || '';

    // Handle item selection
    const itemId = enc.data.itemId || '';
    encItemIdSelect.value = itemId;
    encItemIdManual.value = itemId;
    const isManual = !encItemIdSelect.querySelector(`option[value="${itemId}"]`);
    encItemIdManualCheck.checked = isManual;
    encItemIdManual.style.display = isManual ? 'block' : 'none';
    if (!isManual) encItemIdManual.value = '';

    renderChoices(enc.data.choices);
    showModal(editModal);
};

const renderChoices = (choices) => {
    choicesDiv.innerHTML = '';
    choices.forEach((choice, index) => {
        const choiceElement = createChoiceElement(choice, index);
        choicesDiv.appendChild(choiceElement);
    });
};

const createChoiceElement = (choice, index) => {
    const div = document.createElement('div');
    div.className = 'choice';
    div.dataset.index = index;
    div.innerHTML = `
        <input type="hidden" class="choiceId" value="${choice.id || generateUniqueId()}">
        <div class="choice-text-group">
            <label>ì„ íƒì§€ í…ìŠ¤íŠ¸</label>
            <input type="text" class="choiceText" value="${choice.text || ''}">
            <button class="delChoiceBtn" style="background: #e74c3c; border-color: #c0392b;">X</button>
        </div>
        <div class="choice-result-group">
            <label>ê²°ê³¼ ì§€ë¬¸</label>
            <textarea class="choiceResultText">${choice.resultText || ''}</textarea>
        </div>
        <div class="choice-hp-group">
            <label>HP ë³€í™”</label>
            <input type="number" class="choiceHpChange" value="${choice.hpChange || 0}">
        </div>
        <div class="choice-item-group">
            <label>ì•„ì´í…œ</label>
            <select class="choiceItemIdSelect" style="flex-grow: 1;"></select>
            <input type="number" class="choiceItemQuantity" value="1" min="1" style="width: 50px;">
        </div>
        <div class="choice-trigger-group">
            <label>íŠ¸ë¦¬ê±°</label>
            <select class="choiceTrigger" style="flex-shrink: 0;">
                <option value="none">ì—†ìŒ</option>
                <option value="sound">ì‚¬ìš´ë“œ</option>
                <option value="image">ì´ë¯¸ì§€ íŒì—…</option>
                <option value="map">ë§µ ì „í™˜</option>
            </select>
            <input type="text" class="choiceData" placeholder="URL/ë§µëª…" value="${choice.data || ''}">
        </div>
    `;

    // Populate item dropdown for choice
    const itemSelect = div.querySelector('.choiceItemIdSelect');
    itemSelect.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'ì•„ì´í…œ ì—†ìŒ';
    itemSelect.appendChild(defaultOption);
    
    for (const itemId in itemDefinitions) {
        const item = itemDefinitions[itemId];
        const option = document.createElement('option');
        option.value = itemId;
        option.textContent = `${item.name} (${itemId})`;
        itemSelect.appendChild(option);
    }
    
    // Set values from current choice data
    itemSelect.value = choice.itemId || '';
    div.querySelector('.choiceItemQuantity').value = choice.itemQuantity || 1;
    div.querySelector('.choiceTrigger').value = choice.trigger || 'none';

    div.querySelector('.delChoiceBtn').addEventListener('click', () => deleteChoice(index));
    
    return div;
};

const addChoice = () => {
    if (!currentEdit) return;
    const newChoice = { 
        id: generateUniqueId(), 
        text: 'ìƒˆë¡œìš´ ì„ íƒì§€', 
        resultText: 'ì„ íƒ ê²°ê³¼ ì§€ë¬¸', 
        trigger: 'none', 
        data: '', 
        hpChange: 0,
        itemId: '',
        itemQuantity: 1
    };
    currentEdit.data.choices.push(newChoice);
    renderChoices(currentEdit.data.choices);
};

const deleteChoice = (index) => {
    if (!currentEdit) return;
    currentEdit.data.choices.splice(index, 1);
    renderChoices(currentEdit.data.choices);
};

const saveEncEdit = () => {
    if (!currentEdit) return;
    
    currentEdit.data.name = encNameInput.value;
    currentEdit.data.text = encTextInput.value;
    currentEdit.data.charUrl = encCharUrlInput.value;
    currentEdit.data.trigger = encTriggerSelect.value;
    currentEdit.data.data = encDataInput.value;
    currentEdit.data.itemId = encItemIdManualCheck.checked ? encItemIdManual.value : encItemIdSelect.value;

    const newChoices = [];
    choicesDiv.querySelectorAll('.choice').forEach(choiceElement => {
        const choice = {
            id: choiceElement.querySelector('.choiceId').value, // **[ì¶”ê°€]** ID ì €ì¥
            text: choiceElement.querySelector('.choiceText').value,
            resultText: choiceElement.querySelector('.choiceResultText').value,
            hpChange: parseInt(choiceElement.querySelector('.choiceHpChange').value) || 0,
            itemId: choiceElement.querySelector('.choiceItemIdSelect').value,
            itemQuantity: parseInt(choiceElement.querySelector('.choiceItemQuantity').value) || 1,
            trigger: choiceElement.querySelector('.choiceTrigger').value,
            data: choiceElement.querySelector('.choiceData').value
        };
        newChoices.push(choice);
    });
    currentEdit.data.choices = newChoices;
    
    hideModal(editModal);
    // Note: Changes are in local state. Must save map data to persist.
    addLogItem(`ì‹œìŠ¤í…œ: ì¡°ìš° ì§€ì  (${currentEdit.x}, ${currentEdit.y}) ìˆ˜ì • ì™„ë£Œ. ë§µ ì €ì¥ì„ ëˆŒëŸ¬ Firestoreì— ë°˜ì˜í•˜ì„¸ìš”.`, 'system');
    draw();
};

const deleteEncEdit = () => {
    if (!currentEdit) return;
    if (confirm(`ì¡°ìš° ì§€ì  (${currentEdit.x}, ${currentEdit.y})ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        encounterPoints = encounterPoints.filter(e => e !== currentEdit);
        document.getElementById('adminInfoRemainingEnc').textContent = encounterPoints.length;
        hideModal(editModal);
        // Note: Must save map data to persist deletion.
        addLogItem(`ì‹œìŠ¤í…œ: ì¡°ìš° ì§€ì  (${currentEdit.x}, ${currentEdit.y}) ì‚­ì œ ì™„ë£Œ. ë§µ ì €ì¥ì„ ëˆŒëŸ¬ Firestoreì— ë°˜ì˜í•˜ì„¸ìš”.`, 'system');
        draw();
    }
};


/* --- Encounter Player Logic (Uses Modal) --- */

const showEncounterModal = (enc, x, y) => {
    if (isEncountering) return;
    isEncountering = true;
    
    const encId = `${currentMapName}_${x}_${y}`;
    const usedChoices = player.encountered[encId]?.usedChoices || []; // **[ìˆ˜ì •]** ì‚¬ìš©ëœ ì„ íƒì§€ ëª©ë¡ ë¡œë“œ

    // Reset UI
    encModalName.textContent = enc.data.name;
    encModalText.textContent = enc.data.text;
    encounterChoicesDiv.innerHTML = '';
    
    const charImg = document.getElementById('encCharImg');
    if (enc.data.charUrl) {
        charImg.src = enc.data.charUrl;
        charImg.style.display = 'block';
    } else {
        charImg.style.display = 'none';
    }

    // Process choices
    if (enc.data.choices && enc.data.choices.length > 0) {
        closeEncounterModalBtn.style.display = 'none';
        
        // Render choice buttons
        enc.data.choices.forEach((choice, index) => {
            const choiceId = choice.id || `choice_${index}`; 
            const button = document.createElement('button');
            button.textContent = choice.text;
            button.dataset.choiceId = choiceId;
            button.onclick = () => handleChoice(enc, choice, x, y);

            // **[ìˆ˜ì •]** ì´ë¯¸ ì‚¬ìš©ëœ ì„ íƒì§€ëŠ” ë¹„í™œì„±í™”
            if (usedChoices.includes(choiceId)) {
                button.disabled = true;
                button.textContent += ' (ì„ íƒ ì™„ë£Œ)'; 
            }

            encounterChoicesDiv.appendChild(button);
        });

    } else {
        // No choices: show 'Continue' button and handle default trigger
        closeEncounterModalBtn.style.display = 'block';
        closeEncounterModalBtn.onclick = () => handleDefaultTrigger(enc, x, y);
    }
    
    // Handle encounter item reward
    if (enc.data.itemId && !usedChoices.includes('reward')) { // Only grant if not previously rewarded (using 'reward' as a special choice ID)
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **${itemDefinitions[enc.data.itemId]?.name || enc.data.itemId}** 1ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'item');
        addItemToPlayer(loggedInUserId, enc.data.itemId, 1);
        
        // Mark reward as taken
        const encId = `${currentMapName}_${x}_${y}`;
        if (!player.encountered[encId]) {
            player.encountered[encId] = { usedChoices: [] };
        }
        player.encountered[encId].usedChoices.push('reward');
        savePlayerState(); // Save after item acquisition
    }

    showModal(encounterModalBg);
};

const handleChoice = async (enc, choice, x, y) => {
    const choiceId = choice.id; 
    const encId = `${currentMapName}_${x}_${y}`;
    
    // **[ìˆ˜ì •]** ì„ íƒì§€ ì‚¬ìš© ê¸°ë¡ ë° ì €ì¥
    if (!player.encountered[encId]) {
        player.encountered[encId] = { usedChoices: [] };
    }
    if (!player.encountered[encId].usedChoices.includes(choiceId)) {
        player.encountered[encId].usedChoices.push(choiceId);
    }
    await savePlayerState(); 
    
    // 1. ê²°ê³¼ ì§€ë¬¸ í‘œì‹œ
    addLogItem(`í”Œë ˆì´ì–´: ${choice.text}`, 'player', true);
    encModalText.textContent = choice.resultText;

    // 2. HP ë³€í™” ì ìš©
    if (choice.hpChange !== 0) {
        player.hp = Math.min(MAX_HP, Math.max(0, player.hp + choice.hpChange));
        playerHPDisplay.textContent = player.hp;
        addLogItem(`ì‹œìŠ¤í…œ: HPê°€ ${choice.hpChange > 0 ? '+' : ''}${choice.hpChange}ë§Œí¼ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${player.hp})`, 'system');
        await savePlayerState();
    }

    // 3. ì•„ì´í…œ íšë“ ì ìš©
    if (choice.itemId && choice.itemQuantity > 0) {
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **${itemDefinitions[choice.itemId]?.name || choice.itemId}** ${choice.itemQuantity}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'item');
        addItemToPlayer(loggedInUserId, choice.itemId, choice.itemQuantity);
    }
    
    // 4. íŠ¸ë¦¬ê±° ì‹¤í–‰
    if (choice.trigger && choice.trigger !== 'none') {
        await executeTrigger(choice.trigger, choice.data, x, y);
    }
    
    // 5. ì„ íƒì§€ ë²„íŠ¼ ìˆ¨ê¸°ê³  'ê³„ì† ì§„í–‰' ë²„íŠ¼ í‘œì‹œ
    encounterChoicesDiv.innerHTML = '';
    closeEncounterModalBtn.style.display = 'block';
    closeEncounterModalBtn.onclick = () => closeEncounterModal();

    // Re-render choices if needed, but in this case, we just show 'Continue'.
};

const handleDefaultTrigger = async (enc, x, y) => {
     if (enc.data.trigger && enc.data.trigger !== 'none') {
        // Apply default reward/effect only if it hasn't been applied (using 'reward' as a special choice ID)
        const encId = `${currentMapName}_${x}_${y}`;
        const usedChoices = player.encountered[encId]?.usedChoices || [];
        if (!usedChoices.includes('default_trigger_applied')) {
            await executeTrigger(enc.data.trigger, enc.data.data, x, y);
            
            // Mark default trigger as applied
            if (!player.encountered[encId]) {
                player.encountered[encId] = { usedChoices: [] };
            }
            player.encountered[encId].usedChoices.push('default_trigger_applied');
            await savePlayerState(); 
        } else {
             addLogItem(`ì‹œìŠ¤í…œ: ì´ë¯¸ ê²½í—˜í•œ ì¡°ìš°ì…ë‹ˆë‹¤.`, 'system');
        }
    }
    closeEncounterModal();
};

const executeTrigger = async (trigger, data, x, y) => {
    switch(trigger) {
        case 'sound':
            const sound = new Audio(data);
            sound.volume = bgmVolume.value;
            sound.play();
            addLogItem(`ì‹œìŠ¤í…œ: **[ì‚¬ìš´ë“œ íš¨ê³¼]** ì¬ìƒ (${data})`, 'system');
            break;
        case 'image':
            // Simple image popup (can be implemented with another modal)
            alert(`ì´ë¯¸ì§€ íŒì—…: ${data}`); 
            addLogItem(`ì‹œìŠ¤í…œ: **[ì´ë¯¸ì§€ íŒì—…]** í‘œì‹œ (${data})`, 'system');
            break;
        case 'map':
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${data}**ë¡œ ì´ë™í•©ë‹ˆë‹¤.`, 'system');
            await loadMapDataFromFirestore(data);
            // Reset player position to new map's start point
            player.x = mapData.startX || 0;
            player.y = mapData.startY || 0;
            await savePlayerState(); 
            break;
    }
};

const closeEncounterModal = () => {
    hideModal(encounterModalBg);
    isEncountering = false;
    // Check for transition point immediately after encounter
    checkForTransitionPoint();
    draw();
};

const checkEncounter = (x, y) => {
    const enc = getEncounterAt(x, y);
    if (enc && loggedInUserId && playerMode && !isEncountering) {
        // **[ìˆ˜ì •]** ë°©ë¬¸ ê¸°ë¡ì€ Encounter Modalì—ì„œë§Œ ì²˜ë¦¬
        // if (!player.encountered[`${currentMapName}_${x}_${y}`]?.visited) {
        //     player.encountered[`${currentMapName}_${x}_${y}`] = { visited: true, usedChoices: [] };
        //     savePlayerState();
        // }
        showEncounterModal(enc, x, y);
        return true;
    }
    return false;
};

/* --- Movement & Game Loop --- */

const movePlayer = async (dx, dy) => {
    if (!loggedInUserId || !playerMode || isMoving || isEncountering) return;
    
    isMoving = true;
    const newX = player.x + dx;
    const newY = player.y + dy;

    // Boundary check
    const maxX = canvas.width / GRID - 1;
    const maxY = canvas.height / GRID - 1;
    if (newX < 0 || newX > maxX || newY < 0 || newY > maxY) {
        isMoving = false;
        return;
    }

    // Impassable check
    if (getImpassableAt(newX, newY)) {
        addLogItem(`ì‹œìŠ¤í…œ: (${newX}, ${newY})ëŠ” ì§€ë‚˜ê°ˆ ìˆ˜ ì—†ëŠ” êµ¬ì—­ì…ë‹ˆë‹¤.`, 'system');
        isMoving = false;
        return;
    }

    // Update position
    player.x = newX;
    player.y = newY;
    
    await savePlayerState();
    draw();

    // Check for encounter
    const encounterTriggered = checkEncounter(newX, newY);
    
    if (!encounterTriggered) {
        // If no encounter, check for map transition immediately after moving
        checkForTransitionPoint();
    }
    
    isMoving = false;
};

const checkForTransitionPoint = async () => {
    if (player.x === mapData.transitionX && player.y === mapData.transitionY && mapData.nextMapName) {
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ **${mapData.nextMapName}**ë¡œ ì´ë™í•©ë‹ˆë‹¤.`, 'system');
        await loadMapDataFromFirestore(mapData.nextMapName);
        player.x = mapData.startX || 0;
        player.y = mapData.startY || 0;
        await savePlayerState();
    }
};

/* --- Firebase Interaction: Chat/Log --- */

const sendChatMessage = async (text) => {
    if (!loggedInUserId || !text.trim()) return;

    try {
        const isPlayerAdmin = loggedInUserId === ADMIN_EMAIL;
        await addDoc(collection(db, 'chat'), {
            text: text,
            nickname: document.getElementById('chatNickname').value || loggedInUserId,
            userId: loggedInUserId,
            isAdmin: isPlayerAdmin,
            timestamp: serverTimestamp()
        });
        document.getElementById('chatInput').value = '';
    } catch (e) {
        console.error("Error sending chat: ", e);
    }
};

const startChatListener = () => {
    if (chatUnsub) chatUnsub(); // Unsubscribe from previous listener

    const q = query(collection(db, 'chat'), orderBy('timestamp', 'desc'), limit(50));

    chatUnsub = onSnapshot(q, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
                const data = change.doc.data();
                const type = data.isAdmin ? 'admin' : 'player';
                const displayText = `<strong>${data.nickname}:</strong> ${data.text}`;
                addLogItem(displayText, type, true);
            }
        });
    }, (error) => {
        console.error("Chat listener error: ", error);
    });
};

/* --- Firebase Interaction: Item Definitions (Admin) --- */

const saveItemDefinition = async (itemId, data) => {
    try {
        const itemRef = doc(db, 'items', itemId);
        await setDoc(itemRef, data);
        itemDefinitions[itemId] = data;
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **${data.name}** ë“±ë¡/ìˆ˜ì • ì™„ë£Œ.`, 'system');
        renderItemList(); // **[ìˆ˜ì •]** ì•„ì´í…œ ëª©ë¡ ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        updateItemDropdowns(); // **[ìˆ˜ì •]** ì•„ì´í…œ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
    } catch (e) {
        console.error("Error saving item definition: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ë“±ë¡/ìˆ˜ì • ì‹¤íŒ¨.`, 'system');
    }
};

const deleteItemDefinition = async (itemId) => {
    if (confirm(`ì•„ì´í…œ **${itemDefinitions[itemId].name}**ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (í”Œë ˆì´ì–´ ì¸ë²¤í† ë¦¬ì—ì„œëŠ” ì œê±°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)`)) {
        try {
            await deleteDoc(doc(db, 'items', itemId));
            delete itemDefinitions[itemId];
            addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **${itemId}** ì‚­ì œ ì™„ë£Œ.`, 'system');
            renderItemList(); // **[ìˆ˜ì •]** ì•„ì´í…œ ëª©ë¡ ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
            updateItemDropdowns(); // **[ìˆ˜ì •]** ì•„ì´í…œ ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        } catch (e) {
            console.error("Error deleting item definition: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ì‚­ì œ ì‹¤íŒ¨.`, 'system');
        }
    }
};

const fetchAllItems = async (shouldRender = false) => {
    try {
        const q = query(collection(db, 'items'), orderBy('name'));
        const snapshot = await getDocs(q);
        itemDefinitions = {}; // Reset before populating
        snapshot.forEach(doc => {
            itemDefinitions[doc.id] = doc.data();
        });
        
        if (shouldRender) {
            renderItemList(); // **[ìˆ˜ì •]** ì•„ì´í…œ ëª©ë¡ ë Œë”ë§ ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ 
        }
    } catch (e) {
        console.error("Error fetching all items: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨.`, 'system');
    }
};

// **[ìˆ˜ì •]** ì•„ì´í…œ ëª©ë¡ì„ ë Œë”ë§í•˜ê³  ë“œë¡­ë‹¤ìš´ì„ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
const renderItemList = () => {
    itemListDiv.innerHTML = ''; 

    if (Object.keys(itemDefinitions).length === 0) {
         itemListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ë“±ë¡ëœ ì•„ì´í…œ ì •ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
         return;
    }
    
    for (const itemId in itemDefinitions) {
        const item = itemDefinitions[itemId];
        const itemElement = document.createElement('div');
        itemElement.className = 'list-item';
        itemElement.innerHTML = `
            <span>${item.name} (${itemId})</span>
            <div>
                <button onclick="showEditItemModal('${itemId}')">ìˆ˜ì •</button>
                <button class="del" onclick="deleteItemDefinition('${itemId}')">ì‚­ì œ</button>
            </div>
        `;
        itemListDiv.appendChild(itemElement);
    }
    updateItemDropdowns(); // **[ìˆ˜ì •]** ì•„ì´í…œ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ í›„ ë“œë¡­ë‹¤ìš´ ê°±ì‹  í•„ìˆ˜
};

// **[ìˆ˜ì •]** ì•„ì´í…œ ë“œë¡­ë‹¤ìš´ì„ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜ (ì•„ì´í…œ ê´€ë¦¬/ì‚¬ìš©ì ê´€ë¦¬/ì¡°ìš° ìˆ˜ì •ì— ì‚¬ìš©)
const updateItemDropdowns = () => {
    const encItemIdSelect = document.getElementById('encItemIdSelect');
    const giveItemSelect = document.getElementById('giveItemSelect');

    [encItemIdSelect, giveItemSelect].forEach(select => {
        // í˜„ì¬ ì„ íƒëœ ê°’ ì €ì¥
        const selectedValue = select.value;
        select.innerHTML = '';
        
        // Add default/placeholder option
        if (select.id === 'encItemIdSelect') {
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'íšë“ ì•„ì´í…œ ì—†ìŒ';
            select.appendChild(defaultOption);
        } else { // giveItemSelect
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'ì•„ì´í…œ ì„ íƒ';
            select.appendChild(defaultOption);
        }

        for (const itemId in itemDefinitions) {
            const item = itemDefinitions[itemId];
            const option = document.createElement('option');
            option.value = itemId;
            option.textContent = `${item.name} (${itemId})`;
            select.appendChild(option);
        }
        
        // ì´ì „ì— ì„ íƒëœ ê°’ ë³µì› (ìˆëŠ” ê²½ìš°)
        if (select.querySelector(`option[value="${selectedValue}"]`)) {
            select.value = selectedValue;
        } else {
             select.value = ''; // ì„ íƒí•  ìˆ˜ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        }
    });
};


/* --- Firebase Interaction: User Management (Admin) --- */

const fetchAllUsers = async (shouldUpdateUI = false) => {
    try {
        const q = query(collection(db, 'players'), orderBy('id'));
        const snapshot = await getDocs(q);
        usersData = {};

        // 1. Fetch all user data
        snapshot.forEach(doc => {
            const data = doc.data();
            usersData[doc.id] = {
                ...data,
                id: doc.id,
                hp: data.hp || MAX_HP,
                currentMap: data.currentMap || 'default',
                x: data.x || 0,
                y: data.y || 0,
                charUrl: data.charUrl || '',
                inventory: data.inventory || {},
                encountered: data.encountered || {} // **[ìˆ˜ì •]** encountered í•„ë“œ ë¡œë“œ
            };
        });

        // 2. Update UI if requested
        if (shouldUpdateUI) {
            renderUserList();
            updatePlayerSelectDropdowns();
            updatePlayerOnMapList();
        }
        
        return usersData;
    } catch (e) {
        console.error("Error fetching all users: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨.`, 'system');
        return {};
    }
};

const renderUserList = () => {
    const userListDiv = document.getElementById('userList');
    userListDiv.innerHTML = '';

    if (Object.keys(usersData).length === 0) {
         userListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ë“±ë¡ëœ í”Œë ˆì´ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
         return;
    }

    for (const userId in usersData) {
        const user = usersData[userId];
        const userElement = document.createElement('div');
        userElement.className = 'list-item';
        userElement.innerHTML = `
            <span style="flex: none; width: 100px;">${userId}</span>
            <span>HP: ${user.hp} | Map: ${user.currentMap}</span>
            <div>
                <button onclick="window.showUserInventory('${userId}')">ì•„ì´í…œ</button>
                <button class="del" onclick="deletePlayer('${userId}')">ì‚­ì œ</button>
            </div>
        `;
        userListDiv.appendChild(userElement);
    }
};

const updatePlayerSelectDropdowns = () => {
    const selects = [
        document.getElementById('selectPlayerId'),
        document.getElementById('selectPlayerIdMap'),
        document.getElementById('giveItemPlayerSelect')
    ];

    selects.forEach(select => {
        const selectedValue = select.value;
        select.innerHTML = '';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'í”Œë ˆì´ì–´ ì„ íƒ';
        select.appendChild(defaultOption);

        for (const userId in usersData) {
            const option = document.createElement('option');
            option.value = userId;
            option.textContent = userId;
            select.appendChild(option);
        }
        
        // Restore previous selection
        if (select.querySelector(`option[value="${selectedValue}"]`)) {
            select.value = selectedValue;
        } else {
             select.value = '';
        }

        // Attach change listener for populating HP/Map fields
        if (select.id === 'selectPlayerId') {
            select.onchange = (e) => {
                const userId = e.target.value;
                if (userId && usersData[userId]) {
                    document.getElementById('playerHpInput').value = usersData[userId].hp;
                } else {
                    document.getElementById('playerHpInput').value = '';
                }
            };
        } else if (select.id === 'selectPlayerIdMap') {
            select.onchange = (e) => {
                const userId = e.target.value;
                if (userId && usersData[userId]) {
                    document.getElementById('playerMapInput').value = usersData[userId].currentMap;
                    document.getElementById('playerXInput').value = usersData[userId].x;
                    document.getElementById('playerYInput').value = usersData[userId].y;
                } else {
                    document.getElementById('playerMapInput').value = '';
                    document.getElementById('playerXInput').value = '';
                    document.getElementById('playerYInput').value = '';
                }
            };
        }
    });
};

const updatePlayerOnMapList = () => {
    const playerOnMapListDiv = document.getElementById('playerOnMapList');
    playerOnMapListDiv.innerHTML = '';

    const playersOnCurrentMap = Object.values(usersData).filter(u => u.currentMap === currentMapName);

    if (playersOnCurrentMap.length === 0) {
        playerOnMapListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">í˜„ì¬ ë§µ í”Œë ˆì´ì–´ ì—†ìŒ</div>';
        return;
    }

    playersOnCurrentMap.forEach(user => {
        const item = document.createElement('div');
        item.className = 'player-on-map-item';
        item.innerHTML = `
            <strong>${user.id}</strong> (HP: ${user.hp})
            <small>Pos: (${user.x}, ${user.y})</small>
        `;
        playerOnMapListDiv.appendChild(item);
    });
};

/* --- Firebase Interaction: Inventory Management (Player) --- */

const addItemToPlayer = async (playerId, itemId, quantity = 1) => {
    if (!itemId) return;
    try {
        const playerRef = doc(db, 'players', playerId);
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerRef);
            if (!playerDoc.exists()) throw "Player does not exist!";
            
            const newInventory = playerDoc.data().inventory || {};
            newInventory[itemId] = (newInventory[itemId] || 0) + quantity;
            
            transaction.update(playerRef, { inventory: newInventory });

            // Update local state if the current player is affected
            if (playerId === loggedInUserId) {
                player.inventory = newInventory;
                renderPlayerInventory();
            }
        });
        fetchAllUsers(true); // Update Admin view
    } catch (e) {
        console.error("Error adding item to player: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: [${playerId}]ì—ê²Œ ì•„ì´í…œ ì¶”ê°€ ì‹¤íŒ¨.`, 'system');
    }
};

const removeItemFromPlayer = async (playerId, itemId, quantity = 1) => {
    if (!itemId) return;
    try {
        const playerRef = doc(db, 'players', playerId);
        await runTransaction(db, async (transaction) => {
            const playerDoc = await transaction.get(playerRef);
            if (!playerDoc.exists()) throw "Player does not exist!";
            
            const newInventory = playerDoc.data().inventory || {};
            const currentQuantity = newInventory[itemId] || 0;
            
            if (currentQuantity <= quantity) {
                delete newInventory[itemId];
            } else {
                newInventory[itemId] = currentQuantity - quantity;
            }
            
            transaction.update(playerRef, { inventory: newInventory });

            // Update local state if the current player is affected
            if (playerId === loggedInUserId) {
                player.inventory = newInventory;
                renderPlayerInventory();
            }
        });
        fetchAllUsers(true); // Update Admin view
    } catch (e) {
        console.error("Error removing item from player: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: [${playerId}]ì˜ ì•„ì´í…œ ì œê±° ì‹¤íŒ¨.`, 'system');
    }
};

const renderPlayerInventory = () => {
    const inventoryListDiv = document.getElementById('inventoryList');
    inventoryListDiv.innerHTML = '';

    const items = Object.keys(player.inventory).filter(id => player.inventory[id] > 0);

    if (items.length === 0) {
        inventoryListDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
        return;
    }

    items.forEach(itemId => {
        const quantity = player.inventory[itemId];
        const itemDef = itemDefinitions[itemId] || { name: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ', imageUrl: '', description: 'ì•„ì´í…œ ì •ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.' };
        
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-item';
        itemElement.dataset.itemId = itemId;
        itemElement.innerHTML = `
            <img src="${itemDef.imageUrl}" alt="${itemDef.name}" class="item-image" onerror="this.onerror=null;this.src='https://via.placeholder.com/40?text=?'" />
            <div>
                <span class="item-name">${itemDef.name} x${quantity}</span>
                <span class="item-desc">${itemDef.description}</span>
            </div>
        `;
        itemElement.addEventListener('click', () => showItemUseModal(itemId));
        inventoryListDiv.appendChild(itemElement);
    });
};

const showItemUseModal = (itemId) => {
    const itemDef = itemDefinitions[itemId];
    if (!itemDef) return;

    currentSelectedItem = itemId;

    document.getElementById('itemUseName').textContent = itemDef.name;
    document.getElementById('itemUseImage').src = itemDef.imageUrl;
    document.getElementById('itemUseImage').alt = itemDef.name;
    document.getElementById('itemUseDescription').textContent = itemDef.description;
    
    const useBtn = document.getElementById('useItemBtn');
    if (itemDef.hpRecover > 0) {
        useBtn.style.display = 'block';
        useBtn.textContent = `ì‚¬ìš© (HP ${itemDef.hpRecover > 0 ? '+' : ''}${itemDef.hpRecover})`;
    } else {
        useBtn.style.display = 'none';
    }

    showModal(itemUseModalBg);
};

const useItem = async () => {
    const itemId = currentSelectedItem;
    const itemDef = itemDefinitions[itemId];

    if (!itemDef || player.inventory[itemId] <= 0 || itemDef.hpRecover <= 0) return;

    // 1. Remove item from inventory
    await removeItemFromPlayer(loggedInUserId, itemId, 1);
    addLogItem(`ì‹œìŠ¤í…œ: ì•„ì´í…œ **${itemDef.name}**ì„ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.`, 'item');

    // 2. Apply effect
    player.hp = Math.min(MAX_HP, player.hp + itemDef.hpRecover);
    playerHPDisplay.textContent = player.hp;
    addLogItem(`ì‹œìŠ¤í…œ: HPê°€ +${itemDef.hpRecover}ë§Œí¼ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤. (í˜„ì¬ HP: ${player.hp})`, 'system');
    await savePlayerState();

    // 3. Close modal and re-render inventory
    hideModal(itemUseModalBg);
    renderPlayerInventory();
};

window.showUserInventory = (playerId) => {
    const user = usersData[playerId];
    if (!user) return;
    
    document.getElementById('inventoryModalTitle').textContent = `${playerId}ì˜ ì¸ë²¤í† ë¦¬`;
    const listDiv = document.getElementById('inventoryModalList');
    listDiv.innerHTML = '';
    
    const items = Object.keys(user.inventory).filter(id => user.inventory[id] > 0);
    
    if (items.length === 0) {
        listDiv.innerHTML = '<div style="text-align: center; color: #aaa; font-size: 13px;">ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</div>';
        showModal(document.getElementById('inventoryModal'));
        return;
    }

    items.forEach(itemId => {
        const quantity = user.inventory[itemId];
        const itemDef = itemDefinitions[itemId] || { name: 'ì•Œ ìˆ˜ ì—†ëŠ” ì•„ì´í…œ', description: '-' };
        
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-admin-item';
        itemElement.innerHTML = `
            <span>${itemDef.name} (${itemId}) x${quantity}</span>
            <div>
                <button onclick="window.removeAdminItem('${playerId}', '${itemId}')">ì œê±°(1)</button>
            </div>
        `;
        listDiv.appendChild(itemElement);
    });
    
    showModal(document.getElementById('inventoryModal'));
};

window.removeAdminItem = async (playerId, itemId) => {
    if (confirm(`${playerId}ì—ê²Œì„œ ì•„ì´í…œ [${itemDefinitions[itemId]?.name || itemId}] 1ê°œë¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        await removeItemFromPlayer(playerId, itemId, 1);
        // DB ì—…ë°ì´íŠ¸ í›„ ë‹¤ì‹œ ì¸ë²¤í† ë¦¬ íŒì—…ì„ ì—´ì–´ ê°±ì‹ 
        window.showUserInventory(playerId); 
        fetchAllUsers(true); 
    }
};

/* --- Event Listeners and Initializers --- */

const initEventListeners = () => {
    // Top Bar
    document.getElementById('playerLoginBtnTop').addEventListener('click', () => showModal(document.getElementById('playerLoginBox')));
    document.getElementById('adminBtn').addEventListener('click', () => showModal(document.getElementById('loginBox')));
    document.getElementById('loginBtn').addEventListener('click', adminLogin);
    document.getElementById('playerLoginBtnSubmit').addEventListener('click', playerLogin);
    document.getElementById('bgmToggleBtn').addEventListener('click', toggleBGM);
    document.getElementById('bgmVolume').addEventListener('input', (e) => bgmAudio.volume = parseFloat(e.target.value));
    
    // Chat
    document.getElementById('sendChatBtn').addEventListener('click', () => sendChatMessage(document.getElementById('chatInput').value));
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { sendChatMessage(document.getElementById('chatInput').value); }
    });
    
    // Admin Tabs
    document.getElementById('mapTabBtn').addEventListener('click', () => switchTab('map'));
    document.getElementById('userTabBtn').addEventListener('click', () => switchTab('user'));
    document.getElementById('itemTabBtn').addEventListener('click', () => switchTab('item'));
    
    // Map Tab
    document.getElementById('saveMap').addEventListener('click', saveMapData);
    document.getElementById('reload').addEventListener('click', () => loadMapDataFromFirestore(currentMapName));
    document.getElementById('toggleGrid').addEventListener('click', toggleGrid);
    document.getElementById('toggleEncounter').addEventListener('click', toggleEncounterMode);
    document.getElementById('toggleImpassable').addEventListener('click', toggleImpassableMode);
    document.getElementById('setPlayerPos').addEventListener('click', setStartPoint);
    document.getElementById('setTransitionPos').addEventListener('click', setTransitionPoint);
    // **[ìˆ˜ì •]** ë§µ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    initMapBtn.addEventListener('click', initCurrentMap); 

    // User Tab
    document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
    document.getElementById('updatePlayerStatusBtn').addEventListener('click', updatePlayerStatus);
    document.getElementById('updatePlayerMapBtn').addEventListener('click', updatePlayerMap);
    document.getElementById('giveItemBtn').addEventListener('click', giveItemToPlayer);

    // Item Tab
    document.getElementById('addItemBtn').addEventListener('click', addItemDefinition);
    
    // Encounter Edit Modal
    document.getElementById('addChoice').addEventListener('click', addChoice);
    document.getElementById('saveEncEdit').addEventListener('click', saveEncEdit);
    document.getElementById('deleteEncEdit').addEventListener('click', deleteEncEdit);
    document.getElementById('closeEncEdit').addEventListener('click', () => hideModal(editModal));
    document.getElementById('encItemIdManualCheck').addEventListener('change', (e) => {
        document.getElementById('encItemIdManual').style.display = e.target.checked ? 'block' : 'none';
    });

    // Player Modals
    // **[ìˆ˜ì •]** closeEncounterModalBtnì˜ ì´ë²¤íŠ¸ëŠ” handleChoice/handleDefaultTriggerì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë¨.
    // document.getElementById('closeEncounterModal').addEventListener('click', closeEncounterModal);
    document.getElementById('closeItemUseModal').addEventListener('click', () => hideModal(itemUseModalBg));
    document.getElementById('useItemBtn').addEventListener('click', useItem);
    document.getElementById('closeInventoryModal').addEventListener('click', () => hideModal(document.getElementById('inventoryModal')));


    // Game Controls
    container.addEventListener('click', handleMapClick);
    
    // Drag/Drop Admin Panel
    makeAdminPanelDraggable();
    document.getElementById('minimizeBtn').addEventListener('click', toggleMinimize);

    // Movement
    document.addEventListener('keydown', handleMovement);
};

// ... (Functions like adminLogin, playerLogin, updateAdminUI, updatePlayerUI, switchTab, toggleBGM, toggleGrid, toggleEncounterMode, toggleImpassableMode, setStartPoint, setTransitionPoint, addPlayer, deletePlayer, updatePlayerStatus, updatePlayerMap, giveItemToPlayer, addItemDefinition, showEditItemModal, handleMapClick, handleMovement, makeAdminPanelDraggable, toggleMinimize are assumed to be defined as in the original code, but their implementation details are omitted here for brevity of listing functions not fully changed, except for the item related functions which have been enhanced) ...

// **[ì¶”ê°€]** ì•„ì´í…œ ì •ì˜ ê´€ë ¨ í•¨ìˆ˜ (Admin)
const addItemDefinition = async () => {
    const id = document.getElementById('newItemId').value.trim();
    const name = document.getElementById('newItemName').value.trim();
    const url = document.getElementById('newItemImageUrl').value.trim();
    const hpRecover = parseInt(document.getElementById('newItemHpRecover').value) || 0;
    const description = document.getElementById('newItemDescription').value.trim();

    if (!id || !name) {
        alert('ì•„ì´í…œ IDì™€ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const data = { name, imageUrl: url, hpRecover, description };
    await saveItemDefinition(id, data);

    // Clear inputs
    document.getElementById('newItemId').value = '';
    document.getElementById('newItemName').value = '';
    document.getElementById('newItemImageUrl').value = '';
    document.getElementById('newItemHpRecover').value = 0;
    document.getElementById('newItemDescription').value = '';
};

// **[ì¶”ê°€]** Item Edit Modal
const showEditItemModal = (itemId) => {
    // Implement item edit modal logic here if needed, or use the existing forms on the tab.
    alert(`ì•„ì´í…œ [${itemId}] ìˆ˜ì •ì€ ì•„ì´í…œ ê´€ë¦¬ íƒ­ì˜ ì…ë ¥ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. í˜„ì¬ëŠ” ë³„ë„ì˜ ëª¨ë‹¬ì´ ì—†ìŠµë‹ˆë‹¤.`);
};


// **[ì¶”ê°€]** Dummy implementations for assumed original functions (to ensure the provided code runs without reference errors, as the original full code was not visible)

const adminLogin = () => { 
    // Simplified logic for example
    if (document.getElementById('adminPw').value === ADMIN_DUMMY_PW) {
        auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_DUMMY_PW)
            .catch(e => {
                console.error("Firebase Auth Error:", e);
                alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ê±°ë‚˜ Firebase ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.");
            });
    } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
    hideModal(document.getElementById('loginBox'));
};

const playerLogin = async () => {
    const playerId = document.getElementById('playerIdInput').value.trim();
    if (!playerId) {
        alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // Check if player exists in the fetched usersData
    if (!usersData[playerId]) {
        alert('ë“±ë¡ë˜ì§€ ì•Šì€ í”Œë ˆì´ì–´ IDì…ë‹ˆë‹¤.');
        return;
    }

    loggedInUserId = playerId;
    playerMode = true;
    currentMapName = usersData[playerId].currentMap || 'default';
    await loadPlayerState(playerId);
    updatePlayerUI(true);
    addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${playerId}** ë¡œê·¸ì¸ ì„±ê³µ.`, 'system');
    hideModal(document.getElementById('playerLoginBox'));
    startChatListener();
    renderPlayerInventory();
};


const updateAdminUI = (isAdmin) => {
    adminMode = isAdmin;
    if (isAdmin) {
        adminPanel.style.display = 'block';
        document.getElementById('adminRightInfo').style.display = 'flex';
        document.getElementById('playerContent').style.display = 'none';
    } else {
        adminPanel.style.display = 'none';
        document.getElementById('adminRightInfo').style.display = 'none';
        // If player is logged in, show player content
        if (loggedInUserId) {
             document.getElementById('playerContent').style.display = 'flex';
        }
    }
};

const updatePlayerUI = (isPlayer) => {
    playerMode = isPlayer;
    if (isPlayer) {
        document.getElementById('logChatPanel').style.display = 'flex';
        document.getElementById('statusInventoryPanel').style.display = 'flex';
        document.getElementById('playerContent').style.display = 'flex';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendChatBtn').disabled = false;
        playerHPDisplay.textContent = player.hp;
        // Start game loop if not already running
        if (!animationFrameId) {
             animationFrameId = requestAnimationFrame(draw);
        }
    } else {
        document.getElementById('playerContent').style.display = 'none';
        if (!adminMode) {
             document.getElementById('logChatPanel').style.display = 'none';
             document.getElementById('statusInventoryPanel').style.display = 'none';
        }
        loggedInUserId = null;
        if (chatUnsub) chatUnsub();
    }
};

const switchTab = (tabId) => {
    document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.admin-tabs button').forEach(el => el.classList.remove('active'));
    document.getElementById(`${tabId}TabContent`).classList.add('active');
    document.getElementById(`${tabId}TabBtn`).classList.add('active');

    // Load data specific to the tab
    if (tabId === 'user') {
        fetchAllUsers(true);
    } else if (tabId === 'item') {
        fetchAllItems(true); // Ensures item list and dropdowns are updated
    }
};

const toggleBGM = () => {
    if (bgmAudio.paused) {
        bgmAudio.play().catch(e => console.log("BGM Play failed:", e));
        document.getElementById('bgmToggleBtn').textContent = 'PAUSE';
    } else {
        bgmAudio.pause();
        document.getElementById('bgmToggleBtn').textContent = 'PLAY';
    }
};

const toggleGrid = () => {
    isGridMode = !isGridMode;
    document.getElementById('toggleGrid').classList.toggle('active', isGridMode);
    draw();
};

const toggleEncounterMode = () => {
    isEncounterMode = !isEncounterMode;
    isImpassableMode = false;
    document.getElementById('toggleEncounter').classList.toggle('active', isEncounterMode);
    document.getElementById('toggleImpassable').classList.remove('active');
};

const toggleImpassableMode = () => {
    isImpassableMode = !isImpassableMode;
    isEncounterMode = false;
    document.getElementById('toggleImpassable').classList.toggle('active', isImpassableMode);
    document.getElementById('toggleEncounter').classList.remove('active');
};

const setStartPoint = () => {
    mapData.startX = parseInt(startXInput.value) || 0;
    mapData.startY = parseInt(startYInput.value) || 0;
    draw();
    addLogItem(`ì‹œìŠ¤í…œ: ì‹œì‘ ì¢Œí‘œë¥¼ (${mapData.startX}, ${mapData.startY})ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`, 'system');
};

const setTransitionPoint = () => {
    mapData.transitionX = transitionXInput.value ? parseInt(transitionXInput.value) : null;
    mapData.transitionY = transitionYInput.value ? parseInt(transitionYInput.value) : null;
    draw();
    if (mapData.transitionX !== null) {
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ë™ ì¢Œí‘œë¥¼ (${mapData.transitionX}, ${mapData.transitionY})ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.`, 'system');
    } else {
        addLogItem(`ì‹œìŠ¤í…œ: ë§µ ì´ë™ ì¢Œí‘œë¥¼ í•´ì œí–ˆìŠµë‹ˆë‹¤.`, 'system');
    }
};

const handleMapClick = (e) => {
    if (!adminMode) return;
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / GRID);
    const y = Math.floor((e.clientY - rect.top) / GRID);

    const existingEnc = getEncounterAt(x, y);
    const existingImp = getImpassableAt(x, y);

    if (isEncounterMode) {
        if (existingImp) {
            alert('ì´ê³³ì€ ì´ë™ ì œí•œ êµ¬ì—­ì…ë‹ˆë‹¤. ì œí•œ êµ¬ì—­ì„ ë¨¼ì € ì‚­ì œí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (existingEnc) {
            openEditModal(existingEnc);
        } else {
            addEncounter(x, y);
        }
    } else if (isImpassableMode) {
        if (existingEnc) {
            alert('ì´ê³³ì€ ì¡°ìš° ì§€ì ì…ë‹ˆë‹¤. ì¡°ìš° ì§€ì ì„ ë¨¼ì € ì‚­ì œí•´ì£¼ì„¸ìš”.');
            return;
        }
        if (existingImp) {
            impassablePoints = impassablePoints.filter(p => p !== existingImp);
            addLogItem(`ì‹œìŠ¤í…œ: ì œí•œ êµ¬ì—­ (${x}, ${y})ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ë§µ ì €ì¥ì„ ëˆŒëŸ¬ Firestoreì— ë°˜ì˜í•˜ì„¸ìš”.`, 'system');
        } else {
            impassablePoints.push({ x, y });
            addLogItem(`ì‹œìŠ¤í…œ: ì œí•œ êµ¬ì—­ (${x}, ${y})ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ë§µ ì €ì¥ì„ ëˆŒëŸ¬ Firestoreì— ë°˜ì˜í•˜ì„¸ìš”.`, 'system');
        }
        draw();
    } else if (adminMode) {
        // Edit mode (Click on existing points to open editor)
        if (existingEnc) {
            openEditModal(existingEnc);
        } else if (existingImp) {
            alert(`ì œí•œ êµ¬ì—­ (${x}, ${y}) - ì‚­ì œí•˜ë ¤ë©´ 'ì œí•œ ì¶”ê°€' ëª¨ë“œì—ì„œ í´ë¦­í•˜ì„¸ìš”.`);
        } else {
            addLogItem(`ì‹œìŠ¤í…œ: ë¹ˆ êµ¬ì—­ (${x}, ${y}).`, 'system');
        }
    }
};

const handleMovement = (e) => {
    if (!loggedInUserId || isEncountering) return;

    let dx = 0;
    let dy = 0;
    switch (e.key) {
        case 'ArrowUp':
        case 'w':
            dy = -1;
            break;
        case 'ArrowDown':
        case 's':
            dy = 1;
            break;
        case 'ArrowLeft':
        case 'a':
            dx = -1;
            break;
        case 'ArrowRight':
        case 'd':
            dx = 1;
            break;
        default:
            return;
    }
    e.preventDefault();
    movePlayer(dx, dy);
};

const makeAdminPanelDraggable = () => {
    let isDragging = false;
    let offsetX, offsetY;
    const header = adminPanel.querySelector('h4');

    header.addEventListener('mousedown', (e) => {
        if (adminPanel.classList.contains('minimized')) return;
        isDragging = true;
        offsetX = e.clientX - adminPanel.getBoundingClientRect().left;
        offsetY = e.clientY - adminPanel.getBoundingClientRect().top;
        adminPanel.style.cursor = 'grabbing';
        adminPanel.style.transition = 'none';
        e.preventDefault(); 
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        adminPanel.style.left = (e.clientX - offsetX) + 'px';
        adminPanel.style.top = (e.clientY - offsetY) + 'px';
        adminPanel.style.right = 'auto'; // Disable right lock
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
        adminPanel.style.cursor = 'grab';
        adminPanel.style.transition = 'width 0.3s, height 0.3s, padding 0.3s, overflow 0.3s';
    });
};

const toggleMinimize = () => {
    adminPanel.classList.toggle('minimized');
};

const addPlayer = async () => {
    const id = document.getElementById('newUserId').value.trim();
    const charUrl = document.getElementById('newUserCharUrl').value.trim();

    if (!id) {
        alert('í”Œë ˆì´ì–´ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (usersData[id]) {
        alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.');
        return;
    }

    try {
        const playerRef = doc(db, 'players', id);
        const newPlayer = {
            id: id,
            hp: MAX_HP,
            currentMap: 'default',
            x: 0,
            y: 0,
            charUrl: charUrl,
            inventory: {},
            encountered: {}
        };
        await setDoc(playerRef, newPlayer);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${id}** ìƒì„± ì™„ë£Œ.`, 'system');
        document.getElementById('newUserId').value = '';
        document.getElementById('newUserCharUrl').value = '';
        await fetchAllUsers(true);
    } catch (e) {
        console.error("Error adding player: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ìƒì„± ì‹¤íŒ¨.`, 'system');
    }
};

const deletePlayer = async (playerId) => {
    if (confirm(`í”Œë ˆì´ì–´ **${playerId}**ì˜ ê³„ì •ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        try {
            await deleteDoc(doc(db, 'players', playerId));
            addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${playerId}** ì‚­ì œ ì™„ë£Œ.`, 'system');
            await fetchAllUsers(true);
            // If the deleted player was logged in, log them out
            if (loggedInUserId === playerId) {
                 await auth.signOut();
                 updatePlayerUI(false);
            }
        } catch (e) {
            console.error("Error deleting player: ", e);
            addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ì‚­ì œ ì‹¤íŒ¨.`, 'system');
        }
    }
};

const updatePlayerStatus = async () => {
    const playerId = document.getElementById('selectPlayerId').value;
    const hp = parseInt(document.getElementById('playerHpInput').value);

    if (!playerId || isNaN(hp)) {
        alert('í”Œë ˆì´ì–´ì™€ HPë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„ íƒ/ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const playerRef = doc(db, 'players', playerId);
        await updateDoc(playerRef, { hp: Math.min(MAX_HP, Math.max(0, hp)) });
        
        // Update local state
        if (usersData[playerId]) usersData[playerId].hp = hp;
        if (loggedInUserId === playerId) {
            player.hp = hp;
            playerHPDisplay.textContent = hp;
        }

        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${playerId}** ìƒíƒœ(HP: ${hp}) ì—…ë°ì´íŠ¸ ì™„ë£Œ.`, 'system');
        await fetchAllUsers(true);
    } catch (e) {
        console.error("Error updating player status: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨.`, 'system');
    }
};

const updatePlayerMap = async () => {
    const playerId = document.getElementById('selectPlayerIdMap').value;
    const map = document.getElementById('playerMapInput').value.trim();
    const x = parseInt(document.getElementById('playerXInput').value);
    const y = parseInt(document.getElementById('playerYInput').value);

    if (!playerId || !map || isNaN(x) || isNaN(y)) {
        alert('í”Œë ˆì´ì–´, ë§µ ì´ë¦„, ì¢Œí‘œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„ íƒ/ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const playerRef = doc(db, 'players', playerId);
        await updateDoc(playerRef, { currentMap: map, x, y });

        // Update local state
        if (usersData[playerId]) {
            usersData[playerId].currentMap = map;
            usersData[playerId].x = x;
            usersData[playerId].y = y;
        }
        if (loggedInUserId === playerId) {
            await loadMapDataFromFirestore(map);
            player.x = x;
            player.y = y;
        }

        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${playerId}** ìœ„ì¹˜(${map}, ${x}, ${y}) ì—…ë°ì´íŠ¸ ì™„ë£Œ.`, 'system');
        await fetchAllUsers(true);
    } catch (e) {
        console.error("Error updating player map: ", e);
        addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨.`, 'system');
    }
};

const giveItemToPlayer = async () => {
    const playerId = document.getElementById('giveItemPlayerSelect').value;
    const itemId = document.getElementById('giveItemSelect').value;
    
    if (!playerId || !itemId) {
        alert('í”Œë ˆì´ì–´ì™€ ì•„ì´í…œì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    await addItemToPlayer(playerId, itemId, 1);
    addLogItem(`ì‹œìŠ¤í…œ: í”Œë ˆì´ì–´ **${playerId}**ì—ê²Œ ì•„ì´í…œ **${itemDefinitions[itemId]?.name || itemId}** 1ê°œ ì§€ê¸‰ ì™„ë£Œ.`, 'system');
};

// Expose functions to the global scope for onclick handlers in dynamically generated HTML
window.deleteMap = deleteMap;
window.showUserInventory = showUserInventory;
window.removeAdminItem = removeAdminItem;


// Initialization Sequence
initEventListeners(); 

onAuthStateChanged(auth, (user) => {
    if (user && user.email === ADMIN_EMAIL) {
        updateAdminUI(true);
        addLogItem(`ì‹œìŠ¤í…œ: ê´€ë¦¬ì (${user.email}) ë¡œê·¸ì¸ ì„±ê³µ.`, 'system');
    } else {
        if (!loggedInUserId) {
            updateAdminUI(false);
            updatePlayerUI(false);
        } else {
            updateAdminUI(false); 
        }
    }
});

const initialMap = localStorage.getItem('currentMap') || 'default';

Promise.all([
    fetchAllUsers(false),
    fetchAllItems(true), // **[ìˆ˜ì •]** ì•„ì´í…œ ë¡œë“œ í›„ renderItemList (ëª©ë¡ ë° ë“œë¡­ë‹¤ìš´ ê°±ì‹ )
    loadMapDataFromFirestore(initialMap).then(loaded => {
        if (!loaded) {
            mapNameInput.value = 'default';
            currentMapName = 'default';
            addLogItem(`ì‹œìŠ¤í…œ: ë§µ ë°ì´í„°ê°€ ì—†ì–´ **[default]** ë§µìœ¼ë¡œ ì´ˆê¸°í™”.`, 'system');
        }
    }),
    reloadMapList()
]).then(() => {
    startXInput.value = player.x;
    startYInput.value = player.y; 
    draw();

    const savedPlayerId = localStorage.getItem('playerId');
    if (savedPlayerId && usersData[savedPlayerId]) {
         document.getElementById('playerIdInput').value = savedPlayerId;
         // Auto-login only if not in admin mode
         if (!adminMode) {
              playerLogin(); 
         }
    }
});
</script>
</body>
</html>
